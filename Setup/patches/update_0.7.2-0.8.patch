diff -Nur MOTP-AS_v0.7.2/HTML/about.php MOTP-AS_v0.8/HTML/about.php
--- MOTP-AS_v0.7.2/HTML/about.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/about.php	2012-04-15 18:49:47.000000000 +0200
@@ -24,6 +24,7 @@
 <div>MOTP-AS:</div>
 <ul>
 <li>Adrian - logos and HTML layout</li>
+<li>Jon - testing, texts and support</li>
 <li>Sebastian - hacking and pre-build images</li>
 <li>Steffen - maintaining and hosting web site</li>
 </ul>
@@ -33,11 +34,11 @@
 <div>Attributions:</div>
 <ul>
 <li>Menu was generated by <a href="http://purecssmenu.com/">Pure CSS Menu.com</a>.</li>
-<li>Selecting dates is powered by <a href="http://www.rainforestnet.com/datetimepicker.htm">JavaScript Date Time Picker</a>.</li>
+<li>Selecting dates is powered by <a href="http://www.rainforestnet.com/datetimepicker/datetimepicker.htm">JavaScript Date Time Picker</a>.</li>
 <li>Some Icons are Copyright &copy; <a href="http://p.yusukekamiyamane.com/">Yusuke Kamiyamane</a>. All rights reserved. Licensed under a <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 license</a>.</li>
 <li>Other Icons are from <a href="http://www.icojoy.com/">www.icojoy.com</a> | Zhebrakov Andrew (Andy-S).</li>
 <li>HTML client generates passcodes using <a href="http://pajhome.org.uk/crypt/md5">md5.js</a>.</li>
-<li></li>
+<li>Tables can be sorted using <a href="http://www.kryogenix.org/code/browser/sorttable/">SortTable</a> by  Stuart Langridge.</li>
 </ul>
 </div>
 
diff -Nur MOTP-AS_v0.7.2/HTML/account.php MOTP-AS_v0.8/HTML/account.php
--- MOTP-AS_v0.7.2/HTML/account.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/account.php	2012-04-15 18:49:47.000000000 +0200
@@ -36,9 +36,10 @@
 	if (isset($_POST['user']))   $account->userid   = input($_POST['user']);
 	if (isset($_POST['device'])) $account->deviceid = input($_POST['device']);
 	if (isset($_POST['pin']))    {
-		if ( ($_POST['pin'] != "") && ($_POST['pin'] != "****") ) 
+		if ( $_POST['pin'] != "****" ) 
 				     $account->pin      = input($_POST['pin']);
 	}
+	if (isset($_POST['ldap']))   $account->ldap = TRUE ; else $account->ldap = FALSE;
 
 	$user=get_user($account->userid);
 	$userrole=get_user_role($user->user);
@@ -79,19 +80,23 @@
 
 	echo table_header( FALSE, "edit");
 	echo table_row( array( "User:", $userselect ) );
-	$pin = show_data( SHOW_PIN, $account->pin, "", $account->user, $_SESSION['user'], get_user_role($account->user), $role);
+	$fill = ($action=="add") ? "" : "****";
+	$pin = show_data( SHOW_PIN, $account->pin, $fill, $account->user, $_SESSION['user'], get_user_role($account->user), $role);
 	echo table_row( array( "PIN:", 
 		input_text("pin", $pin, 4, 'id="account-pin"') ) );
 	echo table_row( array( "Device:", $deviceselect ) );
 
+	if (LDAP_ACCESS_SYNC)
+	echo table_row( array( "LDAP", input_checkbox("ldap", $account->ldap, $account->ldap) ) ) . br() ;
 	echo table_footer();
 
 	echo input_submit("Ok","send");
 	echo form_footer();
 
-	$help   = p("user = username (login name) for this account") 
+	$help   = p("User = username (login name) for this account") 
 		. p("PIN = PIN used by user. Existing PINs are only displayed if managing own accounts")
-		. p("device = device (secret) for this account")
+		. p("Device = device (secret) for this account")
+		. p("LDAP = synced via LDAP")
 		;
 	$hint = TRUE;
 
@@ -103,6 +108,8 @@
 	$pin = show_data( SHOW_PIN, $account->pin, "****", $account->user, $_SESSION['user'], get_user_role($account->user), $role);
 	echo table_row( array( "PIN:", $pin ));
 	echo table_row( array( "Device:", a("device.php?device=$account->deviceid" , ($account->device=="") ? "Device #".$account->deviceid : $account->device  )));
+	if (LDAP_ACCESS_SYNC)
+	echo table_row( array( "LDAP:", $account->ldap ? "yes" : "no" ) );
 
 	if ($action == "generate passcode") {
 		log_audit($_SESSION['user'],"generate OTP","Account #$account->id: User #$account->userid ($account->user), Device #$account->deviceid ($account->device)");
@@ -122,9 +129,10 @@
 	}
 
 
-        $help   = p("edit = change/set account properties (assigned user, assigned device, PIN)")
-		. p("delete = delete account from database")
-		. p("generate passcode = generate a one time passcode for this account")
+        $help   = p("Edit = change/set account properties (assigned user, assigned device, PIN)")
+		. p("Delete = delete account from database")
+		. p("Generate passcode = generate a one time passcode for this account")
+		
 		;
 
 }
diff -Nur MOTP-AS_v0.7.2/HTML/accounts.php MOTP-AS_v0.8/HTML/accounts.php
--- MOTP-AS_v0.7.2/HTML/accounts.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/accounts.php	2012-04-15 18:49:47.000000000 +0200
@@ -9,26 +9,34 @@
 
 if (isset($_POST['user']))   { $user_filter   = input($_POST['user']); }   else { $user_filter=""; }
 if (isset($_POST['device'])) { $device_filter = input($_POST['device']); } else { $device_filter=""; }
+if (isset($_GET['ldap']))    { $ldap_filter = input($_GET['ldap']);    } else { $ldap_filter=""; }
+if (isset($_POST['ldap']))   { $ldap_filter = input($_POST['ldap']);   }
 
 $bcs = array ( array("index.php","home"), array("accounts.php","Accounts") );
 
 echo form_header ("POST", "accounts.php" );
-echo table_header( array ("User", "Device"), "list" );
+echo table_header( array ("User", "Device", (LDAP_ACCESS_SYNC ? "LDAP" : NULL) ), "list sortable" );
 
 echo table_row ( array (
 	input_text( "user",   $user_filter,   10),
 	input_text( "device", $device_filter, 10),
+	(LDAP_ACCESS_SYNC) ? select_header("ldap")
+		. select_option('','')
+		. select_option(1,"yes","$ldap_filter"=="1")
+		. select_option(0,"no","$ldap_filter"=="0")
+		. select_footer() : NULL,
 	input_submit("Search","search")
 ) );
 
 
-$accounts = get_account_list ($user_filter, $device_filter);
+$accounts = get_account_list ($user_filter, $device_filter, $ldap_filter);
 
 foreach ( $accounts as $account ) {
 	echo table_row ( array (
 		a("account.php?account=$account->id", $account->user) ,
 		a("account.php?account=$account->id", 
-		   ($account->device == "") ? ("Device #".$account->deviceid) : "$account->device" )
+		   ($account->device == "") ? ("Device #".$account->deviceid) : "$account->device" ),
+		( LDAP_ACCESS_SYNC ? (($account->ldap) ? "yes" : "no") : NULL )
 	) );
 }
 
@@ -41,6 +49,7 @@
 echo input_submit("Add new Account","add");
 echo form_footer();
 
+echo '<script type="text/javascript" src="JS/sorttable.js"></script>';
 
 include 'INC/footer.php';
 
diff -Nur MOTP-AS_v0.7.2/HTML/auth.php MOTP-AS_v0.8/HTML/auth.php
--- MOTP-AS_v0.7.2/HTML/auth.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/auth.php	2012-04-15 18:49:47.000000000 +0200
@@ -4,24 +4,61 @@
 include 'checkMOTP.php';
 
 
-function checkPassword ($user, $password, $radius=FALSE) {
+function checkPassword ($username, $password, $radius=FALSE) {
 
-	if( str_replace(str_split(VALID_CHARS), '', $user) != "" ) { 
-		log_auth ($user, "failure", "invalid character in username" );
+	if (str_replace(str_split(VALID_CHARS), '', $username) !== "") { 
+		log_auth ($username, "failure", "invalid character in username" );
 		return FALSE;
 	}
 
-	if( $password == "" ) { 
-		log_auth ($user, "failure", "no password given" );
+	if ($password == "") { 
+		log_auth ($username, "failure", "no password given" );
 		return FALSE;
 	}
 
-	if (check_static($user,$password,$radius)) {
-		log_auth ($user, "success", "Static Password, Client: " . ( $radius ? "$radius (RADIUS)" : $_SERVER['REMOTE_ADDR']." (Web)") );
+	$userid = get_user_id($username);
+	if ($userid) $user=get_user($userid);
+
+	if ( LDAP_ACCESS_SYNC && ( (!$userid) || ($user->ldap) ) ) {
+		// user not in database or entry synced from LDAP
+		ldap_sync_user($username);
+		$userid = get_user_id($username);
+		if ($userid) $user=get_user($userid);
+	}
+
+	if (! $userid) {
+		log_auth ($username, "failure", "unknown user" );
+		return FALSE;
+	}
+
+	if (! $user->enabled) {
+		log_auth ($username, "failure", "user locked" );
+		return FALSE;	// never allow locked users
+	}
+
+	if ($radius) {
+		if ( LDAP_ACCESS_RAD && ! LDAP_ACCESS_SYNC )
+			ldap_search_user($username);	// no LDAP fetch until now
+		if (! checkRadiusAVs($username)) {
+			return FALSE;
+		}
+	}
+
+	$ok = check_static($username,$password,$radius);
+	if ($ok) {
+		log_auth ($username, "success", "$ok Password, Client: " . ( $radius ? "$radius (RADIUS)" : $_SERVER['REMOTE_ADDR']." (Web)") );
 		return TRUE;
 	}
 
-	return checkMOTP($user,$password,$radius);
+	if ( LDAP_ACCESS_PWD && LDAP_ACCESS_SYNC && ($radius == FALSE) ) {
+		// authenticate via LDAP
+		if (ldap_check_password($username,$password)) {
+			log_auth ($username, "success", "LDAP Password, Client: " . $_SERVER['REMOTE_ADDR'] . " (Web)");
+			return TRUE;
+		}
+	}
+
+	return checkMOTP($username,$password,$radius);
 }
 
 
diff -Nur MOTP-AS_v0.7.2/HTML/checkMOTP.php MOTP-AS_v0.8/HTML/checkMOTP.php
--- MOTP-AS_v0.7.2/HTML/checkMOTP.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/checkMOTP.php	2012-04-15 18:49:47.000000000 +0200
@@ -21,14 +21,14 @@
 		$otp = $time . $secret . $pin ;
 		$otp = substr( md5($otp) ,0,6);
 		debug("trying passcode $otp (time $time)");
-		if ( $otp == $passcode ) return $time;
+		if ( $otp === $passcode ) return $time;
 		if ($i == 0) continue;
 
 		$time = $now + $i;
 		$otp = $time . $secret . $pin ;
 		$otp = substr( md5($otp) ,0,6);
 		debug("trying passcode $otp (time $time)");
-		if ( $otp == $passcode ) return $time;
+		if ( $otp === $passcode ) return $time;
 
 	}
 	return -1;
@@ -44,7 +44,7 @@
 
 	$number = get_motp_data ($user, $userdata, $accountdatas, $devicedatas);
 	if (!$number) { /* no user account found */
-		log_auth ($user, "unknown user", "$client");
+		log_auth ($user, "failure", "no valid account");
 		return FALSE;
 	}
 
@@ -61,6 +61,12 @@
 	$locked = (bool) ($userdata->tries > MAXTRIES);			debug("locked=$locked");
 	$replay = (bool) ($passok) && (! ($time > $device->lasttime) );	debug("replay=$replay");
 
+	if ($passok && !$replay && $locked && (LOCK_GRACE_MINS > 0)) {
+		$grace_secs = LOCK_GRACE_MINS * 60;
+		if ($time > $userdata->llogin + $grace_secs) 
+			$locked = FALSE;
+	}
+
 	if ($passok && !$replay && !$locked ) {	// ok
 		$status = TRUE;
 		$userdata->tries=0;
@@ -78,9 +84,9 @@
 	update_motp_data ($userdata, $device);
 
 	if ($status)
-		log_auth ($user, "success", "Device: " . device_full($device) . ", $client");
+		log_auth ($user, "success", "One Time Password, Device: " . device_full($device) . ", $client");
 	else
-		log_auth ($user, "failure", "$client; passok: ". ($passok?"y":"n") .", locked: ". ($locked?"y":"n") .", replay: ". ($replay?"y":"n"));
+		log_auth ($user, "failure", "One Time Password, $client; passok: ". ($passok?"y":"n") .", locked: ". ($locked?"y":"n") .", replay: ". ($replay?"y":"n"));
 
 	return $status;
 }
diff -Nur MOTP-AS_v0.7.2/HTML/conf.php MOTP-AS_v0.8/HTML/conf.php
--- MOTP-AS_v0.7.2/HTML/conf.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.8/HTML/conf.php	2012-04-15 18:49:47.000000000 +0200
@@ -0,0 +1,134 @@
+<?php
+
+include 'INC/session.php'; checkrole("A","index.php");
+
+include 'INC/include.php';
+
+$title = "MOTP-AS - LDAP Configuration";
+include 'INC/header.php';
+
+if (isset($_GET['realm']))   $realm=input($_GET['realm']);    else $realm="S";
+$bcs = array ( array("index.php","home"), array("conf.php?realm=$realm",$CONF_REALMS[$realm]) );
+
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
+
+$conf = get_config(0,$realm,'');
+
+
+if ($action == "update") {
+	$update="";
+
+	if (isset($_POST['conf']))
+	   foreach (array_keys($_POST['conf']) as $par) {
+		$value = input($_POST['conf'][$par]);
+		// if ($value == "") continue;
+		if ($value != $conf[$par]) {
+			set_config(0,$par,$value);
+			log_audit($_SESSION['user'],"setting $CONF_REALMS[$realm]","$par = $value");
+			$update .= "$par = $value" . br();
+		}
+	}
+
+	if ($update!="") {
+		$class="ok"; $msg="Settings changed:" . br() . $update; 
+	} else { 
+		$class="warning"; $msg="No settings changed";
+	}
+	echo div_header("class","$class message") . $msg . div_footer();
+
+	$conf = get_config(0,$realm,'');
+}
+
+
+/* show settings */
+echo form_header("POST", "conf.php?realm=$realm");
+echo input_hidden("action","update");
+
+echo table_header( array("","$CONF_REALMS[$realm] Settings"), "grid");
+
+function input_element ($name,$value,$select) {
+	if ($select) {
+		$ret = select_header($name);
+		foreach ($select as $option)
+			$ret .= select_option($option,$option,"$value"===$option);
+		$ret .= select_footer();
+		return $ret;
+	}
+	$size=strlen($value)+1;
+	if ($size<20) $size=20;
+	if ($size>20) $size=30;
+	return input_text($name,$value,$size);
+}
+
+foreach (array_keys($conf) as $par) {
+	$value = $conf[$par];
+	$select=FALSE; if ( ($value==="TRUE") || ($value==="FALSE") ) $select=array("TRUE","FALSE");
+	$value = input_element("conf[$par]",$value,$select);
+
+	echo table_row( array( $par, $value) ) ;
+}
+
+
+echo table_footer();
+
+echo input_submit("Update");
+echo form_footer();
+
+
+switch ($realm) {
+   case 'S':	
+	$help	= ""
+	        . p("LOCK_GRACE_MINS = Minutes after which a user is again allowed access, if number of tries exceeded (0 = never).")
+		. p("LOGS_PURGE_<i>xxx</i> = automatically purge log entries after this number of days (0 = never)")
+                . li("ul",array(
+                        array("acc"," - Accounting Log"),
+                        array("audit"," - Audit Log"),
+                        array("auth"," - Authentication Log")
+                ))
+	        . p("MAXDIFF = max. allowed drift of mobile device, defined in sec.; default: 180")
+	        . p("MAXTRIES = max nr. of allowed failed logins before locking; default: 5")
+	        . p("PIN_MIN_LENGTH = minimal PIN length when setting new PIN")
+	        . p("USE_LDAP = enable/disable LDAP support")
+	        . p("VALID_CHARS = valid characters in username, verified for RADIUS logins")
+		;
+	break;
+   case'L':
+	$help	= ""
+	        . p("LDAP_ACCESS_..."
+		        . li("dl",array(array("","enable/disable LDAP access for ..."
+			        . li("ul",array(
+					array("PWD"," - temporary static passwords"),
+					array("RAD"," - fetching value of RADIUS attributes"),
+					array("SYNC"," - synchronization of users/devices"),
+				))
+			)))
+		)
+	        . p("LDAP_BIND_USER<br />LDAP_BIND_PASSWORD"
+		        . li("dl",array(array("","username and password for connecting to LDAP server.")))
+		)
+		. p("")
+	        . p("LDAP_CONNECT_HOST<br />LDAP_CONNECT_PORT<br />LDAP_CONNECT_PROTO"
+		        . li("dl",array(array("","hostname, port, and protocol version of LDAP server; multiple hostnames can be set, seperated by comma (,).")))
+		)
+		. p("")
+	        . p("LDAP_USER_..."
+		        . li("ul",array(
+				array("BASE"," - search base, for example \"DC=test,DC=com\""),
+				array("SEARCH"," - search filter, for example \"(samaacountname=%s)\"; %s is replaced by the username"),
+				array("NAME"," - LDAP attribute for the full username, for example \"userprincipalname\" or \"mail\""),
+				array("DEVICES"," - LDAP attribute for the user's device, for example \"telephoneNumber\"; can be a multi-value-field"),
+			))
+		)
+		. p("")
+	        . p("LDAP_REMOVE_USERS<br />LDAP_REMOVE_DEVICES<br />LDAP_REMOVE_ACCOUNTS"
+		        . li("dl",array(array("","If TRUE, data entries for no longer existing users will be deleted,<br />if FALSE, the user/device will be locked.")))
+		)
+		. p("")
+		;
+	break;
+}
+
+
+include 'INC/footer.php';
+
+?>
diff -Nur MOTP-AS_v0.7.2/HTML/CSS/layout.css MOTP-AS_v0.8/HTML/CSS/layout.css
--- MOTP-AS_v0.7.2/HTML/CSS/layout.css	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/CSS/layout.css	2012-04-15 18:49:47.000000000 +0200
@@ -167,7 +167,8 @@
     background-repeat: no-repeat;
     background-position: 5px;
     padding: 15px 0 0 35px;
-    height: 30px;
+    min-height: 30px;
+    height: 100%;
 }
 
 div.ok {
diff -Nur MOTP-AS_v0.7.2/HTML/db_tools.php MOTP-AS_v0.8/HTML/db_tools.php
--- MOTP-AS_v0.7.2/HTML/db_tools.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/db_tools.php	2012-04-15 18:49:47.000000000 +0200
@@ -7,7 +7,7 @@
 
 
 if ($action == "export") {
-	$filename = "motp_" . $_SERVER['SERVER_NAME'] . ".backup";
+	$filename = "motp_" . $_SERVER['SERVER_NAME'] . "_" . date("YmdHis") . ".backup";
 	header("Content-Type: text/plain");
 	header("Content-Disposition: attachment; filename=\"$filename\"");
 	log_audit($_SESSION['user'],"backup export",input(implode(", ",$_POST['export'])));
@@ -37,6 +37,7 @@
 }
 
 
+$title = "DB tools";
 include 'INC/header.php';
 
 $bcs = array ( array("index.php","home"), array("db_tools.php","DB tools") );
@@ -61,6 +62,9 @@
 	fclose($fp);
 	// remove file???
 
+	include 'INC/rad_save.php';
+	rad_save();
+
 	log_audit($_SESSION['user'],"backup import",input($_FILES['import']['name']));
 	stop("ok","Backup imported.");	
 } 
@@ -85,7 +89,7 @@
 	. table_header()
 	. table_row( array( input_checkbox("export[]","data",TRUE) . " MOTP configuration: users/devices/accounts"))
 	. table_row( array( input_checkbox("export[]","rads",TRUE) . " RADIUS settings"))
-	. table_row( array( input_checkbox("export[]","pref",TRUE) . " preferences"))
+	. table_row( array( input_checkbox("export[]","pref",TRUE) . " system settings / preferences"))
 	. table_row( array( input_checkbox("export[]","logs")      . " log files"))
 	. table_footer()
 	. div_footer()
diff -Nur MOTP-AS_v0.7.2/HTML/device.php MOTP-AS_v0.8/HTML/device.php
--- MOTP-AS_v0.7.2/HTML/device.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/device.php	2012-04-15 18:49:47.000000000 +0200
@@ -59,6 +59,7 @@
 	if (isset($_POST['name']))     $device->name     = input($_POST['name']);
 	if (isset($_POST['secret']))   $device->secret   = input($_POST['secret']);
 	if (isset($_POST['timezone'])) $device->timezone = input($_POST['timezone']);
+	if (isset($_POST['ldap']))     $device->ldap = TRUE ; else $device->ldap = FALSE;
 
 	$device->secret = strtolower($device->secret);
 
@@ -83,13 +84,17 @@
 	echo table_row( array ("Name:"  ,   input_text("name",     $device->name,   20 ) ));
 	echo table_row( array ("Secret:",   input_text("secret",   $device->secret, 20, 'id="device-secret"' ) ));
 	echo table_row( array ("Timezone:", input_text("timezone", $device->timezone,3, 'id="device-tz"' ) ));
+	if (LDAP_ACCESS_SYNC)
+	echo table_row( array( "LDAP",      input_checkbox("ldap", $device->ldap, $device->ldap) ) ) . br() ;
 	echo table_footer();	
 	echo input_submit("Ok","send");
 	echo form_footer();
 
-	$help   = p("name = name of device, can be empty") 
-		. p("secret = secret generated at initialization of token. The pin is stored in account settings.")
-		. p("timezone = difference (in hours) between GMT and device's timezone. You can find mobile otp's \"epch time\" in the left corner of this web page. If both your mobile device and this server both use GMT, what should be the default, timezone equals 0.")
+	$help   = p("Name = name of device, can be empty") 
+		. p("Secret = secret generated at initialization of token. The pin is stored in account settings.")
+		. p("Timezone = difference (in hours) between GMT and device's timezone. You can find mobile otp's \"epoch time\" in the left corner of this web page. If both your mobile device and this server both use GMT, what should be the default, timezone equals 0.")
+
+		. p("LDAP = synced via LDAP")
 		;
 	$hint = TRUE;
 
@@ -109,6 +114,8 @@
 		$userlist .= a("user.php?user=$user->id", $user->user) . br();
 	echo table_row( array ("Users:", $userlist ));
 
+	if (LDAP_ACCESS_SYNC)
+	echo table_row( array ("LDAP:",  $device->ldap ? "yes" : "no" ));
 	echo table_footer();
 
 	echo form_header("POST", "device.php?device=$devid") . input_hidden("action", "lock" )   . input_submit("Lock", "lock")     . form_footer();
@@ -118,11 +125,11 @@
 	echo form_header("POST", "device.php?device=$devid", $warn) . input_hidden("action", "delete" ) . input_submit("Delete", "delete") . form_footer();
 	echo form_header("POST", "device.php?device=$devid") . input_hidden("action", "sync" )   . input_submit("Sync", "sync")     . form_footer();
 
-	$help   = p("lock = lock device") 
-		. p("reset = unlock device and set offset to 0")
-		. p("edit = for editing name, secret and timezone")
-		. p("delete = delete device from database and unassign it from users (accounts)")
-		. p("sync = synchronize device's clock with server")
+	$help   = p("Lock = lock device") 
+		. p("Reset = unlock device and set offset to 0")
+		. p("Edit = for editing name, secret and timezone")
+		. p("Delete = delete device from database and unassign it from users (accounts)")
+		. p("Sync = synchronize device's clock with server")
 		;
 }
 
diff -Nur MOTP-AS_v0.7.2/HTML/devices.php MOTP-AS_v0.8/HTML/devices.php
--- MOTP-AS_v0.7.2/HTML/devices.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/devices.php	2012-04-15 18:49:47.000000000 +0200
@@ -9,12 +9,15 @@
 
 if (isset($_POST['name']))   { $name_filter   = input($_POST['name']); }   else { $name_filter=""; }
 if (isset($_POST['secret'])) { $secret_filter = input($_POST['secret']); } else { $secret_filter=""; }
-if (isset($_POST['status'])) { $stat_filter   = input($_POST['status']); } else { $stat_filter=""; }
+if (isset($_GET['status']))  { $stat_filter   = input($_GET['status']); }  else { $stat_filter=""; }
+if (isset($_POST['status'])) { $stat_filter   = input($_POST['status']); }
+if (isset($_GET['ldap']))    { $ldap_filter   = input($_GET['ldap']); }  else { $ldap_filter=""; }
+if (isset($_POST['ldap']))   { $ldap_filter   = input($_POST['ldap']); }
 
 $bcs = array ( array("index.php","home"), array("devices.php","Devices") );
 
 echo form_header("POST","devices.php");
-echo table_header (array ("Name", "Secret", "Status", "Last usage" ), "list" );
+echo table_header (array ("Name", "Secret", "Status", (LDAP_ACCESS_SYNC ? "LDAP" : NULL), "Last usage" ), "list sortable" );
 
 echo table_row ( array (
 	input_text("name",   $name_filter,   10),
@@ -24,18 +27,24 @@
 		. select_option(1,"active","$stat_filter"=="1")
 		. select_option(0,"locked","$stat_filter"=="0")
 		. select_footer() ,
+	(LDAP_ACCESS_SYNC ? select_header("ldap")
+		. select_option('','')
+		. select_option(1,"yes","$ldap_filter"=="1")
+		. select_option(0,"no","$ldap_filter"=="0")
+		. select_footer() : NULL) ,
 	' ' ,
 	input_submit("Search","search")
 ) );
 
 
-$devices = get_device_list ($name_filter, $secret_filter, $stat_filter);
+$devices = get_device_list ($name_filter, $secret_filter, $stat_filter, $ldap_filter);
 
 foreach ( $devices as $device ) {
 	echo table_row ( array (
 		a("device.php?device=$device->id", device_name($device) ) ,
 		a("device.php?device=$device->id", ($role == 'A') ? $device->secret : "") ,
 		($device->enabled) ? "active" : "locked" ,
+		(LDAP_ACCESS_SYNC ? (($device->ldap) ? "yes" : "no") : NULL) ,
 		( ($device->lasttime) ? date("d.m.Y",10* $device->lasttime) : "never used" ) 
 	) );
 }
@@ -49,6 +58,7 @@
 echo input_submit("Add new Device","add");
 echo form_footer();
 
+echo '<script type="text/javascript" src="JS/sorttable.js"></script>';
 
 include 'INC/footer.php';
 
diff -Nur MOTP-AS_v0.7.2/HTML/INC/config.php MOTP-AS_v0.8/HTML/INC/config.php
--- MOTP-AS_v0.7.2/HTML/INC/config.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/config.php	2012-04-15 18:49:47.000000000 +0200
@@ -1,6 +1,6 @@
 <?php
 
-$VERSION = "0.7.2";
+$VERSION = "0.8";
 
 
 /* access to DATABASE */
diff -Nur MOTP-AS_v0.7.2/HTML/INC/db_func.php MOTP-AS_v0.8/HTML/INC/db_func.php
--- MOTP-AS_v0.7.2/HTML/INC/db_func.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/db_func.php	2012-04-15 18:49:47.000000000 +0200
@@ -44,6 +44,7 @@
 		. "WHERE userid='$userdata->id' "
 		. "  AND devices.id=accounts.deviceid "
 		. "  AND devices.enabled=TRUE "
+		. "  AND accounts.pin!='' "
 		;
 	$result = mysql_query($query);
 	$number = mysql_num_rows($result);
@@ -174,7 +175,7 @@
 }
 
 function get_logins_today () {
-	$query = "SELECT COUNT(*) as counter FROM log_auth "
+	$query = "SELECT COUNT(id) as counter FROM log_auth "
 		." WHERE time > CURDATE() AND type = 'success' AND message LIKE '%RADIUS%'";
 	$result = mysql_query($query);
 	if (! $result) return 0;
@@ -195,20 +196,17 @@
 
 /* USER */
 
-function get_user_count () {
-	$query = "SELECT COUNT(*) as counter FROM users";
-	$result = mysql_query($query);
-	if (! $result) return 0;
-	$row = mysql_fetch_object($result);
-	return $row->counter;
-}
-
-function get_user_locked_count () {
-	$query = "SELECT COUNT(*) as counter FROM users WHERE enabled = FALSE";
+function get_user_counts () {
+	$query = "SELECT"
+		. " COUNT(id) as count,"
+		. " SUM(enabled AND tries <= ".MAXTRIES.") as enabled,"
+		. " SUM(ldap) as ldap"
+		. " FROM users"
+		;
 	$result = mysql_query($query);
 	if (! $result) return 0;
-	$row = mysql_fetch_object($result);
-	return $row->counter;
+	$row = mysql_fetch_array($result, MYSQL_ASSOC);
+	return $row;
 }
 
 function get_user_id ($user) {
@@ -217,7 +215,7 @@
 		;
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
-	if (mysql_num_rows($result) == 0) return 0;
+	if (mysql_num_rows($result) == 0) return FALSE;
 	$row = mysql_fetch_array($result, MYSQL_ASSOC);
 	return $row['id'];
 }
@@ -233,15 +231,18 @@
 	return $row['role'];
 }
 
-function get_user_list ($user_filter = "", $name_filter = "", $role_filter = "", $stat_filter = "") {
+function get_user_list ($user_filter = "", $name_filter = "", $role_filter = "", $stat_filter = "", $pw_filter = "", $ldap_filter = "") {
 
 	$where = ""; $op = "WHERE";
 	if ($user_filter != "") $where .= "$op user LIKE '%" . $user_filter . "%'";	if ($where) $op="AND";
 	if ($name_filter != "") $where .= "$op name LIKE '%" . $name_filter . "%'";	if ($where) $op="AND";
 	if ($role_filter != "") $where .= "$op role = '" . "$role_filter" . "'";	if ($where) $op="AND";
-	if ($stat_filter != "") $where .= "$op enabled = $stat_filter";			if ($where) $op="AND";
+	if ($stat_filter != "") $where .= "$op (NOT enabled OR tries>".MAXTRIES.") != '$stat_filter'";	if ($where) $op="AND";
+	if ($pw_filter   != "") $where .= "$op NOT(ISNULL(static.userid))='$pw_filter'";if ($where) $op="AND";
+	if ($ldap_filter != "") $where .= "$op ldap = '$ldap_filter'";			if ($where) $op="AND";
 	
-	$query = "SELECT * FROM users " 
+	// $query = "SELECT * FROM users " 
+	$query = "SELECT users.*, NOT(ISNULL(static.userid)) AS pw FROM users LEFT JOIN static ON static.userid=users.id "
 		. $where 
 		. " ORDER BY user "
 		;
@@ -270,6 +271,7 @@
 			. "role='$user->role', "
 			. "enabled='$user->enabled', "
 			. "tries='$user->tries', "
+			. "ldap='$user->ldap', "
 			. "llogin='$user->llogin' "
 		. " WHERE id='$user->id'"
 		;
@@ -279,6 +281,8 @@
 }
 
 function delete_user ($user) {
+	if (!$user) return FALSE;
+	if ($user->id == 0) return FALSE;
 	$query = "DELETE FROM users WHERE id='$user->id'";
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
@@ -288,6 +292,9 @@
 	$query = "DELETE FROM static WHERE userid='$user->id'";
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
+	$query = "DELETE FROM config WHERE userid='$user->id'";
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
 	return TRUE;
 }
 
@@ -298,8 +305,8 @@
 	if ($result) $result = mysql_num_rows($result);
 	if ($result) { error_msg("Duplicate username."); return FALSE; }
 
-	$query = "INSERT INTO users (user, name, role) "
-		. "VALUES  ('$user->user', '$user->name', '$user->role') "
+	$query = "INSERT INTO users (user, name, role, ldap) "
+		. "VALUES  ('$user->user', '$user->name', '$user->role', '$user->ldap') "
 		;
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
@@ -337,29 +344,27 @@
 
 /* DEVICES */
 
-function get_device_count () {
-	$query = "SELECT COUNT(*) as counter FROM devices";
-	$result = mysql_query($query);
-	if (! $result) return 0;
-	$row = mysql_fetch_object($result);
-	return $row->counter;
-}
-
-function get_device_locked_count () {
-	$query = "SELECT COUNT(*) as counter FROM devices where enabled = FALSE";
+function get_device_counts () {
+	$query = "SELECT"
+		. " COUNT(id) as count,"
+		. " SUM(enabled) as enabled,"
+		. " SUM(ldap) as ldap"
+		. " FROM devices"
+		;
 	$result = mysql_query($query);
 	if (! $result) return 0;
-	$row = mysql_fetch_object($result);
-	return $row->counter;
+	$row = mysql_fetch_array($result, MYSQL_ASSOC);
+	return $row;
 }
 
-function get_device_list ($name_filter = "", $secr_filter = "", $stat_filter = "") {
+function get_device_list ($name_filter = "", $secr_filter = "", $stat_filter = "", $ldap_filter = "") {
 
 	$where = ""; $op = "WHERE";
-	if ($name_filter != "") $where .= "$op name   LIKE '%" . $name_filter . "%'";     if ($where) $op="AND";
+	if ($name_filter != "") $where .= "$op name   LIKE '%" . $name_filter . "%'";	if ($where) $op="AND";
 	$secr_filter = scramble( strtolower($secr_filter) );
-	if ($secr_filter != "") $where .= "$op secret LIKE '%" . $secr_filter . "%'";     if ($where) $op="AND";
-	if ($stat_filter != "") $where .= "$op enabled = $stat_filter";                 if ($where) $op="AND";
+	if ($secr_filter != "") $where .= "$op secret LIKE '%" . $secr_filter . "%'";	if ($where) $op="AND";
+	if ($stat_filter != "") $where .= "$op enabled = $stat_filter";			if ($where) $op="AND";
+	if ($ldap_filter != "") $where .= "$op ldap = '$ldap_filter'";			if ($where) $op="AND";
 
 	$query = "SELECT * FROM devices " 
 		. $where 
@@ -385,6 +390,18 @@
 	return $row;
 }
 
+function get_device_id ($device) {
+	$devicesecret = scramble($device);
+	$query = "SELECT id FROM devices "
+		. "WHERE name='$device' OR secret='$devicesecret' "
+		;
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+	if (mysql_num_rows($result) == 0) return 0;
+	$row = mysql_fetch_array($result, MYSQL_ASSOC);
+	return $row['id'];
+}
+
 function update_device ($device) {
 	$device->secret = scramble($device->secret);
 	$query = "UPDATE devices "
@@ -393,6 +410,7 @@
 			. "enabled='$device->enabled', "
 			. "timezone='$device->timezone', "
 			. "offset='$device->offset', "
+			. "ldap='$device->ldap', "
 			. "lasttime='$device->lasttime' "
 		. " WHERE id='$device->id'"
 		;
@@ -421,8 +439,8 @@
 	}
 
 	$device->secret = scramble($device->secret);
-	$query = "INSERT INTO devices (name, secret, timezone) "
-		. "VALUES  ('$device->name', '$device->secret', '$device->timezone') "
+	$query = "INSERT INTO devices (name, secret, timezone, ldap) "
+		. "VALUES  ('$device->name', '$device->secret', '$device->timezone', '$device->ldap') "
 		;
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
@@ -448,18 +466,23 @@
 
 /* ACCOUNTS */
 
-function get_account_count () {
-	$query = "SELECT COUNT(*) as counter FROM accounts";
+function get_account_counts () {
+	$query = "SELECT"
+		. " COUNT(id) as count,"
+		. " SUM(ldap) as ldap"
+		. " FROM accounts"
+		;
 	$result = mysql_query($query);
 	if (! $result) return 0;
-	$row = mysql_fetch_object($result);
-	return $row->counter;
+	$row = mysql_fetch_array($result, MYSQL_ASSOC);
+	return $row;
 }
 
-function get_account_list ($user_filter = "", $device_filter = "") {
+function get_account_list ($user_filter = "", $device_filter = "", $ldap_filter = "") {
 	$where = ""; $op = "AND";
-	if ($user_filter != "") $where .= " $op users.user  LIKE '%" . $user_filter . "%'"; 
+	if ($user_filter != "")   $where .= " $op users.user  LIKE '%" . $user_filter . "%'"; 
 	if ($device_filter != "") $where .= " $op devices.name LIKE '%" . $device_filter . "%'";
+	if ($ldap_filter != "")   $where .= " $op accounts.ldap = '$ldap_filter'";
 
 	$query = "SELECT accounts.*, users.user AS user, devices.name AS device "
 		. " FROM accounts, users, devices "
@@ -491,12 +514,24 @@
 	return $row;
 }
 
+function get_account_id ($userid, $deviceid) {
+	$query = "SELECT id FROM accounts "
+		. "WHERE userid='$userid' AND deviceid='$deviceid' "
+		;
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+	if (mysql_num_rows($result) == 0) return 0;
+	$row = mysql_fetch_array($result, MYSQL_ASSOC);
+	return $row['id'];
+}
+
 function update_account (&$account) {
 	$account->pin = scramble($account->pin);
 	$query = "UPDATE accounts "
 		. "  SET   userid='$account->userid', "
 			. "pin='$account->pin', "
-			. "deviceid='$account->deviceid' "
+			. "deviceid='$account->deviceid', "
+			. "ldap='$account->ldap' "
 		. " WHERE id='$account->id'"
 		;
 	$result = mysql_query($query);
@@ -514,8 +549,8 @@
 
 function insert_account ($account) {
 	$account->pin = scramble($account->pin);
-	$query = "INSERT INTO accounts (userid, pin, deviceid) "
-		. "VALUES  ('$account->userid', '$account->pin', '$account->deviceid') "
+	$query = "INSERT INTO accounts (userid, pin, deviceid, ldap) "
+		. "VALUES  ('$account->userid', '$account->pin', '$account->deviceid', '$account->ldap') "
 		;
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
@@ -528,6 +563,17 @@
 
 /* STATIC PASSWORDS */
 
+function get_static_counts () {
+	$query = "SELECT"
+		. " COUNT(userid) as count"
+		. " FROM static"
+		;
+	$result = mysql_query($query);
+	if (! $result) return 0;
+	$row = mysql_fetch_array($result, MYSQL_ASSOC);
+	return $row;
+}
+
 function get_static ($userid) {
 	$query = "SELECT * FROM static WHERE userid='$userid'";
 	$result = mysql_query($query);
@@ -565,8 +611,15 @@
 	if (mysql_num_rows($result) == 0) return FALSE;
 	$row = mysql_fetch_object($result);
 
-	$hash=md5($row->salt . $password);
-	if ($hash != $row->hash) return FALSE;
+	if ($row->hash == "LDAP") {
+		$ok=ldap_check_password($user,$password);
+		if (!$ok) return FALSE;
+		$type="LDAP";
+	} else {
+		$hash=md5($row->salt . $password);
+		if ($hash !== $row->hash) return FALSE;
+		$type="Static";
+	}
 
 	if ($row->howoften > 0) {
 		$row->howoften --;
@@ -579,18 +632,22 @@
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
 
-	return true;
+	return $type;
 }
 
 
 /* RADIUS CLIENTS */
 
-function get_radclient_count () {
-	$query = "SELECT COUNT(*) as counter FROM rad_clients";
+function get_radclient_counts () {
+	$query = "SELECT"
+		. " COUNT(id) as count,"
+		. " SUM(enabled) as enabled"
+		. " FROM rad_clients"
+		;
 	$result = mysql_query($query);
 	if (! $result) return 0;
-	$row = mysql_fetch_object($result);
-	return $row->counter;
+	$row = mysql_fetch_array($result, MYSQL_ASSOC);
+	return $row;
 }
 
 function get_radclient_list ($name_filter = "") {
@@ -694,7 +751,7 @@
 	$query = "SELECT * "
 		. " FROM rad_profiles " 
 		. $where 
-		. " ORDER BY `match`,`type`"
+		. " ORDER BY `match`,`type`,`id`"
 	;
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
@@ -745,13 +802,15 @@
 	return get_radprofile ($profileid);
 }
 
-function get_avpairs ($user, $type, $op) {
+function get_avpairs ($user, $type = FALSE , $op = FALSE ) {
+	$where = "(`match`='' OR `match`='$user')";
+	if ($type) $where .= " AND type='$type' ";
+	if ($op)   $where .= " AND op='$op' ";
 	$query = "SELECT *"
 		. " FROM rad_profiles " 
-		. "WHERE type='$type' AND op='$op' "
-		. "  AND (`match`='' OR `match`='$user') "
+		. "WHERE $where "
 		. "ORDER BY id"
-	;
+		;
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
 	if (mysql_num_rows($result) == 0) return array();
@@ -764,10 +823,10 @@
 
 /* CONFIG */
 
-function get_config ($userid = 0, $scope = '', $config = array()) {
+function get_config ($userid, $realm, $scope, $config = array()) {
 	$query = "SELECT parameter,value FROM config WHERE userid='$userid'";
-	if ($scope != '')
-		$query .= " AND scope='$scope'";
+	if ($scope != '') $query .= " AND scope='$scope'";
+	if ($realm != '') $query .= " AND realm='$realm'";
 	$query .= " ORDER BY parameter";
 	$result = mysql_query($query);
 	if (! $result) return $config;
@@ -779,17 +838,17 @@
 
 function set_config ($userid, $par, $value ) {
 	$par = strtolower($par);
-	$query = "SELECT scope FROM config WHERE parameter='$par' AND userid='$userid'";
+	$query = "SELECT scope, realm FROM config WHERE parameter='$par' AND userid='$userid'";
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
-	$scope = '';
+	$scope = ''; $realm='P';
 	if (mysql_num_rows($result) > 0) {
 		$row = mysql_fetch_object($result);
-		$scope = $row->scope;
+		$scope = $row->scope; $realm = $row->realm;
 		$query = "UPDATE config SET value='$value' WHERE parameter='$par' AND userid='$userid'";
 	} else {
-		$query = "INSERT INTO config (parameter, scope, userid, value) "
-			. "VALUES ('$par', '$scope', '$userid', '$value')" 
+		$query = "INSERT INTO config (parameter, scope, userid, realm, value) "
+			. "VALUES ('$par', '$scope', '$userid', '$realm', '$value')" 
 			;
 	}
 	$result = mysql_query($query);
diff -Nur MOTP-AS_v0.7.2/HTML/INC/defs.php MOTP-AS_v0.8/HTML/INC/defs.php
--- MOTP-AS_v0.7.2/HTML/INC/defs.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/defs.php	2012-04-15 18:49:47.000000000 +0200
@@ -10,8 +10,15 @@
 $RAD_PROF_OPS = array (
 	'=' => "equal", 
 	'!' => "exist", 
+	'*' => "LDAP", 
 );
 
+$CONF_REALMS = array(
+	'P' => "Preferences",
+	'S' => "System",
+	'L' => "LDAP",
+	'R' => "RADIUS",
+);
 
 
 /* configs */
@@ -28,10 +35,10 @@
 if (isset($VALID_CHARS))	$CONFIG['VALID_CHARS']		= $VALID_CHARS;
 if (isset($SHOW_BUTTONS))	$CONFIG['SHOW_BUTTONS']		= $SHOW_BUTTONS;
 
-$CONFIG = get_config();
+$CONFIG = get_config(0,'','',$CONFIG);
 
 if (isset($_SESSION['user']))
-	$CONFIG = get_config( get_user_id($_SESSION['user']), '', $CONFIG);
+	$CONFIG = get_config( get_user_id($_SESSION['user']), '', '', $CONFIG);
 
 function config( $par ) {
 	global $CONFIG;
@@ -42,22 +49,47 @@
 	return $value;
 }
 
-define('MAXTRIES',		config('MAXTRIES'));
+/* general */
+define('LOCK_GRACE_MINS',	config('LOCK_GRACE_MINS'));
 define('MAXDIFF',		config('MAXDIFF'));
-define('RADIUS_CONF_CLIENTS',	config('RADIUS_CONF_CLIENTS'));
-define('RADIUS_SERV_RELOAD',	config('RADIUS_SERV_RELOAD'));
-define('LOGS_ROWS',		config('LOGS_ROWS'));
+define('MAXTRIES',		config('MAXTRIES'));
 define('LOGS_PURGE_ACC',	config('LOGS_ROWS_ACC'));
 define('LOGS_PURGE_AUDIT',	config('LOGS_ROWS_AUDIT'));
 define('LOGS_PURGE_AUTH',	config('LOGS_ROWS_AUTH'));
+define('PIN_MIN_LENGTH',	config('PIN_MIN_LENGTH'));
+define('USE_LDAP',		config('USE_LDAP'));
+define('VALID_CHARS',		config('VALID_CHARS'));
+
+/* preferences */
+define('GENERATE_PASSCODE',	config('GENERATE_PASSCODE'));
+define('LOGS_ROWS',		config('LOGS_ROWS'));
+define('SHOW_BUTTONS',		config('SHOW_BUTTONS'));
 define('SHOW_HELP',		config('SHOW_HELP'));
 define('SHOW_HINT',		config('SHOW_HINT'));
 define('SHOW_PIN',		config('SHOW_PIN'));
-define('GENERATE_PASSCODE',	config('GENERATE_PASSCODE'));
-define('VALID_CHARS',		config('VALID_CHARS'));
-define('SHOW_BUTTONS',		config('SHOW_BUTTONS'));
 define('WARN_DELETE',		config('WARN_DELETE'));
 
+/* RADIUS */
+define('RADIUS_CONF_CLIENTS',	config('RADIUS_CONF_CLIENTS'));
+define('RADIUS_SERV_RELOAD',	config('RADIUS_SERV_RELOAD'));
+
+/* LDAP */
+define('LDAP_ACCESS_PWD',	USE_LDAP && config('LDAP_ACCESS_PWD'));
+define('LDAP_ACCESS_RAD',	USE_LDAP && config('LDAP_ACCESS_RAD'));
+define('LDAP_ACCESS_SYNC',	USE_LDAP && config('LDAP_ACCESS_SYNC'));
+define('LDAP_CONNECT_HOST',	USE_LDAP ? config('LDAP_CONNECT_HOST') : "");
+define('LDAP_CONNECT_PORT',	config('LDAP_CONNECT_PORT'));
+define('LDAP_CONNECT_PROTO',	config('LDAP_CONNECT_PROTO'));
+define('LDAP_BIND_USER',	config('LDAP_BIND_USER'));
+define('LDAP_BIND_PASSWORD',	config('LDAP_BIND_PASSWORD'));
+define('LDAP_USER_BASE',	config('LDAP_USER_BASE'));
+define('LDAP_USER_SEARCH',	config('LDAP_USER_SEARCH'));
+define('LDAP_USER_NAME',	config('LDAP_USER_NAME'));
+define('LDAP_USER_DEVICES',	config('LDAP_USER_DEVICES'));
+define('LDAP_REMOVE_USERS',	config('LDAP_REMOVE_USERS'));
+define('LDAP_REMOVE_DEVICES',	config('LDAP_REMOVE_DEVICES'));
+define('LDAP_REMOVE_ACCOUNTS',	config('LDAP_REMOVE_ACCOUNTS'));
+
 // print_r($CONFIG);
 
 
diff -Nur MOTP-AS_v0.7.2/HTML/INC/header.php MOTP-AS_v0.8/HTML/INC/header.php
--- MOTP-AS_v0.7.2/HTML/INC/header.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/header.php	2012-04-15 18:49:47.000000000 +0200
@@ -39,6 +39,12 @@
      <li><a href="db_tools.php">DB TOOLS</a></li>
     </ul>
    </li>
+   <li><a href="#"><span>CONFIGURATION</span></a>
+    <ul>
+     <li><a href="conf.php?realm=S">SYSTEM</a></li>
+     <?php if (USE_LDAP) echo '<li><a href="conf.php?realm=L">LDAP</a></li>'; ?>
+    </ul>
+   </li>
    <li><a href="#"><span>RADIUS</span></a>
     <ul>
      <li><a href="radclients.php">RADIUS CLIENTS</a></li>
diff -Nur MOTP-AS_v0.7.2/HTML/INC/include.php MOTP-AS_v0.8/HTML/INC/include.php
--- MOTP-AS_v0.7.2/HTML/INC/include.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/include.php	2012-04-15 18:49:47.000000000 +0200
@@ -4,4 +4,5 @@
 include 'defs.php';
 include 'types.php';
 include 'misc.php';
+include 'ldap.php';
 ?>
diff -Nur MOTP-AS_v0.7.2/HTML/INC/ldap.php MOTP-AS_v0.8/HTML/INC/ldap.php
--- MOTP-AS_v0.7.2/HTML/INC/ldap.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/ldap.php	2012-04-15 18:49:47.000000000 +0200
@@ -0,0 +1,241 @@
+<?php
+
+
+function ldap_open () {
+	static $ldc;
+	if (isset($ldc)) return $ldc;
+	$ldc=FALSE;
+	if ( (!LDAP_CONNECT_HOST) || (LDAP_CONNECT_HOST=="") ) return FALSE;
+	$hosts = explode(',',LDAP_CONNECT_HOST);
+	foreach ($hosts as $host) {
+		$host = trim($host);
+		$ldc = @ldap_connect($host, LDAP_CONNECT_PORT);
+		if (! $ldc) continue;
+		ldap_set_option($ldc,LDAP_OPT_PROTOCOL_VERSION, LDAP_CONNECT_PROTO);
+// ldap_set_option(NULL, LDAP_OPT_DEBUG_LEVEL, 7);
+		if ($ldc) $ldb = @ldap_bind ($ldc, LDAP_BIND_USER, LDAP_BIND_PASSWORD);
+		if ($ldb) return $ldc;
+		$ldc=FALSE;
+	}
+	return $ldc;
+}
+
+
+$ldap_attributes = array (
+	"dn",
+	LDAP_USER_NAME,
+	LDAP_USER_DEVICES
+);
+$ldap_entries = FALSE;
+
+function ldap_add_attribute ($attribute) {
+	global $ldap_attributes;
+	$ldap_attributes[]=$attribute;
+}
+	
+function ldap_search_user ( $username ) {
+	global $ldap_attributes, $ldap_entries;
+
+	$ldc=ldap_open();
+	if (!$ldc) return FALSE;
+
+	$filter = htmlspecialchars_decode(LDAP_USER_SEARCH,ENT_QUOTES);
+	$filter = sprintf($filter,$username);
+	$lds = ldap_search ($ldc, LDAP_USER_BASE, $filter, $ldap_attributes );
+
+	$ldap_entries = ldap_get_entries($ldc,$lds);
+	if ($ldap_entries["count"] != 1) return FALSE;	// username not found or not unique
+	$ldap_entries = $ldap_entries[0];
+	return $ldap_entries["dn"];
+}
+
+function ldap_get_attribute ( $attribute, $array=FALSE ) {
+	global $ldap_entries;
+	if (! $ldap_entries) return FALSE;
+	$attribute = strtolower($attribute);
+	if (!array_key_exists($attribute,$ldap_entries)) return FALSE;
+	$entry = $ldap_entries[$attribute];
+	if (! $entry) return FALSE;
+	if ($array) {
+		// return array
+		if (! is_array($entry)) $entry=array($entry);	// always return array
+		else unset($entry["count"]); 			// now array w/o count entry
+	} else {
+		// take first value
+		if (is_array($entry)) $entry=$entry[0];
+	}
+	return $entry;
+}
+
+function ldap_check_password ( $username, $password ) {
+	if (! LDAP_ACCESS_PWD) return FALSE;
+	if ($username == "") return FALSE;
+	if ($password == "") return FALSE;
+	if ( (!LDAP_CONNECT_HOST) || (LDAP_CONNECT_HOST=="") ) return FALSE;
+
+	$userdn = ldap_search_user($username);
+	if (!$userdn) return FALSE;
+
+	$hosts = explode(',',LDAP_CONNECT_HOST);
+	foreach ($hosts as $host) {
+		$host = trim($host);
+		$userc = @ldap_connect($host, LDAP_CONNECT_PORT);
+		if (! $userc) continue;
+		ldap_set_option($userc,LDAP_OPT_PROTOCOL_VERSION, LDAP_CONNECT_PROTO);
+		if ($userc) $userb = @ldap_bind ($userc, $userdn, $password );
+		@ldap_close ($userc);
+		if ($userb) return TRUE;
+	}
+	return FALSE;
+}
+
+
+function ldap_sync_user ($username) {
+	if (! LDAP_ACCESS_SYNC) return FALSE;
+
+	/* check/create user entry */
+
+	$userdn = ldap_search_user($username);
+	$userid = get_user_id($username);
+
+	if ($userdn) {	// LDAP user found
+		$ldapdevices = ldap_get_attribute(LDAP_USER_DEVICES, TRUE);
+		if ( (!$ldapdevices) || (count($ldapdevices)<=0) ) {	// ignore users w/o Device
+			$userdn = FALSE;
+			$ldapdevices = array();
+		}
+	} else {
+		$ldapdevices = array();
+	}
+
+	if ($userid) {	// user in DB
+		$user=get_user($userid);
+		if (! $user->ldap) return FALSE;	//skip non LDAP user entries
+	}
+
+
+	if       ( (!$userdn) && (!$userid) ) {		// LDAP=no,  DB=no  => do nothing
+
+		return FALSE;
+
+	} elseif ( (!$userdn) && ( $userid) ) {		// LDAP=no,  DB=yes => lock/remove
+
+		if (LDAP_REMOVE_USERS) {	// delete
+			delete_user($user);
+			log_audit("LDAP","user delete","User #$user->id: $user->user ($user->name)");
+		} elseif ($user->enabled) {	// lock
+			$user->enabled = FALSE;
+			update_user($user);
+			log_audit("LDAP","user locked","User #$user->id: $user->user ($user->name)");
+		}
+
+	} elseif ( ( $userdn) && ( $userid) ) {		// LDAP=yes, DB=yes => update/unlock
+
+		$name    = ldap_get_attribute(LDAP_USER_NAME);
+		if ( ($name != $user->name) || (! $user->enabled) ) {
+			$msg = (! $user->enabled) ? "user unlock" : "user modify";
+			$user->name    = $name;
+			$user->enabled = TRUE;
+			update_user($user);
+			log_audit("LDAP",$msg,"User #$user->id: $user->user ($user->name)");
+		}
+
+	} elseif ( ( $userdn) && (!$userid) ) {		// LDAP=yes, DB=no  => create
+
+		$user = New User();
+		$user->user = $username;
+		$user->role  = 'U';
+		$user->ldap  = TRUE;
+		$user->name    = ldap_get_attribute(LDAP_USER_NAME);
+		$user=insert_user($user);
+		$userid=$user->id;
+		log_audit("LDAP","user add","User #$user->id: $user->user ($user->name)");
+	}
+
+	
+	/* check/create devices and accounts */
+
+	$ldapaccountids=array();
+	$ldapdeviceids=array();
+
+	foreach ($ldapdevices as $devicename) {
+
+		// check device
+		$devid = get_device_id($devicename);	// matches for name and secret, resp.
+		if (! $devid) {
+			// create device entry
+			$device = new Device();
+			$device->secret = $devicename;
+			$device->name  = "LDAP: $devicename";
+			$device->ldap  = TRUE;
+			$device = insert_device($device);
+			$devid = $device->id;
+			log_audit("LDAP","device add","Device #$device->id: $device->name");
+		}
+		$ldapdeviceids[$devid] = TRUE;
+
+		// check account
+		$acctid = get_account_id($userid,$devid);
+		if (! $acctid) {
+			// create account
+			$account = new Account();
+			$account->userid   = $userid;
+			$account->deviceid = $devid;
+			$account->pin      = "";
+			$account->ldap     = TRUE;
+			$account = insert_account($account);
+			$acctid = $account->id;
+			log_audit("LDAP","account add","Account #$account->id: - User #$account->userid ($account->user), Device #$account->deviceid ($account->device)");
+		}
+		$ldapaccountids[$acctid] = TRUE;
+	}
+
+	/* check devices */
+	$userdevices = get_devices_of_user($userid);
+	foreach ($userdevices as $device) {
+		if (! $device->ldap) continue;		// manually created => skip
+
+		$todelete = TRUE; $tounlock=FALSE;
+		if (isset($ldapdeviceids[$device->id])) {	// in use by user
+			$todelete = FALSE;
+			$tounlock = TRUE;
+		}
+		$deviceusers = get_users_of_device($device->id);
+		foreach ($deviceusers as $deviceuser) {
+			if ($deviceuser->id != $userid)		// device also used by other user, don't remove/lock
+				$todelete = FALSE;
+		}
+
+		if ($tounlock) {			// device in use => unlock
+			if (! $device->enabled) {
+				$device->enabled=TRUE;
+				update_device($device);
+				log_audit("LDAP","device unlock","Device #$device->id: $device->name");
+			}
+		} elseif ($todelete) {			// device not used => lock/remove
+			if (LDAP_REMOVE_DEVICES) {
+				delete_device($device);
+				log_audit("LDAP","device delete","Device #$device->id: $device->name");
+			} elseif ($device->enabled) {
+				$device->enabled = FALSE;
+				update_device($device);
+				log_audit("LDAP","device lock","Device #$device->id: $device->name");
+			}
+		}
+	}
+
+	/* check accounts */
+	$useraccounts = get_accounts_of_user($userid);
+	foreach ($useraccounts as $account) {
+		if (! $account->ldap) continue;				// manually created => skip
+		if (isset($ldapaccountids[$account->id])) continue;	// in use by user => skip
+		if (LDAP_REMOVE_ACCOUNTS) {
+			$account=get_account($account->id);	// to get more data for logging
+			delete_account($account);
+			log_audit("LDAP","account delete","Account #$account->id: - User #$account->userid ($account->user), Device #$account->deviceid ($account->device)");
+		}
+	}
+
+}
+
+?>
diff -Nur MOTP-AS_v0.7.2/HTML/INC/misc.php MOTP-AS_v0.8/HTML/INC/misc.php
--- MOTP-AS_v0.7.2/HTML/INC/misc.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/misc.php	2012-04-15 18:49:47.000000000 +0200
@@ -156,20 +156,21 @@
 	return $str;
 }
 
-function table_row ( $line = FALSE, $colspan = FALSE ) {
-	if ( $colspan != "0" ) {		
-	$str = "";
-	$str .= "    <tr>\n";
+function table_row ( $line = FALSE, $colspan = 0 ) {
+	if ( $colspan != 0 ) {		
+		$str = "";
+		$str .= "    <tr>\n";
 		$str .= "<td colspan=\"$colspan\">" . $line . "</td>\n";
-	$str .= "    </tr>\n";
+		$str .= "    </tr>\n";
 	} else {
-	$str = "";
-	$str .= "    <tr>\n";
-	foreach ($line as $td) {
-		$str .= "<td>" . $td . "</td>\n";
+		$str = "";
+		$str .= "    <tr>\n";
+		foreach ($line as $td) {
+			if (is_null($td)) continue;
+			$str .= "<td>" . $td . "</td>\n";
 		}
-	$str .= "    </tr>\n";
-}	
+		$str .= "    </tr>\n";
+	}	
 	return $str;
 }
 
@@ -290,3 +291,9 @@
 	return $str;
 }
 
+function nobreak ($str) {
+	return '<span style="white-space:nowrap;">'
+		. $str
+		. '</span>';
+}
+
diff -Nur MOTP-AS_v0.7.2/HTML/INC/rad_av.php MOTP-AS_v0.8/HTML/INC/rad_av.php
--- MOTP-AS_v0.7.2/HTML/INC/rad_av.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/rad_av.php	2012-04-15 18:49:47.000000000 +0200
@@ -1,26 +1,46 @@
 <?php
 
-function checkRadiusAVs ($user) {
-
-	// check if attributes are present
-	$avpairs = get_avpairs($user, 'C', '!' );
+function loadRadiusAVs ($user) {
+	$avpairs = get_avpairs($user, FALSE, '*');
 	foreach ($avpairs as $avpair) {
-		$attr = strtoupper($avpair->attr);
-		$attr = str_replace ("-", "_", $attr);
-		if (! getenv($attr)) {
-			log_auth ($user, "failure", "missing RADIUS attribute: $attr" );
-			return FALSE;
-		}
+		$ldapattr = $avpair->value;
+		ldap_add_attribute($ldapattr);
 	}
+}
+
+function checkRadiusAVs ($user) {
+	$avpairs = get_avpairs($user, 'C' );
 
-	// check if attribute values match	
-	$avpairs = get_avpairs($user, 'C', '=' );
 	foreach ($avpairs as $avpair) {
 		$attr = strtoupper($avpair->attr);
 		$attr = str_replace ("-", "_", $attr);
-		if ( ($value = getenv($attr)) && ($value != $avpair->value) ) {
-			log_auth ($user, "failure", "wrong value for RADIUS attribute: $attr = $avpair->value" );
-			return FALSE;
+		$value = getenv($attr);
+
+		switch ($avpair->op) {
+
+		   case '=':	// check value with database (equal)
+			if ($value && ($value != $avpair->value) ) {
+				log_auth ($user, "failure", "RADIUS check attribute - wrong value: $attr = $avpair->value" );
+				return FALSE;
+			}
+			break;
+
+		   case '!':	// check attribute existence
+			if (! $value) {
+				log_auth ($user, "failure", "RADIUS check attribute - missing: $attr" );
+				return FALSE;
+			}
+			break;
+
+		   case '*':	// check value with LDAP
+			if (! LDAP_ACCESS_RAD) continue 2;
+			$ldapvalue = ldap_get_attribute($avpair->value);
+			if ($value && ($value != $ldapvalue) ) {
+				log_auth ($user, "failure", "RADIUS check attribute - wrong LDAP value: $attr = $avpair->value" );
+				return FALSE;
+			}
+			break;
+
 		}
 	}
 
@@ -29,11 +49,31 @@
 
 
 function getRadiusAVs ($user) {
-	$avpairs = get_avpairs($user, 'S', '=' );
 	$avarray=array();
-	foreach ($avpairs as $avpair) {		// only send "last" value
-		$avarray[$avpair->attr] = $avpair->value;
+	$avpairs = get_avpairs($user, 'S');
+
+	foreach ($avpairs as $avpair) {
+		switch ($avpair->op) {
+
+		   case '=':	// set value from database
+			break;
+
+		   case '!':	// set value as send from client
+			$attr = strtoupper($avpair->attr);
+			$attr = str_replace ("-", "_", $attr);
+			$avpair->value = getenv($attr);
+			break;
+
+		   case '*':	// set value from LDAP
+			if (! LDAP_ACCESS_RAD) continue 2;
+			$avpair->value = ldap_get_attribute($avpair->value);
+			break;
+
+		}
+		if ($avpair->value && ($avpair->value != "") )
+			$avarray[$avpair->attr] = $avpair->value;	// overwrite if already set
 	}
+
 	$ret=""; $d="";
 	foreach (array_keys($avarray) as $key) {
 		$val = $avarray[$key];
@@ -41,6 +81,7 @@
 		$ret .= $d . "$key = $val";
 		$d = ", ";
 	}
+
 	return $ret;
 }
 
@@ -62,21 +103,39 @@
 		$avs[$par] = $val;
 	}
 
-	// log from command line
-	$avpairs = get_avpairs($user, 'A', '!' );
-	foreach ($avpairs as $avpair) {
-		$attr = $avpair->attr;
-		if (array_key_exists($attr, $avs)) {
-			$ret .= $d . "$attr = $avs[$attr]";
-			$d = ", ";
+	if (LDAP_ACCESS_RAD) {
+		$avpairs = get_avpairs($user, 'A', '*' );
+		if (! empty($avpairs)) {
+			loadRadiusAVs($user);
+			ldap_search_user($user);
 		}
 	}
 
-	// log as in database
-	$avpairs = get_avpairs($user, 'A', '=' );
+	$avpairs = get_avpairs($user, 'A');
 	foreach ($avpairs as $avpair) {
-		$ret .= $d . "$avpair->attr = $avpair->value";
-		$d = ", ";
+		switch ($avpair->op) {
+
+		   case '=':	// log value from database
+			$ret .= $d . "$avpair->attr = $avpair->value";
+			$d = ", ";
+			break;
+
+		   case '!':	// log value as send from client
+			$attr = $avpair->attr;
+			if (array_key_exists($attr, $avs)) {
+				$ret .= $d . "$attr = $avs[$attr]";
+				$d = ", ";
+			}
+			break;
+
+		   case '*':	// log value from LDAP
+			if (! LDAP_ACCESS_RAD) continue 2;
+			$ldapvalue = ldap_get_attribute($avpair->value);
+			$ret .= $d . "$avpair->attr = $ldapvalue";
+			$d = ", ";
+			break;
+
+		}
 	}
 
 	return $ret;
diff -Nur MOTP-AS_v0.7.2/HTML/INC/types.php MOTP-AS_v0.8/HTML/INC/types.php
--- MOTP-AS_v0.7.2/HTML/INC/types.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/INC/types.php	2012-04-15 18:49:47.000000000 +0200
@@ -11,6 +11,7 @@
 	public $tries;
 	public $llogin;
 	public $name;
+	public $ldap;
 }
 
 class Account {
@@ -18,6 +19,7 @@
 	public $userid;
 	public $pin;
 	public $deviceid;
+	public $ldap;
 	/* additional to database */
 	public $user;
 	public $device;
@@ -31,6 +33,7 @@
 	public $offset;
 	public $lasttime;
 	public $name;
+	public $ldap;
 }
 
 class StaticPW {
diff -Nur MOTP-AS_v0.7.2/HTML/index.php MOTP-AS_v0.8/HTML/index.php
--- MOTP-AS_v0.7.2/HTML/index.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/index.php	2012-04-15 18:49:47.000000000 +0200
@@ -4,12 +4,29 @@
 
 include 'INC/include.php';
 
+if ( ($_SESSION['user']=="admin") && (count_logs("audit",New Log(),"","")==1) ) {
+	header("Location: wiz_firsttime.php");
+	exit;
+}
+
 $title = "MOTP-AS - Login";
 include 'INC/header.php';
 
 
 if ($role == 'U') {
-	echo '<H1>Welcome to the Mobile OTP Authentication Server</H1>';
+	echo '<H1>Welcome to the MOTP-AS Self Service Portal</H1>';
+?>
+
+<div class="stat">
+<div>What you can do:</div>
+<ul>
+<li><a href="self.php?action=change+pin">Change PINs</a></li>
+<li>See the <a href="self.php">current status</a> of your user account</li>
+<li>Generate a passcode using the <a href="self.php?action=get+client">HTML client</a></li>
+</ul>
+</div>
+
+<?php
 	include 'INC/footer.php';
 	exit;
 }
@@ -33,13 +50,45 @@
 <div class="stat">
 <div>Database contains:</div>
 <ul>
-<li><?php echo get_device_count();    ?> <a href="devices.php"   >Devices</a>
-	<?php $c=get_device_locked_count(); if ($c) echo "($c " . '<a href="devices.php?status=0">locked</a>' . ")";?>
+<li><?php $counts=get_device_counts(); echo $counts['count'];   ?> <a href="devices.php"   >Devices</a>
+	<?php
+	$d = $counts['count'] - $counts['enabled'];
+	$l = $counts['ldap'];
+	$del = "";
+	if ($d || $l) { 
+		echo "(";
+		if ($d) { echo "$del" ."$d " . '<a href="devices.php?status=0">locked</a>';  $del=", "; }
+		if ($l) { echo "$del" ."$l " . '<a href="devices.php?ldap=1">LDAP</a>';      $del=", "; }
+		echo ")";
+	}
+	?>
+</li>
+<li><?php $counts=get_user_counts(); echo $counts['count'];     ?> <a href="users.php"     >Users</a>
+	<?php
+	$d = $counts['count'] - $counts['enabled'];
+	$s = get_static_counts(); $s = $s['count'];
+	$l = $counts['ldap'];
+	$del = "";
+	if ($d || $s || $l) { 
+		echo "(";
+		if ($d) { echo "$del" ."$d " . '<a href="users.php?status=0">locked</a>';    $del=", "; }
+		if ($s) { echo "$del" ."$s " . '<a href="users.php?statpw=1">static pw</a>'; $del=", "; }
+		if ($l) { echo "$del" ."$l " . '<a href="users.php?ldap=1">LDAP</a>';        $del=", "; }
+		echo ")";
+	}
+	?>
 </li>
-<li><?php echo get_user_count();      ?> <a href="users.php"     >Users</a>
-	<?php $c=get_user_locked_count(); if ($c) echo "($c " . '<a href="users.php?status=0">locked</a>' . ")";?>
+<li><?php $counts=get_account_counts(); echo $counts['count'];  ?> <a href="accounts.php"  >Accounts</a>
+	<?php
+	$l = $counts['ldap'];
+	$del = "";
+	if ($l) { 
+		echo "(";
+		if ($l) { echo "$del" ."$l " . '<a href="accounts.php?ldap=1">LDAP</a>';     $del=", "; }
+		echo ")";
+	}
+	?>
 </li>
-<li><?php echo get_account_count();   ?> <a href="accounts.php"  >Accounts</a></li>
 
 <?php
 if ($role == 'H') {
@@ -49,7 +98,12 @@
 }
 ?>
 
-<li><?php echo get_radclient_count(); ?> <a href="radclients.php">RADIUS clients</a></li>
+<li><?php $counts=get_radclient_counts(); echo $counts['count']; ?> <a href="radclients.php">RADIUS clients</a>
+	<?php
+	$d = $counts['count'] - $counts['enabled'];
+	if ($d) echo "($d disabled)";
+	?>
+</li>
 </ul>
 </div>
 
diff -Nur MOTP-AS_v0.7.2/HTML/JS/datetimepicker_css.js MOTP-AS_v0.8/HTML/JS/datetimepicker_css.js
--- MOTP-AS_v0.7.2/HTML/JS/datetimepicker_css.js	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/JS/datetimepicker_css.js	2012-04-15 18:49:47.000000000 +0200
@@ -79,8 +79,8 @@
 document.onmousedown = pickIt;
 document.onmousemove = dragIt;
 document.onmouseup = dropIt;
-
-function NewCssCal(pCtrl,pFormat,pScroller,pShowTime,pTimeMode,pHideSeconds) {
+                                                                            /* MODIFICATION */
+function NewCssCal(pCtrl,pFormat,pScroller,pShowTime,pTimeMode,pHideSeconds,defHour,defMinute) {
 	// get current date and time
 
 	dtToday = new Date();
@@ -131,6 +131,11 @@
 
 	exDateTime=document.getElementById(pCtrl).value;
 
+	/* MODIFICATION START */
+	Cal.SetHour(defHour);
+	Cal.SetMinute(defMinute);
+	/* MODIFICATION END */
+
 	if (exDateTime!="")	{ //Parse existing Date String
 		var Sp1;//Index of Date Separator 1
 		var Sp2;//Index of Date Separator 2 
@@ -1090,7 +1095,9 @@
  
 // starts the time spinner
 function startSpin(whatSpinner, direction) {
-	document.thisLoop = setInterval("nextStep('"+whatSpinner+"', '"+direction+"');", 125); //125 ms
+	/* MODIFICATION */
+	// document.thisLoop = setInterval("nextStep('"+whatSpinner+"', '"+direction+"');", 125); //125 ms
+	nextStep(whatSpinner, direction);
 }
 
 // performs a single increment or decrement
@@ -1113,5 +1120,6 @@
 
 //stops the time spinner
 function stopSpin() {
-	clearInterval(document.thisLoop);
+	/* MODIFICATION */
+	// clearInterval(document.thisLoop);
 }
diff -Nur MOTP-AS_v0.7.2/HTML/JS/hints.js MOTP-AS_v0.8/HTML/JS/hints.js
--- MOTP-AS_v0.7.2/HTML/JS/hints.js	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/JS/hints.js	2012-04-15 18:49:47.000000000 +0200
@@ -1,7 +1,7 @@
 
 document.write(
 	  '<link href="CSS/hints.css" rel="stylesheet" type="text/css"/>'
-	+ '<!--[if IE < 7.0]>'
+	+ '<!--[if lt IE 7]>'
 	+   '<link href="CSS/hints-ie.css" rel="stylesheet" type="text/css"/>'
 	+ '<![endif]-->'
 );
diff -Nur MOTP-AS_v0.7.2/HTML/JS/sorttable.js MOTP-AS_v0.8/HTML/JS/sorttable.js
--- MOTP-AS_v0.7.2/HTML/JS/sorttable.js	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.8/HTML/JS/sorttable.js	2012-04-15 18:49:47.000000000 +0200
@@ -0,0 +1,524 @@
+/*
+  SortTable
+  version 2
+  7th April 2007
+  Stuart Langridge, http://www.kryogenix.org/code/browser/sorttable/
+  
+  Instructions:
+  Download this file
+  Add <script src="sorttable.js"></script> to your HTML
+  Add class="sortable" to any table you'd like to make sortable
+  Click on the headers to sort
+  
+  Thanks to many, many people for contributions and suggestions.
+  Licenced as X11: http://www.kryogenix.org/code/browser/licence.html
+  This basically means: do what you want with it.
+*/
+
+ 
+var stIsIE = /*@cc_on!@*/false;
+
+sorttable = {
+  init: function() {
+    // quit if this function has already been called
+    if (arguments.callee.done) return;
+    // flag this function so we don't do the same thing twice
+    arguments.callee.done = true;
+    // kill the timer
+    if (_timer) clearInterval(_timer);
+    
+    if (!document.createElement || !document.getElementsByTagName) return;
+    
+    sorttable.DATE_RE = /^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d)$/;
+    sorttable.DATE_RE = /^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d) *(\d\d:\d\d:\d\d)?$/;	/** CHANGED */
+    
+    forEach(document.getElementsByTagName('table'), function(table) {
+      if (table.className.search(/\bsortable\b/) != -1) {
+        sorttable.makeSortable(table);
+      }
+    });
+    
+  },
+  
+  makeSortable: function(table) {
+    if (table.getElementsByTagName('thead').length == 0) {
+      // table doesn't have a tHead. Since it should have, create one and
+      // put the first table row in it.
+      the = document.createElement('thead');
+      the.appendChild(table.rows[0]);
+      table.insertBefore(the,table.firstChild);
+    }
+    // Safari doesn't support table.tHead, sigh
+    if (table.tHead == null) table.tHead = table.getElementsByTagName('thead')[0];
+    
+    if (table.tHead.rows.length != 1) return; // can't cope with two header rows
+    
+    // Sorttable v1 put rows with a class of "sortbottom" at the bottom (as
+    // "total" rows, for example). This is B&R, since what you're supposed
+    // to do is put them in a tfoot. So, if there are sortbottom rows,
+    // for backwards compatibility, move them to tfoot (creating it if needed).
+    sortbottomrows = [];
+    for (var i=0; i<table.rows.length; i++) {
+      if (table.rows[i].className.search(/\bsortbottom\b/) != -1) {
+        sortbottomrows[sortbottomrows.length] = table.rows[i];
+      }
+    }
+    if (sortbottomrows) {
+      if (table.tFoot == null) {
+        // table doesn't have a tfoot. Create one.
+        tfo = document.createElement('tfoot');
+        table.appendChild(tfo);
+      }
+      for (var i=0; i<sortbottomrows.length; i++) {
+        tfo.appendChild(sortbottomrows[i]);
+      }
+      delete sortbottomrows;
+    }
+    
+    // work through each column and calculate its type
+    headrow = table.tHead.rows[0].cells;
+    for (var i=0; i<headrow.length; i++) {
+      // manually override the type with a sorttable_type attribute
+      if (!headrow[i].className.match(/\bsorttable_nosort\b/)) { // skip this col
+        mtch = headrow[i].className.match(/\bsorttable_([a-z0-9]+)\b/);
+        if (mtch) { override = mtch[1]; }
+	      if (mtch && typeof sorttable["sort_"+override] == 'function') {
+	        headrow[i].sorttable_sortfunction = sorttable["sort_"+override];
+	      } else {
+	        headrow[i].sorttable_sortfunction = sorttable.guessType(table,i);
+	      }
+	      // make it clickable to sort
+	      headrow[i].sorttable_columnindex = i;
+	      headrow[i].sorttable_tbody = table.tBodies[0];
+	      dean_addEvent(headrow[i],"click", function(e) {
+
+          if (this.className.search(/\bsorttable_sorted\b/) != -1) {
+            // if we're already sorted by this column, just 
+            // reverse the table, which is quicker
+            sorttable.reverse(this.sorttable_tbody);
+            this.className = this.className.replace('sorttable_sorted',
+                                                    'sorttable_sorted_reverse');
+            this.removeChild(document.getElementById('sorttable_sortfwdind'));
+            sortrevind = document.createElement('span');
+            sortrevind.id = "sorttable_sortrevind";
+            sortrevind.innerHTML = stIsIE ? '&nbsp<font face="webdings">5</font>' : '&nbsp;&#x25B4;';
+            this.appendChild(sortrevind);
+            return;
+          }
+          if (this.className.search(/\bsorttable_sorted_reverse\b/) != -1) {
+            // if we're already sorted by this column in reverse, just 
+            // re-reverse the table, which is quicker
+            sorttable.reverse(this.sorttable_tbody);
+            this.className = this.className.replace('sorttable_sorted_reverse',
+                                                    'sorttable_sorted');
+            this.removeChild(document.getElementById('sorttable_sortrevind'));
+            sortfwdind = document.createElement('span');
+            sortfwdind.id = "sorttable_sortfwdind";
+            sortfwdind.innerHTML = stIsIE ? '&nbsp<font face="webdings">6</font>' : '&nbsp;&#x25BE;';
+            this.appendChild(sortfwdind);
+            return;
+          }
+          
+          // remove sorttable_sorted classes
+          theadrow = this.parentNode;
+          forEach(theadrow.childNodes, function(cell) {
+            if (cell.nodeType == 1) { // an element
+              cell.className = cell.className.replace('sorttable_sorted_reverse','');
+              cell.className = cell.className.replace('sorttable_sorted','');
+            }
+          });
+          sortfwdind = document.getElementById('sorttable_sortfwdind');
+          if (sortfwdind) { sortfwdind.parentNode.removeChild(sortfwdind); }
+          sortrevind = document.getElementById('sorttable_sortrevind');
+          if (sortrevind) { sortrevind.parentNode.removeChild(sortrevind); }
+          
+          this.className += ' sorttable_sorted';
+          sortfwdind = document.createElement('span');
+          sortfwdind.id = "sorttable_sortfwdind";
+          sortfwdind.innerHTML = stIsIE ? '&nbsp<font face="webdings">6</font>' : '&nbsp;&#x25BE;';
+          this.appendChild(sortfwdind);
+
+	        // build an array to sort. This is a Schwartzian transform thing,
+	        // i.e., we "decorate" each row with the actual sort key,
+	        // sort based on the sort keys, and then put the rows back in order
+	        // which is a lot faster because you only do getInnerText once per row
+	        row_array = [];
+	        col = this.sorttable_columnindex;
+	        rows = this.sorttable_tbody.rows;
+	        /* for (var j=0; j<rows.length; j++) {		** CHANGED */
+	        for (var j=1; j<rows.length; j++) {
+	          row_array[row_array.length] = [sorttable.getInnerText(rows[j].cells[col]), rows[j]];
+	        }
+	        /* If you want a stable sort, uncomment the following line */
+	        //sorttable.shaker_sort(row_array, this.sorttable_sortfunction);
+	        /* and comment out this one */
+	        row_array.sort(this.sorttable_sortfunction);
+	        
+	        tb = this.sorttable_tbody;
+	        /* for (var j=0; j<row_array.length; j++) { 	** CHANGED */
+	        for (var j=0; j<row_array.length; j++) {
+	          tb.appendChild(row_array[j][1]);
+	        }
+	        
+	        delete row_array;
+	      });
+	    }
+    }
+  },
+  
+  guessType: function(table, column) {
+    // guess the type of a column based on its first non-blank row
+    sortfn = sorttable.sort_alpha;
+    for (var i=0; i<table.tBodies[0].rows.length; i++) {
+      text = sorttable.getInnerText(table.tBodies[0].rows[i].cells[column]);
+      if (text != '') {
+	/* dont find numbers 				** CHANGED
+        if (text.match(/^-?[$]?[\d,.]+%?$/)) {
+          return sorttable.sort_numeric;
+        }
+	*/
+	if ((text=="yes")||(text=="no")) return sorttable.sort_yesno;	/** CHANGED */
+        // check for a date: dd/mm/yyyy or dd/mm/yy 
+        // can have / or . or - as separator
+        // can be mm/dd as well
+        possdate = text.match(sorttable.DATE_RE);
+        if (possdate) {
+	  return sorttable.sort_ddmm;		/* 	** CHANGED */
+          // looks like a date
+          first = parseInt(possdate[1]);
+          second = parseInt(possdate[2]);
+          if (first > 12) {
+            // definitely dd/mm
+            return sorttable.sort_ddmm;
+          } else if (second > 12) {
+            return sorttable.sort_mmdd;
+          } else {
+            // looks like a date, but we can't tell which, so assume
+            // that it's dd/mm (English imperialism!) and keep looking
+            sortfn = sorttable.sort_ddmm;
+          }
+        }
+	possdate = text.match("never .*");		/*	** CHANGED */
+	if (possdate) return sorttable.sort_ddmm;	/*	** CHANGED */
+      }
+    }
+    return sortfn;
+  },
+  
+  getInnerText: function(node) {
+    // gets the text we want to use for sorting for a cell.
+    // strips leading and trailing whitespace.
+    // this is *not* a generic getInnerText function; it's special to sorttable.
+    // for example, you can override the cell text with a customkey attribute.
+    // it also gets .value for <input> fields.
+    
+    hasInputs = (typeof node.getElementsByTagName == 'function') &&
+                 node.getElementsByTagName('input').length;
+    
+    /* if (node.getAttribute("sorttable_customkey") != null) {		** CHANGED
+      return node.getAttribute("sorttable_customkey");
+    }
+    else */ if (typeof node.textContent != 'undefined' && !hasInputs) {
+      return node.textContent.replace(/^\s+|\s+$/g, '');
+    }
+    else if (typeof node.innerText != 'undefined' && !hasInputs) {
+      return node.innerText.replace(/^\s+|\s+$/g, '');
+    }
+    else if (typeof node.text != 'undefined' && !hasInputs) {
+      return node.text.replace(/^\s+|\s+$/g, '');
+    }
+    else {
+      switch (node.nodeType) {
+        case 3:
+          if (node.nodeName.toLowerCase() == 'input') {
+            return node.value.replace(/^\s+|\s+$/g, '');
+          }
+        case 4:
+          return node.nodeValue.replace(/^\s+|\s+$/g, '');
+          break;
+        case 1:
+        case 11:
+          var innerText = '';
+          for (var i = 0; i < node.childNodes.length; i++) {
+            innerText += sorttable.getInnerText(node.childNodes[i]);
+          }
+          return innerText.replace(/^\s+|\s+$/g, '');
+          break;
+        default:
+          return '';
+      }
+    }
+  },
+  
+  reverse: function(tbody) {
+    // reverse the rows in a tbody
+    newrows = [];
+    /* for (var i=0; i<tbody.rows.length; i++) { 	** CHANGED */
+    for (var i=1; i<tbody.rows.length; i++) {
+      newrows[newrows.length] = tbody.rows[i];
+    }
+    for (var i=newrows.length-1; i>=0; i--) {
+       tbody.appendChild(newrows[i]);
+    }
+    delete newrows;
+  },
+  
+  /* sort functions
+     each sort function takes two parameters, a and b
+     you are comparing a[0] and b[0] */
+  sort_numeric: function(a,b) {
+    aa = parseFloat(a[0].replace(/[^0-9.-]/g,''));
+    if (isNaN(aa)) aa = 0;
+    bb = parseFloat(b[0].replace(/[^0-9.-]/g,'')); 
+    if (isNaN(bb)) bb = 0;
+    return aa-bb;
+  },
+  sort_alpha: function(a,b) {
+    /* if (a[0]==b[0]) return 0;	** CHANGED
+    if (a[0]<b[0]) return -1;	*/
+    if (a[0].toLowerCase()==b[0].toLowerCase()) return 0;
+    if (a[0].toLowerCase()<b[0].toLowerCase()) return -1;
+    return 1;
+  },
+  sort_yesno: function(a,b) {	/* new function		** CHANGED */
+    if (a[0]==b[0]) return 0;
+    if (a[0]=="yes") return -1;	
+    return 1;
+  },
+  sort_ddmm: function(a,b) {
+    mtch = a[0].match(sorttable.DATE_RE);
+    if (!mtch) return -1;	/*	** CHANGED */
+    y = mtch[3]; m = mtch[2]; d = mtch[1];
+    if (m.length == 1) m = '0'+m;
+    if (d.length == 1) d = '0'+d;
+    dt1 = y+m+d;
+    mtch = b[0].match(sorttable.DATE_RE);
+    if (!mtch) return 1;	/*	** CHANGED */
+    y = mtch[3]; m = mtch[2]; d = mtch[1];
+    if (m.length == 1) m = '0'+m;
+    if (d.length == 1) d = '0'+d;
+    dt2 = y+m+d;
+    if (dt1==dt2) return 0;
+    if (dt1<dt2) return -1;
+    return 1;
+  },
+  sort_mmdd: function(a,b) {
+    mtch = a[0].match(sorttable.DATE_RE);
+    y = mtch[3]; d = mtch[2]; m = mtch[1];
+    if (m.length == 1) m = '0'+m;
+    if (d.length == 1) d = '0'+d;
+    dt1 = y+m+d;
+    mtch = b[0].match(sorttable.DATE_RE);
+    y = mtch[3]; d = mtch[2]; m = mtch[1];
+    if (m.length == 1) m = '0'+m;
+    if (d.length == 1) d = '0'+d;
+    dt2 = y+m+d;
+    if (dt1==dt2) return 0;
+    if (dt1<dt2) return -1;
+    return 1;
+  },
+  
+  shaker_sort: function(list, comp_func) {
+    // A stable sort function to allow multi-level sorting of data
+    // see: http://en.wikipedia.org/wiki/Cocktail_sort
+    // thanks to Joseph Nahmias
+    var b = 0;
+    var t = list.length - 1;
+    var swap = true;
+
+    while(swap) {
+        swap = false;
+        for(var i = b; i < t; ++i) {
+            if ( comp_func(list[i], list[i+1]) > 0 ) {
+                var q = list[i]; list[i] = list[i+1]; list[i+1] = q;
+                swap = true;
+            }
+        } // for
+        t--;
+
+        if (!swap) break;
+
+        for(var i = t; i > b; --i) {
+            if ( comp_func(list[i], list[i-1]) < 0 ) {
+                var q = list[i]; list[i] = list[i-1]; list[i-1] = q;
+                swap = true;
+            }
+        } // for
+        b++;
+
+    } // while(swap)
+  }  
+}
+
+/* ******************************************************************
+   Supporting functions: bundled here to avoid depending on a library
+   ****************************************************************** */
+
+// Dean Edwards/Matthias Miller/John Resig
+
+/* for Mozilla/Opera9 */
+if (document.addEventListener) {
+    document.addEventListener("DOMContentLoaded", sorttable.init, false);
+}
+
+/* for Internet Explorer */
+/*@cc_on @*/
+/*@if (@_win32)
+    document.write("<script id=__ie_onload defer src=javascript:void(0)><\/script>");
+    var script = document.getElementById("__ie_onload");
+    script.onreadystatechange = function() {
+        if (this.readyState == "complete") {
+            sorttable.init(); // call the onload handler
+        }
+    };
+/*@end @*/
+
+/* for Safari */
+if (/WebKit/i.test(navigator.userAgent)) { // sniff
+    var _timer = setInterval(function() {
+        if (/loaded|complete/.test(document.readyState)) {
+            sorttable.init(); // call the onload handler
+        }
+    }, 10);
+}
+
+/* for other browsers */
+window.onload = sorttable.init;
+
+// written by Dean Edwards, 2005
+// with input from Tino Zijdel, Matthias Miller, Diego Perini
+
+// http://dean.edwards.name/weblog/2005/10/add-event/
+
+fired=false;	/*		** CHANGED */
+function dean_addEvent(element, type, handler) {
+	if (element.addEventListener) {
+		element.addEventListener(type, handler, false);
+	} else {
+		// assign each event handler a unique ID
+		if (!handler.$$guid) handler.$$guid = dean_addEvent.guid++;
+		// create a hash table of event types for the element
+		if (!element.events) element.events = {};
+		// create a hash table of event handlers for each element/event pair
+		var handlers = element.events[type];
+		if (!handlers) {
+			handlers = element.events[type] = {};
+			// store the existing event handler (if there is one)
+			if (element["on" + type]) {
+				handlers[0] = element["on" + type];
+			}
+		}
+		// store the event handler in the hash table
+		handlers[handler.$$guid] = handler;
+		// assign a global event handler to do all the work
+		element["on" + type] = handleEvent;
+	}
+	if (! fired) { 	/* new function			** CHANGED */
+		fired=true;
+		if (document.createEvent) { // DOM way
+			var e = document.createEvent('MouseEvents');
+			e.initEvent('click', true, true);
+			element.dispatchEvent(e);
+		} else { // IE way
+			var e = document.createEventObject();
+			element.fireEvent('onclick', e);
+		}
+	}
+};
+// a counter used to create unique IDs
+dean_addEvent.guid = 1;
+
+function removeEvent(element, type, handler) {
+	if (element.removeEventListener) {
+		element.removeEventListener(type, handler, false);
+	} else {
+		// delete the event handler from the hash table
+		if (element.events && element.events[type]) {
+			delete element.events[type][handler.$$guid];
+		}
+	}
+};
+
+function handleEvent(event) {
+	var returnValue = true;
+	// grab the event object (IE uses a global event object)
+	event = event || fixEvent(((this.ownerDocument || this.document || this).parentWindow || window).event);
+	// get a reference to the hash table of event handlers
+	var handlers = this.events[event.type];
+	// execute each event handler
+	for (var i in handlers) {
+		this.$$handleEvent = handlers[i];
+		if (this.$$handleEvent(event) === false) {
+			returnValue = false;
+		}
+	}
+	return returnValue;
+};
+
+function fixEvent(event) {
+	// add W3C standard event methods
+	event.preventDefault = fixEvent.preventDefault;
+	event.stopPropagation = fixEvent.stopPropagation;
+	return event;
+};
+fixEvent.preventDefault = function() {
+	this.returnValue = false;
+};
+fixEvent.stopPropagation = function() {
+  this.cancelBubble = true;
+}
+
+// Dean's forEach: http://dean.edwards.name/base/forEach.js
+/*
+	forEach, version 1.0
+	Copyright 2006, Dean Edwards
+	License: http://www.opensource.org/licenses/mit-license.php
+*/
+
+// array-like enumeration
+if (!Array.forEach) { // mozilla already supports this
+	Array.forEach = function(array, block, context) {
+		for (var i = 0; i < array.length; i++) {
+			block.call(context, array[i], i, array);
+		}
+	};
+}
+
+// generic enumeration
+Function.prototype.forEach = function(object, block, context) {
+	for (var key in object) {
+		if (typeof this.prototype[key] == "undefined") {
+			block.call(context, object[key], key, object);
+		}
+	}
+};
+
+// character enumeration
+String.forEach = function(string, block, context) {
+	Array.forEach(string.split(""), function(chr, index) {
+		block.call(context, chr, index, string);
+	});
+};
+
+// globally resolve forEach enumeration
+var forEach = function(object, block, context) {
+	if (object) {
+		var resolve = Object; // default
+		if (object instanceof Function) {
+			// functions have a "length" property
+			resolve = Function;
+		} else if (object.forEach instanceof Function) {
+			// the object implements a custom forEach method so use that
+			object.forEach(block, context);
+			return;
+		} else if (typeof object == "string") {
+			// the object is a string
+			resolve = String;
+		} else if (typeof object.length == "number") {
+			// the object is array-like
+			resolve = Array;
+		}
+		resolve.forEach(object, block, context);
+	}
+};
+
diff -Nur MOTP-AS_v0.7.2/HTML/login.php MOTP-AS_v0.8/HTML/login.php
--- MOTP-AS_v0.7.2/HTML/login.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/login.php	2012-04-15 18:49:47.000000000 +0200
@@ -33,7 +33,7 @@
         <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
         <title>MOTP</title>
     </head>
-    <body id="loginbody" onLoad='document.iform.username.focus();'>
+    <body id="loginbody" onLoad='document.all.username.focus();'>
         <div id="loginlogo"></div>
 
 
diff -Nur MOTP-AS_v0.7.2/HTML/logs.php MOTP-AS_v0.8/HTML/logs.php
--- MOTP-AS_v0.7.2/HTML/logs.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/logs.php	2012-04-15 18:49:47.000000000 +0200
@@ -26,8 +26,8 @@
 
 $bcs = array ( array("index.php","home"), array("logs.php?log=$log",$log . " Log") );
 echo '<script type="text/javascript" src="JS/datetimepicker_css.js"></script>';
-$from="<a href=\"javascript:NewCssCal('from','yyyyMMdd','Arrow','true','24','true')\"><img src=\"IMG/cal.gif\"></a>";
-$to="<a href=\"javascript:NewCssCal('to','yyyyMMdd','Arrow','true','24','true')\"><img src=\"IMG/cal.gif\"></a>";
+$from="<a href=\"javascript:NewCssCal('from','yyyyMMdd','Arrow','true','24','true','00','00')\"><img src=\"IMG/cal.gif\"></a>";
+$to="<a href=\"javascript:NewCssCal('to','yyyyMMdd','Arrow','true','24','true','23','59')\"><img src=\"IMG/cal.gif\"></a>";
 
 
 if ($count == "last") {
@@ -43,10 +43,11 @@
 
 echo form_header( "GET",  "logs.php" ); 
 echo input_hidden ( "log", $log );
-echo table_header( array( "Time", "User", "Type", "Message" ), "list" );
+echo table_header( array( "Time", "User", "Type", "Message" ), "list sortable" );
 
 echo table_row ( array (
-	input_text ("start", $start, 14, "id=\"from\"") . $from . br() . input_text ("end", $end, 14, "id=\"to\"") . $to ,
+	nobreak( input_text ("start", $start, 14, "id=\"from\"") . $from )
+		. nobreak( input_text ("end", $end, 14, "id=\"to\"") . $to ) ,
 	input_text ("user", $search->user, 10), 
 	input_text ("type", $search->type, 15), 
 	input_text ("message", $search->message, 30), 
@@ -91,6 +92,8 @@
 echo "<div id=\"nav\">" . $nav . "</div>";
 
 
+echo '<script type="text/javascript" src="JS/sorttable.js"></script>';
+
 include 'INC/footer.php';
 
 ?>
diff -Nur MOTP-AS_v0.7.2/HTML/pref.php MOTP-AS_v0.8/HTML/pref.php
--- MOTP-AS_v0.7.2/HTML/pref.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/pref.php	2012-04-15 18:49:47.000000000 +0200
@@ -16,14 +16,15 @@
 	stop("","");
 
 
-$global_prefs = get_config(0);
-$local_prefs = get_config($userid);
+$global_prefs = get_config(0,'P','');
+$local_prefs = get_config($userid,'P','');
 
-$scope_global = get_config(0,'G');
-$scope_admin= get_config(0,'A');
+$scope_global = get_config(0,'P','G');
+$scope_admin= get_config(0,'P','A');
 
 
 if ($action == "update") {
+	$update="";
 
 	if (isset($_POST['gp']))
 	   foreach (array_keys($_POST['gp']) as $par) {
@@ -31,9 +32,9 @@
 		$value = input($_POST['gp'][$par]);
 		if ($value == "") continue;
 		if ($value != $global_prefs[$par]) {
-			// echo "Global: $par = $value\n";
 			set_config(0,$par,$value);
 			log_audit($_SESSION['user'],"setting global","$par = $value");
+			$update .= "Global Setting: $par = $value" . br();
 		}
 	}
 
@@ -46,18 +47,25 @@
 		}
 		if ($value == "") {
 			if (! (array_key_exists($par,$local_prefs)) ) continue;
-			// echo "Deleting: $par\n";
 			delete_config($userid,$par);
 			log_audit($_SESSION['user'],"setting local","removed: $par");
+			$update .= "Personal Setting: $par reset" . br();
 		} elseif ( (!(array_key_exists($par,$local_prefs))) || ($value != $local_prefs[$par]) ) {
 			// echo "Local: $par = $value\n";
 			set_config($userid,$par,$value);
 			log_audit($_SESSION['user'],"setting local","$par = $value");
+			$update .= "Personal Setting: $par = $value" . br();
 		}
 	}
+	if ($update!="") {
+		$class="ok"; $msg="Settings changed:" . br() . $update;
+	} else {
+		$class="warning"; $msg="No settings changed";
+	}
+	echo div_header("class","$class message") . $msg . div_footer();
 
-	$global_prefs = get_config(0);
-	$local_prefs = get_config($userid);
+	$global_prefs = get_config(0,'P','');
+	$local_prefs = get_config($userid,'P','');
 }
 
 
@@ -65,7 +73,7 @@
 echo form_header("POST", "pref.php");
 echo input_hidden("action","update");
 
-echo table_header( array("","Global Settings","Personal Settings"), "edit");
+echo table_header( array("","Global Settings","Personal Settings"), "grid");
 
 function input_element ($name,$value,$select) {
 	if ($select) {
@@ -117,15 +125,7 @@
 
 $help	= ""
 	. p("GENERATE_PASSCODE = whether to show \"generate passcode\" button for accounts (TRUE/FALSE)")
-	. p("LOGS_PURGE_<i>xxx</i> = automatically purge log entries after this number of days (0 = never)")
-		. li("ul",array(
-			array("acc"," - Accounting Log"),
-			array("audit"," - Audit Log"),
-			array("auth"," - Authentication Log")
-		))
 	. p("LOGS_ROWS = nr. of rows when showing logs")
-	. p("MAXDIFF = max. allowed drift of mobile device, defined in sec.; default: 180")
-	. p("MAXTRIES = max nr. of allowed failed logins before locking; default: 5")
 	. p("SHOW_HELP = whether to show help box (TRUE/FALSE)")
 	. p("SHOW_HINT = whether to show interactive hints (TRUE/FALSE)")
 	. p("SHOW_BUTTONS = whether to show graphical buttons (TRUE/FALSE)")
@@ -137,7 +137,6 @@
 			array("H"," - show PIN to Helpdesk, too, but only if not data of Administrator or other Helpdesk")
 		))
 	)
-	. p("VALID_CHARS = valid characters in username, verified for RADIUS logins")
 	. p("WARN_DELETE = confirm deletion of data")
 	;
 
diff -Nur MOTP-AS_v0.7.2/HTML/radclient.php MOTP-AS_v0.8/HTML/radclient.php
--- MOTP-AS_v0.7.2/HTML/radclient.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/radclient.php	2012-04-15 18:49:47.000000000 +0200
@@ -91,9 +91,9 @@
 
 	if ($action=="edit") $bcs[3]=array("radclient.php?client=$clientid","$client->name");
 
-        $help   = p("name = name, only used to distinguish RADIUS clients")
-                . p("secret = RADIUS shared secret")
-                . p("ip = IP address of RADIUS client")
+        $help   = p("Name = name, only used to distinguish RADIUS clients")
+                . p("Secret = RADIUS shared secret")
+                . p("IP = IP address of RADIUS client")
                 ;
 	$hint = TRUE;
 
@@ -115,10 +115,10 @@
 
 	$bcs[3]=array("radclient.php?client=$clientid","$client->name");
 
-        $help   = p("disable = lock entry for radius client, i.e. authentication on this RADIUS client is no longer possible.")
-                . p("enable = enable RADIUS client, if it is disabled.")
-                . p("edit = edit name, secret and IP address")
-                . p("delete = delete entry from database; authentication on this RADIUS client is no longer possible.")
+        $help   = p("Disable = lock entry for radius client, i.e. authentication on this RADIUS client is no longer possible.")
+                . p("Enable = enable RADIUS client, if it is disabled.")
+                . p("Edit = edit name, secret and IP address")
+                . p("Delete = delete entry from database; authentication on this RADIUS client is no longer possible.")
                 ;
 
 }
diff -Nur MOTP-AS_v0.7.2/HTML/radclients.php MOTP-AS_v0.8/HTML/radclients.php
--- MOTP-AS_v0.7.2/HTML/radclients.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/radclients.php	2012-04-15 18:49:47.000000000 +0200
@@ -16,7 +16,7 @@
 
 echo form_header("POST", "radclients.php");
 
-echo table_header( array ("Name", "Secret", "IP", "Status" ), "list" );
+echo table_header( array ("Name", "Secret", "IP", "Status" ), "list sortable" );
 
 echo table_row ( array (
 	input_text ("name_filter", $name_filter ),
@@ -49,6 +49,8 @@
 echo form_footer();
 
 
+echo '<script type="text/javascript" src="JS/sorttable.js"></script>';
+
 include 'INC/footer.php';
 
 ?>
diff -Nur MOTP-AS_v0.7.2/HTML/radius-auth.php MOTP-AS_v0.8/HTML/radius-auth.php
--- MOTP-AS_v0.7.2/HTML/radius-auth.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/radius-auth.php	2012-04-15 18:49:47.000000000 +0200
@@ -9,9 +9,7 @@
 $passcode  = input($argv[2]);
 $radclient = input($argv[3]);
 
-if (! checkRadiusAVs($user)) {
-	exit(1);	// fail
-}
+loadRadiusAVs($user);
 
 $result = checkPassword($user,$passcode,$radclient);
 
diff -Nur MOTP-AS_v0.7.2/HTML/radprofile.php MOTP-AS_v0.8/HTML/radprofile.php
--- MOTP-AS_v0.7.2/HTML/radprofile.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/radprofile.php	2012-04-15 18:49:47.000000000 +0200
@@ -81,14 +81,15 @@
 			. li("ul",array(
 				array("check"," - Checking of attributes before authentication"),
 				array("send"," - Sending of attributes after successful authentication"),
-				array("acct"," - Accounting")
+				array("acct"," - Accounting (log)")
 			))
 		   )
                 . p("attribute = attribute name (case sensitive!)")
                 . p("op = " 
 			. li("ul",array(
-				array("equal (=)"," - if attribute matches value"),
-				array("exist (!)"," - if attribute is set")
+				array("equal (=)"," - check/send/log value"),
+				array("exist (!)"," - check existence; log as send"),
+				array("LDAP (*)","  - check/send/log LDAP value")
 			))
 		   )
                 . p("value = attribute value, can be empty")
diff -Nur MOTP-AS_v0.7.2/HTML/radprofiles.php MOTP-AS_v0.8/HTML/radprofiles.php
--- MOTP-AS_v0.7.2/HTML/radprofiles.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/radprofiles.php	2012-04-15 18:49:47.000000000 +0200
@@ -17,7 +17,7 @@
 
 echo form_header("POST", "radprofiles.php");
 
-echo table_header( array ("Match", "Type", "Attribute", "Operator", "Value" ), "list" );
+echo table_header( array ("Match", "Type", "Attribute", "Operator", "Value" ), "list sortable" );
 
 $select = select_header("type_filter","width:35px;");
 $select .= select_option('','');
@@ -40,9 +40,9 @@
 foreach ( $profiles as $profile ) {
 	echo table_row ( array (
 		$profile->match ,
-		$profile->type ,
+		$RAD_PROF_TYPES[$profile->type] ,
 		a("radprofile.php?profile=$profile->id", $profile->attr) ,
-		$profile->op ,
+		$RAD_PROF_OPS[$profile->op] ,
 		a("radprofile.php?profile=$profile->id", $profile->value) ,
 	) );
 }
@@ -57,6 +57,8 @@
 echo form_footer();
 
 
+echo '<script type="text/javascript" src="JS/sorttable.js"></script>';
+
 include 'INC/footer.php';
 
 ?>
diff -Nur MOTP-AS_v0.7.2/HTML/self.php MOTP-AS_v0.8/HTML/self.php
--- MOTP-AS_v0.7.2/HTML/self.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/self.php	2012-04-15 18:49:47.000000000 +0200
@@ -24,8 +24,8 @@
 
 
 if ($action == "set pin") {
-	if (isset($_POST['oldpin'])) $oldpin = input($_POST['oldpin']);
-	if (isset($_POST['newpin'])) $newpin = input($_POST['newpin']);
+	if (isset($_POST['oldpin'])) $oldpin = input($_POST['oldpin']); else $oldpin = "";
+	if (isset($_POST['newpin'])) $newpin = input($_POST['newpin']); else $newpin = "";
 	if (isset($_POST['account'])) $accountid = input($_POST['account']);
 
 	$account = get_account ($accountid);
@@ -35,14 +35,17 @@
 	if ($account->userid != $userid) {
 		stop("error","permission denied.");
 	}
-	if ($account->pin != $oldpin) {
+	if ( ($account->pin !== $oldpin) && (! ( $account->pin==="" ) ) ) {
 		$bcs = array ( array("index.php","home"), array("self.php?action=change+pin","Change PIN") );
 		stop("warning","wrong pin");
-	} else {
-		$account->pin = $newpin;
-		update_account($account);
-		log_audit($_SESSION['user'],"change pin","Account: $account->id");
-	}
+	} 
+	if ( strlen($newpin) < PIN_MIN_LENGTH ) {
+		$bcs = array ( array("index.php","home"), array("self.php?action=change+pin","Change PIN") );
+		stop("warning","minimal pin length is " . PIN_MIN_LENGTH . ".");
+	} 
+	$account->pin = $newpin;
+	update_account($account);
+	log_audit($_SESSION['user'],"change pin","Account: $account->id");
 }
 
 
@@ -61,12 +64,33 @@
 	foreach ($accounts as $account)
 		$select .= select_option($account->id, device_name(get_device($account->deviceid)) );
 	$select .= select_footer();
-	echo table_row( array( "Changing PIN for Device: ", $select) ); 
-
+	echo table_row( array( "Change PIN for Device: ", $select) ); 
 	echo table_row( array( "Old PIN: ", input_text("oldpin", "", 4) ) );
 	echo table_row( array( "New PIN: ", input_text("newpin", "", 4, 'id="account-pin"') ) );
 	echo table_footer();
 
+        echo '	<script type="text/javascript">
+			oldpin = document.getElementsByName("oldpin")[0];
+			newpin = document.getElementsByName("newpin")[0];
+			account =  document.getElementsByName("account")[0];
+			function emptypin() {
+				oldpin.disabled=true; oldpin.value="****";
+				newpin.focus();
+			';
+	foreach ($accounts as $account) {
+		if ( $account->pin === "" )
+			echo '		if (account.value == ' . $account->id . ') return; 
+		';
+	}
+	echo '
+				oldpin.disabled=false; oldpin.value="";
+				oldpin.focus();
+				};
+			account.onchange=emptypin;
+			account.onchange();
+		</script>
+		';
+
 	echo input_submit("Ok");
 	echo form_footer();
 
@@ -109,17 +133,18 @@
 	echo table_row( array( "Name:", $user->name) );
 	echo table_row( array( "Role:", $ROLES[$user->role]) );
 
-	$devlist = "";
-	foreach ($devices as $device) 
-		$devlist .= device_name($device) . " "; 
 	echo table_row( array(
 		"Status:",
 		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked" : "active" ) ) . br()
 		. "$user->tries/" . MAXTRIES . " failed logins" . br()
-		. "last login: " . ( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" ) . br() 
-		. "Devices: " . $devlist
+		. "last OTP login: " . ( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" ) . br() 
 	) );
 
+	$devlist = "";
+	foreach ($devices as $device) 
+		$devlist .= device_name($device) . br(); 
+	echo table_row( array( "Devices:", $devlist) );
+
 	echo table_footer();
 
 	echo form_header("POST", "self.php");
diff -Nur MOTP-AS_v0.7.2/HTML/static.php MOTP-AS_v0.8/HTML/static.php
--- MOTP-AS_v0.7.2/HTML/static.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/static.php	2012-04-15 18:49:47.000000000 +0200
@@ -34,6 +34,7 @@
 
 if ($action == "set") {
 	if (isset($_POST['password'])) $password = input($_POST['password']);
+	if (isset($_POST['ldap']))     $password = "LDAP";
 	if (isset($_POST['until']))    $static->until    = input($_POST['until']);
 	if (isset($_POST['howoften'])) $static->howoften = input($_POST['howoften']);
 
@@ -44,6 +45,10 @@
 		$static->salt=substr(md5(rand()),0,2);
 		$static->hash=md5($static->salt . $password);
 	}
+	if ($password == "LDAP") {
+		$static->salt="";
+		$static->hash="LDAP";
+	}
 
 	set_static ($static);
 	log_audit($_SESSION['user'],"static password set","User #$user->id: $user->user ($user->name); Until: $static->until; Howoften: $static->howoften");
@@ -56,25 +61,38 @@
 }
 
 echo '<script type="text/javascript" src="JS/datetimepicker_css.js"></script>';
-$cal="<a href=\"javascript:NewCssCal('cal','yyyyMMdd','Arrow','true','24','true')\"><img src=\"IMG/cal.gif\"></a>";
+$cal="<a href=\"javascript:NewCssCal('cal','yyyyMMdd','Arrow','true','24','true','23','59')\"><img src=\"IMG/cal.gif\"></a>";
 
 echo form_header("POST", "static.php?user=" . $userid );
 echo input_hidden("action","set");
 echo table_header( FALSE, "edit");
-echo table_row( array( "Password", input_text("password", "") ) ) ;
+$ldap = "(use LDAP password: " . input_checkbox("ldap","ldap",($static->hash=="LDAP")) . ")"
+	. '<script type="text/javascript">
+		password = document.getElementsByName("password")[0];
+		ldap =  document.getElementsByName("ldap")[0];
+		ldap.onchange=function () {
+			password.disabled=ldap.checked;
+			password.value=(ldap.checked?"LDAP":"");
+		};
+		ldap.onchange();
+	</script>'
+	;
+echo table_row( array( "Password", input_text("password", "") . (LDAP_ACCESS_PWD ? $ldap : "") ) ) ;
 echo table_row( array( "Valid until", input_text("until", ($static->until==0) ? "unlimited" : $static->until , 14, "id=\"cal\"" ) . $cal ) ) ;
 echo table_row( array( "Valid for ", input_text("howoften", ($static->howoften<0) ? "unlimited" : $static->howoften ) . "logins") ) ;
 echo table_footer();
 echo input_submit("Set","send");
 echo form_footer();
 
-echo form_header("POST", "static.php?user=" . $userid );
+$warn = (WARN_DELETE) ? "Are you sure to delete the static password?" : FALSE;
+echo form_header("POST", "static.php?user=" . $userid, $warn );
 echo input_hidden("action","delete");
 echo input_submit("Delete","delete");
 echo form_footer();
 
 
-$help   = p("You can set a (temporary) static password. The usage of the password can be limited:") 
+$help   = p("You can set a (temporary) static password. The usage of the password can be limited.") 
+	. p("If you select \"use LDAP password\", the LDAP password of the user will be used as temporary password.")
         . p("valid until = the static password is only valid until the given date and time. This is useful, if your users forgiot or lost their device and they need access for one day.")
         . p("valid for = the static password is only valid for the given number of logins. This is useful, if you want to allow login with a temporary password for example exactly one time.")
         . p("Please note, that you have to set a limitation, if the password should be used for RADIUS authentication. Without any limitation, it can only be used for login to the web helpdesk.")
diff -Nur MOTP-AS_v0.7.2/HTML/user.php MOTP-AS_v0.8/HTML/user.php
--- MOTP-AS_v0.7.2/HTML/user.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/user.php	2012-04-15 18:49:47.000000000 +0200
@@ -53,6 +53,7 @@
 	if (isset($_POST['user'])) $user->user = input($_POST['user']);
 	if (isset($_POST['role'])) $user->role = input($_POST['role']);
 	if (isset($_POST['name'])) $user->name = input($_POST['name']);
+	if (isset($_POST['ldap'])) $user->ldap = TRUE ; else $user->ldap = FALSE;
 
 	if ( ($role != 'A') && ($user->role != 'U') ) 
 		stop("error", "Not allowed to create an user with role \"$user->role\"");
@@ -86,20 +87,23 @@
 	$select .= select_footer();
 	echo table_row( array ("Role", $select) );
 
+	if (LDAP_ACCESS_SYNC)
+	echo table_row( array( "LDAP", input_checkbox("ldap", $user->ldap, $user->ldap) ) ) . br() ;
 	echo table_footer();
 
 	echo input_submit("Ok","send");
 	echo form_footer();
 
-        $help   = p("user = login name (used for authentication)") 
-                . p("name = full name, can be left empty")
-                . p("role = "
+        $help   = p("User = login name (used for authentication)") 
+                . p("Name = full name, can be left empty")
+                . p("Role = "
 		     . li("ul", array(
 			array("Administrator",": full access to web interface, including RADIUS settings"),
 			array("Helpdesk",": can manage accounts for users, no access to settings of administrators or other helpdesk users, no access to RADIUS settings"),
 			array("User",": Normal user, only access to \"Self Portal\" to change PIN")
 		       ) )
 		)
+                . p("LDAP = synced via LDAP")
                 ;
 
 } else {
@@ -112,9 +116,9 @@
 	echo table_row( array ( "Name:"	, $user->name ) );
 	echo table_row( array ( "Role:"	, $ROLES[$user->role] ) );
 	echo table_row( array ( "Status:", 
-		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked" : "active" ) )
+		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked for OTP" : "active" ) )
 		. br() . "$user->tries/" . MAXTRIES . " failed logins"
-		. br() . "last login: " . ( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" )
+		. br() . "last OTP login: " . ( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" )
 	) );
 
 	$devices = get_devices_of_user($userid);
@@ -124,6 +128,8 @@
 	echo table_row( array ( "Devices:", $devlist) );
 
 	echo table_row( array ( "Static Pwd:"	, get_static($user->id) ? "yes" : "no" ) );
+	if (LDAP_ACCESS_SYNC)
+	echo table_row( array ( "LDAP:"	, ($user->ldap) ? "yes" : "no" ) );
 	echo table_footer();
 
 
@@ -134,10 +140,11 @@
 	echo form_header("POST", "user.php?user=$userid", $warn) . input_hidden("action", "delete") . input_submit("Delete", "delete") . form_footer();
 	echo form_header("POST", "user.php?user=$userid") . input_hidden("action", "static password") . input_submit("Static Password","static") . form_footer();
 
-        $help   = p("lock = lock user; authentication with this user is no longer possible") 
-                . p("reset = unlock user, if locked, and reset number of failed logins.")
-                . p("edit = edit user's name and role")
-                . p("delete = delete user from database")
+        $help   = p("Lock = lock user; authentication with this user is no longer possible") 
+                . p("Reset = unlock user, if locked, and reset number of failed logins")
+                . p("Edit = edit user's name and role")
+                . p("Delete = delete user from database")
+                . p("Static Password = Set (temporarily) static password")
                 ;
 }
 
diff -Nur MOTP-AS_v0.7.2/HTML/users.php MOTP-AS_v0.8/HTML/users.php
--- MOTP-AS_v0.7.2/HTML/users.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/users.php	2012-04-15 18:49:47.000000000 +0200
@@ -10,12 +10,17 @@
 if (isset($_POST['user']))   { $user_filter = input($_POST['user']);   } else { $user_filter=""; }
 if (isset($_POST['name']))   { $name_filter = input($_POST['name']);   } else { $name_filter=""; }
 if (isset($_POST['role']))   { $role_filter = input($_POST['role']);   } else { $role_filter=""; }
-if (isset($_POST['status'])) { $stat_filter = input($_POST['status']); } else { $stat_filter=""; }
+if (isset($_GET['status']))  { $stat_filter = input($_GET['status']);  } else { $stat_filter=""; }
+if (isset($_POST['status'])) { $stat_filter = input($_POST['status']); } 
+if (isset($_GET['statpw']))  { $pw_filter   = input($_GET['statpw']);  } else { $pw_filter=""; }
+if (isset($_POST['statpw'])) { $pw_filter   = input($_POST['statpw']); } 
+if (isset($_GET['ldap']))    { $ldap_filter = input($_GET['ldap']);    } else { $ldap_filter=""; }
+if (isset($_POST['ldap']))   { $ldap_filter = input($_POST['ldap']);   } 
 
 $bcs = array ( array("index.php","home"), array("users.php","Users") );
 
 echo form_header("POST","users.php");
-echo table_header ( array("User", "Name", "Role", "Status", "Last Login"), "list" );
+echo table_header ( array("User", "Name", "Role", "Status", "StaticPW", LDAP_ACCESS_SYNC ? "LDAP" : NULL, "Last OTP Login"), "list sortable" );
 
 $select = select_header("role","width:35px;");
 $select .= select_option('','');
@@ -32,18 +37,30 @@
 		. select_option(1,"active","$stat_filter"=="1") 
 		. select_option(0,"locked","$stat_filter"=="0") 
 		. select_footer() ,
+	select_header("statpw")
+		. select_option('','')
+		. select_option(1,"yes","$pw_filter"=="1")
+		. select_option(0,"no","$pw_filter"=="0")
+		. select_footer() ,
+	(LDAP_ACCESS_SYNC) ? select_header("ldap")
+		. select_option('','')
+		. select_option(1,"yes","$ldap_filter"=="1")
+		. select_option(0,"no","$ldap_filter"=="0")
+		. select_footer() : NULL ,
 	' ' ,
 	input_submit("Search","search")
 	) );
 
-$users = get_user_list ($user_filter, $name_filter, $role_filter, $stat_filter);
+$users = get_user_list ($user_filter, $name_filter, $role_filter, $stat_filter, $pw_filter, $ldap_filter);
 
 foreach ( $users as $user ) {
 	echo table_row ( array (
 		a("user.php?user=$user->id", $user->user) ,
 		a("user.php?user=$user->id", $user->name) , 
 		"$user->role" ,
-		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked" : ("$user->tries"."/".MAXTRIES) ) ),
+		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked (OTP)" : ("$user->tries"."/".MAXTRIES) ) ),
+		( ($user->pw) ? "yes" : "no" ),
+		( LDAP_ACCESS_SYNC ? (($user->ldap) ? "yes" : "no" ) : NULL ),
 		( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" )
 	) );
 }
@@ -57,6 +74,14 @@
 echo input_submit("Add new User","add");
 echo form_footer();
 
+echo '<script type="text/javascript" src="JS/sorttable.js"></script>';
+/* echo '<script type="text/javascript">
+elem = document.getElementsByTagName("table")[0].tHead.rows[0].cells[0];
+evObj = document.createEvent("MouseEvents");
+evObj.initEvent( "click", true, true );
+window.onload=elem.dispatchEvent(evObj);
+</script>';
+*/
 
 include 'INC/footer.php';
 
diff -Nur MOTP-AS_v0.7.2/HTML/wiz_firsttime.php MOTP-AS_v0.8/HTML/wiz_firsttime.php
--- MOTP-AS_v0.7.2/HTML/wiz_firsttime.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/wiz_firsttime.php	2012-04-15 18:49:47.000000000 +0200
@@ -5,13 +5,14 @@
 include 'INC/include.php';
 
 
-$title = "MOTP-AS - Wizard - One Step Add";
+$title = "MOTP-AS - Wizard - First Time Configuration";
 include 'INC/header.php';
 
 $bcs = array ( array("index.php","home"), array("wiz_firsttime.php","First Time Configuration") );
 
 echo li("ol", array(
 	'<a href="static.php?user=1" target="_blank">Change Password of User "admin"</a>',
+	'Configure <a href="conf.php?realm=S" target="_blank">system</a> and <a href="conf.php?realm=L" target="_blank">LDAP</a> settings.',
 	'<a href="radclients.php" target="_blank">Add RADIUS clients</a>',
 	'<a href="wiz_quickadd.php" target="_blank">Add users</a>',
 	'Test your configuration; see <a href="http://motp-as.network-cube.de/index.php/faq/installation-faq" target="_blank">FAQs</a>.'
diff -Nur MOTP-AS_v0.7.2/HTML/wiz_import.php MOTP-AS_v0.8/HTML/wiz_import.php
--- MOTP-AS_v0.7.2/HTML/wiz_import.php	2012-03-11 14:22:28.000000000 +0100
+++ MOTP-AS_v0.8/HTML/wiz_import.php	2012-04-15 18:49:47.000000000 +0200
@@ -21,6 +21,7 @@
 	if (count($csv) != 10) return;
 	$warning = FALSE;
 // print_r($csv);
+	if ( ($csv[2]==="role") && ($csv[4]==="Secret") && ($csv[5]==="Timezone")) return;
 
 	$user = new User();
 	$user->user = $csv[0];
@@ -28,7 +29,7 @@
 	$user->role = $csv[2];
 	if (!array_key_exists($user->role,$ROLES)) $user->role='U'; 
 // print_r($user);
-	if ($user->user != "") {
+	if ($user->user !== "") {
 		$user=insert_user ($user);
 		if ($user) {
 			log_audit($_SESSION['user'],"user add","User: $user->user ($user->name)");
@@ -48,7 +49,7 @@
 	$device->secret = strtolower($device->secret);
 	$device->timezone = $csv[5];
 // print_r($device);
-	if ($device->secret != "") {
+	if ($device->secret !== "") {
 		$device=insert_device ($device);
 		if ($device) {
 			log_audit($_SESSION['user'],"device add","Device: $device->id ($device->name)");
@@ -67,7 +68,7 @@
 	$account->userid = $user->id;
 	$account->deviceid = $device->id;
 // print_r($account);
-	if ( ($account->pin != "") && ($account->userid != "") && ($account->deviceid != "") ) {
+	if ( ($account->pin !== "") && ($account->userid != "") && ($account->deviceid != "") ) {
 		$account=insert_account ($account);
 		if ($account) {
 			log_audit($_SESSION['user'],"account add","Account: $account->id ($account->userid, $account->deviceid)");
@@ -78,9 +79,9 @@
 		}
 	} else {
 		if ($warning) $warning .= br();
-		if ($account->pin == "")        $warning .= "No Account data";
-		elseif ($account->userid == "") $warning .= "No Account added: Which user?";
-		else                            $warning .= "No Account added: Which Device?";
+		if ($account->pin === "")	$warning .= "No Account data";
+		elseif ($account->userid == "")	$warning .= "No Account added: Which user?";
+		else				$warning .= "No Account added: Which Device?";
 	}
 
 	$static = new StaticPW();
@@ -92,14 +93,14 @@
 	$static->salt=substr(md5(rand()),0,2);
 	$static->hash=md5($static->salt . $static->hash);
 // print_r($static);
-	if ( ($csv[7] != "") && ($static->userid != "") ) {
+	if ( ($csv[7] !== "") && ($static->userid != "") ) {
 		if (set_static ($static) !== FALSE) {
 			log_audit($_SESSION['user'],"static password set","User: $user->user ($user->name); Until: $static->until; Howoften: $static->howoften");
 		} else {
 			if ($warning) $warning .= br();
 			$warning .= "Error setting Static Password";
 		}
-	} elseif ($csv[7] != "") {
+	} elseif ($csv[7] !== "") {
 		if ($warning) $warning .= br();
 		$warning .= "No Static Password added: Which user?";
 	}
