diff -Nur MOTP-AS_v0.6/HTML/about.php MOTP-AS_v0.7/HTML/about.php
--- MOTP-AS_v0.6/HTML/about.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/about.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,54 @@
+<?php
+
+include 'INC/session.php';
+
+include 'INC/include.php';
+
+$title = "MOTP-AS - About";
+include 'INC/header.php';
+
+$bcs = array ( array("index.php","home"), array("about.php","About") );
+
+?>
+
+<h1>Credits</h1>
+
+<div class="stat">
+<div>Most important:</div>
+<ul>
+<li>Thanks to Matthias for creating <a href="http://motp.sf.net/">Mobile OTP</a></li>
+</ul>
+</div>
+
+<div class="stat">
+<div>MOTP-AS:</div>
+<ul>
+<li>Adrian - logos and HTML layout</li>
+<li>Sebastian - hacking and pre-build images</li>
+<li>Steffen - maintaining and hosting web site</li>
+</ul>
+</div>
+
+<div class="stat">
+<div>Attributions:</div>
+<ul>
+<li>Menu was generated by <a href="http://purecssmenu.com/">Pure CSS Menu.com</a>.</li>
+<li>Selecting dates is powered by <a href="http://www.rainforestnet.com/datetimepicker.htm">JavaScript Date Time Picker</a>.</li>
+<li>Some Icons are Copyright &copy; <a href="http://p.yusukekamiyamane.com/">Yusuke Kamiyamane</a>. All rights reserved. Licensed under a <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 license</a>.</li>
+<li>Other Icons are from <a href="http://www.icojoy.com/">www.icojoy.com</a> | Zhebrakov Andrew (Andy-S).</li>
+<li>HTML client generates passcodes using <a href="http://pajhome.org.uk/crypt/md5">md5.js</a>.</li>
+<li></li>
+</ul>
+</div>
+
+<div class="stat">
+<div>Thanks to:</div>
+<ul>
+<li>all, who wrote nice and friendly mails ;-)</li>
+</ul>
+</div>
+
+
+<?php
+include 'INC/footer.php';
+?>
diff -Nur MOTP-AS_v0.6/HTML/account.php MOTP-AS_v0.7/HTML/account.php
--- MOTP-AS_v0.6/HTML/account.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/account.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,13 +2,10 @@
 
 include 'INC/session.php'; checkrole("AH","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 
-if (isset($_GET['action']))  $action=input($_GET['action']); else $action="";
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
 if (isset($_GET['account'])) $accountid =input($_GET['account']); else $accountid=0;
 
 $title = "MOTP-AS - Accounts";
@@ -65,7 +62,8 @@
 	$devices = get_device_list();
 	$users   = get_user_list();
 
-	echo form_header("post", "account.php?account=$accountid&action=insert");
+	echo form_header("POST", "account.php?account=$accountid");
+	echo input_hidden("action","insert");
 
 	$userselect = select_header("user");
 	foreach ($users as $user) {
@@ -81,14 +79,14 @@
 
 	echo table_header( FALSE, "edit");
 	echo table_row( array( "User:", $userselect ) );
-	$pin = show_data( $SHOW_PIN, $account->pin, "", $account->user, $_SESSION['user'], get_user_role($account->user), $role);
+	$pin = show_data( SHOW_PIN, $account->pin, "", $account->user, $_SESSION['user'], get_user_role($account->user), $role);
 	echo table_row( array( "PIN:", 
 		input_text("pin", $pin, 4, 'id="account-pin"') ) );
 	echo table_row( array( "Device:", $deviceselect ) );
 
 	echo table_footer();
 
-	echo input_submit("", "Ok");
+	echo input_submit("Ok","send");
 	echo form_footer();
 
 	$help   = p("user = username (login name) for this account") 
@@ -102,19 +100,30 @@
 
 	echo table_header(FALSE,"show");
 	echo table_row( array( "User:",   a("user.php?user=$account->userid", $account->user) ));
-	$pin = show_data( $SHOW_PIN, $account->pin, "****", $account->user, $_SESSION['user'], get_user_role($account->user), $role);
+	$pin = show_data( SHOW_PIN, $account->pin, "****", $account->user, $_SESSION['user'], get_user_role($account->user), $role);
 	echo table_row( array( "PIN:", $pin ));
 	echo table_row( array( "Device:", a("device.php?device=$account->deviceid" , ($account->device=="") ? "Device #".$account->deviceid : $account->device  )));
+
+	if ($action == "generate passcode") {
+		log_audit($_SESSION['user'],"generate OTP", "Account: $account->id (User: $account->user, Device: " . ($account->device=="" ? $account->deviceid : $account->device) . ")" );
+		$device = get_device ($account->deviceid);
+		$passcode = substr( md5( intval((gmdate("U")+$device->timezone*3600)/10) . $device->secret . $account->pin ),0,6);
+		echo table_row( array( "Passcode: ", $passcode));
+		}
+
 	echo table_footer();
 
-	echo form_header("get", "account.php");
-	echo input_hidden("account", $accountid );
-	echo input_submit("action", "edit");
-	echo input_submit("action", "delete");
-	echo form_footer();
+	echo form_header("POST", "account.php?account=$accountid") . input_hidden("action", "edit")   . input_submit("Edit", "edit")     . form_footer();
+	echo form_header("POST", "account.php?account=$accountid") . input_hidden("action", "delete") . input_submit("Delete", "delete") . form_footer();
+
+        if (GENERATE_PASSCODE) {
+		echo form_header("POST", "account.php?account=$accountid") . input_hidden("action", "generate passcode") . input_submit("Generate Passcode") . form_footer();
+	}
+
 
         $help   = p("edit = change/set account properties (assigned user, assigned device, PIN)")
 		. p("delete = delete account from database")
+		. p("generate passcode = generate a one time passcode for this account")
 		;
 
 }
diff -Nur MOTP-AS_v0.6/HTML/accounts.php MOTP-AS_v0.7/HTML/accounts.php
--- MOTP-AS_v0.6/HTML/accounts.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/accounts.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,26 +2,23 @@
 
 include 'INC/session.php'; checkrole("AH","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 $title = "MOTP-AS - Accounts";
 include 'INC/header.php';
 
-if (isset($_GET['user']))   { $user_filter   = input($_GET['user']); }   else { $user_filter=""; }
-if (isset($_GET['device'])) { $device_filter = input($_GET['device']); } else { $device_filter=""; }
+if (isset($_POST['user']))   { $user_filter   = input($_POST['user']); }   else { $user_filter=""; }
+if (isset($_POST['device'])) { $device_filter = input($_POST['device']); } else { $device_filter=""; }
 
 $bcs = array ( array("index.php","home"), array("accounts.php","Accounts") );
 
-echo form_header ("get", "accounts.php" );
+echo form_header ("POST", "accounts.php" );
 echo table_header( array ("User", "Device"), "list" );
 
 echo table_row ( array (
 	input_text( "user",   $user_filter,   10),
 	input_text( "device", $device_filter, 10),
-	input_submit("","Search")
+	input_submit("Search","search")
 ) );
 
 
@@ -39,9 +36,9 @@
 echo form_footer();
 
 
-echo form_header("get", "account.php");
+echo form_header("POST", "account.php");
 echo input_hidden("action", "add");
-echo input_submit("","Add new Account");
+echo input_submit("Add new Account","add");
 echo form_footer();
 
 
diff -Nur MOTP-AS_v0.6/HTML/auth.php MOTP-AS_v0.7/HTML/auth.php
--- MOTP-AS_v0.6/HTML/auth.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/auth.php	2011-07-10 10:31:44.000000000 +0200
@@ -6,13 +6,13 @@
 
 function checkPassword ($user, $password, $radius=FALSE) {
 
-	$user     = mysql_real_escape_string($user);
-	$passcode = mysql_real_escape_string($password);
+	if( str_replace(str_split(VALID_CHARS), '', $user) != "" ) { 
+		log_auth ($user, "failure", "invalid character in username" );
+		return FALSE;
+	}
 
 	if (check_static($user,$password,$radius)) {
-		log_auth ($user, "success", "Static Password, Client: " . ( $radius ? "$radius (RADIUS)" : $_SERVER['REMOTE_ADDR']." (Web)"
-) 
-);
+		log_auth ($user, "success", "Static Password, Client: " . ( $radius ? "$radius (RADIUS)" : $_SERVER['REMOTE_ADDR']." (Web)") );
 		return TRUE;
 	}
 
diff -Nur MOTP-AS_v0.6/HTML/checkMOTP.php MOTP-AS_v0.7/HTML/checkMOTP.php
--- MOTP-AS_v0.6/HTML/checkMOTP.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/checkMOTP.php	2011-07-10 10:31:44.000000000 +0200
@@ -1,17 +1,13 @@
 <?php
 
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 
 /* CHECK PASSCODE */
 
 function checkPasscode ($passcode, $pin, $secret, $timezone, $offset, $now, $maxdiff = 0 ) {
-	global $MAXDIFF;
-	if ($maxdiff == 0) $maxdiff=$MAXDIFF;
+	if ($maxdiff == 0) $maxdiff=MAXDIFF;
 
 	$now += $timezone*3600;
 	$now += $offset;
@@ -43,8 +39,6 @@
 /* CHECK MOTP */
 
 function checkMOTP ($user, $passcode, $client=FALSE) {
-	global $MAXTRIES;
-
 	$now = gmdate("U");
 	$client="Client: " . ( $client ? "$client (RADIUS)" : $_SERVER['REMOTE_ADDR']." (Web)" );
 
@@ -64,7 +58,7 @@
 	debug("user: $user, time: $time");
 
 	$passok = (bool) ($time > 0);					debug("passok=$passok");
-	$locked = (bool) ($userdata->tries > $MAXTRIES);		debug("locked=$locked");
+	$locked = (bool) ($userdata->tries > MAXTRIES);			debug("locked=$locked");
 	$replay = (bool) ($passok) && (! ($time > $device->lasttime) );	debug("replay=$replay");
 
 	if ($passok && !$replay && !$locked ) {	// ok
diff -Nur MOTP-AS_v0.6/HTML/client.php MOTP-AS_v0.7/HTML/client.php
--- MOTP-AS_v0.6/HTML/client.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/client.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,35 @@
+<?php
+
+include 'INC/session.php';
+
+include 'INC/include.php';
+
+
+$userid  = get_user_id($_SESSION['user']);
+if ($userid == 0) exit;
+
+$user = get_user($userid);
+
+
+if (isset($_POST['account'])) $accountid = input($_POST['account']);
+else stop("error","No account chosen.");
+
+$account = get_account ($accountid);
+if (! $account) {
+	echo "unknown account.";
+	exit;
+}
+if ($account->userid != $userid) {
+	echo "permission denied.";
+	exit;
+}
+
+log_audit($_SESSION['user'],"generated HTML client","Account: $account->id");
+
+$device = get_device($account->deviceid);
+$SECRET = $device->secret;
+
+
+include 'INC/htmlclient.php';
+
+?>
diff -Nur MOTP-AS_v0.6/HTML/CSS/hints.css MOTP-AS_v0.7/HTML/CSS/hints.css
--- MOTP-AS_v0.6/HTML/CSS/hints.css	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/CSS/hints.css	2011-07-10 10:31:44.000000000 +0200
@@ -10,6 +10,7 @@
 	padding: 5px;
 	border: 1px solid #f4f4f4;
 	background-color: #ffffe0;
+	position:relative; /* top:5px; left:20px; */
 }
 
 .hint div ul {
diff -Nur MOTP-AS_v0.6/HTML/CSS/layout.css MOTP-AS_v0.7/HTML/CSS/layout.css
--- MOTP-AS_v0.6/HTML/CSS/layout.css	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/CSS/layout.css	2011-07-10 10:31:44.000000000 +0200
@@ -113,6 +113,7 @@
     height: 100%;
     text-align: left;
     float: left;
+    margin: 10px;
 }
 
 div#help {
@@ -134,7 +135,7 @@
     height: 40px;
     background-color: #ffffff;
     clear: both;
-    padding: 3px 0px 0px 0px;
+    padding: 3px 10px 0px 0px;
 }
 
 div#footer-info {
@@ -162,6 +163,25 @@
     background-image: url('../IMG/errorsign.jpg');
 }
 
+div.message {
+    background-repeat: no-repeat;
+    background-position: 5px;
+    padding: 15px 0 0 35px;
+    height: 30px;
+}
+
+div.ok {
+    background-image: url('../IMG/good.png');
+}
+
+div.warning {
+    background-image: url('../IMG/warning.png');
+}
+
+div.error {
+    background-image: url('../IMG/error.png');
+}
+
 div#loginbox {
     border:1px solid #bcbcbc;
     width: 250px;
@@ -175,7 +195,8 @@
 }
 
 table.list {
-	padding: 1em 1em 1em 1em;
+	/* padding: 1em 1em 1em 1em; */
+	padding: 0 0 5px 0;
 	border-spacing: 0px;
 }
 table.list tr:nth-child(2n) {
@@ -192,7 +213,8 @@
 }
 
 table.show {
-	padding: 1em 1em 1em 1em;
+	/* padding: 1em 1em 1em 1em; */
+	padding: 0 0 5px 0;
         border-spacing: 0px;
 }
 table.show td {
@@ -200,7 +222,7 @@
 	text-align: left;
 	vertical-align: top;
 }
-table.show tr:nth-child(2n) {
+table.show tr:nth-child(2n+1) {
 	background-color: #f4f4f4;
 }
 
@@ -231,6 +253,7 @@
     margin-top: 5px;
     width: 50px;
     height: 20px;
+    float: none;
 }
 
 
@@ -298,6 +321,17 @@
 
 }
 
+.button {
+	border: 0px;
+	height: auto;
+	width: auto;
+}
+
+.submit {
+	float: left;
+	margin: 0px;
+}
+
 div#inv {
 	height: 30px;
 	display: block;
@@ -327,9 +361,17 @@
 }
 
 div#data form {
-	padding: 0em 1em 1em 1em;
+	/* padding: 0em 1em 0em 1em; */
 }
 div#data form input {
 	margin: 2px;
 }
 
+ol,ul,dl {
+	padding: 5px;
+	margin-left: 25px;
+}
+.text li {
+	padding: 3px;
+}
+
diff -Nur MOTP-AS_v0.6/HTML/CSS/menu.css MOTP-AS_v0.7/HTML/CSS/menu.css
--- MOTP-AS_v0.6/HTML/CSS/menu.css	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/CSS/menu.css	2011-07-10 10:31:44.000000000 +0200
@@ -1,3 +1,4 @@
+#about{float:right;}
 #pcm{display:none;}
 ul.Menu ul{display:none}
 ul.Menu li:hover>ul{display:block}
@@ -14,7 +15,7 @@
 ul.Menu {
 	display:block;
 	zoom:1;
-	float: left;
+	/* float: left; */
 }
 ul.Menu ul{
 	width:160.65px;
@@ -22,7 +23,7 @@
 ul.Menu li{
 	display:block;
 	margin:2px 0px 0px 2px;
-	// font-size:0px;
+	/* font-size:0px; */
 }
 ul.Menu a:active, ul.Menu a:focus {
 outline-style:none;
@@ -38,8 +39,8 @@
 	text-decoration:none;
 	padding:2px 6px 0px 6px;
 	_padding-left:0;
-	// font-family: "Geneva", "Arial [monotype]", "Helvetica", sans-serif;
-	// font-style: normal;
+	/* font-family: "Geneva", "Arial [monotype]", "Helvetica", sans-serif; */
+	/* font-style: normal; */
 	font-size: 10px;
 	color: #444444;
 	text-decoration:none;
@@ -86,7 +87,7 @@
 	background-color:#ca0002;
 	border-color:#665500;
 	border-style:solid;
-	// font:normal 11px Verdana;
+	/* font:normal 11px Verdana; */
 	color: #ffffff !important;
 	text-decoration:none;
 }
@@ -95,7 +96,7 @@
 	background-color:#ca0002;
 	border-color:#665500;
 	border-style:solid;
-	// font:normal 11px Verdana;
+	/* font:normal 11px Verdana; */
 	color: #ffffff;
 	text-decoration:none;
 }
@@ -129,4 +130,4 @@
 ul.Menu ul span,ul.Menu a:hover table span{background-image:url(../IMG/arrows-r-w.gif)}
 ul.Menu ul li:hover > a span{	background-image:url(../IMG/arrows-r-r.gif);}
 ul.Menu table a:hover span,ul.Menu table a:hover a:hover span,ul.Menu table a:hover a:hover a:hover span{background-image:url(../IMG/arrows-r-r.gif)}
-ul.Menu table a:hover table span,ul.Menu table a:hover a:hover table span{background-image:url(../IMG/arrows-r-.gif)}
+ul.Menu table a:hover table span,ul.Menu table a:hover a:hover table span{background-image:url(../IMG/arrows-r-r.gif)}
diff -Nur MOTP-AS_v0.6/HTML/device.php MOTP-AS_v0.7/HTML/device.php
--- MOTP-AS_v0.6/HTML/device.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/device.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,14 +2,11 @@
 
 include 'INC/session.php'; checkrole("AH","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 
-if (isset($_GET['action'])) $action=input($_GET['action']); else $action="";
-if (isset($_GET['device'])) $devid =input($_GET['device']); else $devid=0;
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
+if (isset($_GET['device']))  $devid=input($_GET['device']);   else $devid=0;
 
 if ($action == "sync") {
 	header("Location: sync.php?device=$devid");
@@ -67,7 +64,7 @@
 
 	if ($devid==0) {
 		$device=insert_device ($device);
-		if (! $device) stop("error", "Could not add device. Possible reason: device name already existing.");
+		if (! $device) stop("error", "Could not add device: " . error_msg() );
 		$devid=$device->id;
 		$bcs[3]=array("device.php?device=$devid",device_name($device));
 		log_audit($_SESSION['user'],"device add","Device: $device->id ($device->name)");
@@ -80,13 +77,14 @@
 
 if ( ($action == "add") || ($action == "edit") ) {
 
-	echo form_header("post", "device.php?device=$devid&action=insert");
+	echo form_header("POST", "device.php?device=$devid");
+	echo input_hidden("action","insert");
 	echo table_header(FALSE,"edit");
 	echo table_row( array ("Name:"  ,   input_text("name",     $device->name,   20 ) ));
 	echo table_row( array ("Secret:",   input_text("secret",   $device->secret, 20, 'id="device-secret"' ) ));
 	echo table_row( array ("Timezone:", input_text("timezone", $device->timezone,3, 'id="device-tz"' ) ));
 	echo table_footer();	
-	echo input_submit("","Ok");
+	echo input_submit("Ok","send");
 	echo form_footer();
 
 	$help   = p("name = name of device, can be empty") 
@@ -104,6 +102,7 @@
 	echo table_row( array ("Timezone:",$device->timezone ));
 	echo table_row( array ("Offset:",  $device->offset ));
 	echo table_row( array ("Lasttime:",( ($device->lasttime) ? "$device->lasttime (".date("d.m.Y",10 * $device->lasttime).")" : "never used" ) ));
+	echo table_row( array ("Status:",  $device->enabled ? "active" : "locked" ));
 
 	$userlist="";
 	foreach ($users as $user)
@@ -112,14 +111,11 @@
 
 	echo table_footer();
 
-	echo form_header("get", "device.php");
-	echo input_hidden("device", $devid );
-	echo input_submit("action", "lock");
-	echo input_submit("action", "reset"); echo br();
-	echo input_submit("action", "edit");
-	echo input_submit("action", "delete"); echo br();
-	echo input_submit("action", "sync");
-	echo form_footer();
+	echo form_header("POST", "device.php?device=$devid") . input_hidden("action", "lock" )   . input_submit("Lock", "lock")     . form_footer();
+	echo form_header("POST", "device.php?device=$devid") . input_hidden("action", "reset" )  . input_submit("Reset", "reset")   . form_footer();
+	echo form_header("POST", "device.php?device=$devid") . input_hidden("action", "edit" )   . input_submit("Edit", "edit")     . form_footer();
+	echo form_header("POST", "device.php?device=$devid") . input_hidden("action", "delete" ) . input_submit("Delete", "delete") . form_footer();
+	echo form_header("POST", "device.php?device=$devid") . input_hidden("action", "sync" )   . input_submit("Sync", "")         . form_footer();
 
 	$help   = p("lock = lock device") 
 		. p("reset = unlock device and set offset to 0")
diff -Nur MOTP-AS_v0.6/HTML/devices.php MOTP-AS_v0.7/HTML/devices.php
--- MOTP-AS_v0.6/HTML/devices.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/devices.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,21 +2,18 @@
 
 include 'INC/session.php'; checkrole("AH","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 $title = "MOTP-AS - Devices";
 include 'INC/header.php';
 
-if (isset($_GET['name']))   { $name_filter   = input($_GET['name']); }   else { $name_filter=""; }
-if (isset($_GET['secret'])) { $secret_filter = input($_GET['secret']); } else { $secret_filter=""; }
-if (isset($_GET['status'])) { $stat_filter   = input($_GET['status']); } else { $stat_filter=""; }
+if (isset($_POST['name']))   { $name_filter   = input($_POST['name']); }   else { $name_filter=""; }
+if (isset($_POST['secret'])) { $secret_filter = input($_POST['secret']); } else { $secret_filter=""; }
+if (isset($_POST['status'])) { $stat_filter   = input($_POST['status']); } else { $stat_filter=""; }
 
 $bcs = array ( array("index.php","home"), array("devices.php","Devices") );
 
-echo form_header("get","devices.php");
+echo form_header("POST","devices.php");
 echo table_header (array ("Name", "Secret", "Status", "Last usage" ), "list" );
 
 echo table_row ( array (
@@ -28,7 +25,7 @@
 		. select_option(0,"locked","$stat_filter"=="0")
 		. select_footer() ,
 	' ' ,
-	input_submit("","Search")
+	input_submit("Search","search")
 ) );
 
 
@@ -47,9 +44,9 @@
 echo form_footer();
 
 
-echo form_header("get","device.php");
+echo form_header("POST","device.php");
 echo input_hidden("action","add");
-echo input_submit("","Add new Device");
+echo input_submit("Add new Device","add");
 echo form_footer();
 
 
Files MOTP-AS_v0.6/HTML/IMG/add.png and MOTP-AS_v0.7/HTML/IMG/add.png differ
Files MOTP-AS_v0.6/HTML/IMG/bad.png and MOTP-AS_v0.7/HTML/IMG/bad.png differ
Files MOTP-AS_v0.6/HTML/IMG/bad_small.png and MOTP-AS_v0.7/HTML/IMG/bad_small.png differ
Files MOTP-AS_v0.6/HTML/IMG/delete.png and MOTP-AS_v0.7/HTML/IMG/delete.png differ
Files MOTP-AS_v0.6/HTML/IMG/edit.png and MOTP-AS_v0.7/HTML/IMG/edit.png differ
Files MOTP-AS_v0.6/HTML/IMG/enable.png and MOTP-AS_v0.7/HTML/IMG/enable.png differ
Files MOTP-AS_v0.6/HTML/IMG/error.png and MOTP-AS_v0.7/HTML/IMG/error.png differ
Files MOTP-AS_v0.6/HTML/IMG/good.png and MOTP-AS_v0.7/HTML/IMG/good.png differ
Files MOTP-AS_v0.6/HTML/IMG/good_small.png and MOTP-AS_v0.7/HTML/IMG/good_small.png differ
Files MOTP-AS_v0.6/HTML/IMG/lock.png and MOTP-AS_v0.7/HTML/IMG/lock.png differ
Files MOTP-AS_v0.6/HTML/IMG/ok.png and MOTP-AS_v0.7/HTML/IMG/ok.png differ
Files MOTP-AS_v0.6/HTML/IMG/reset.png and MOTP-AS_v0.7/HTML/IMG/reset.png differ
Files MOTP-AS_v0.6/HTML/IMG/search.png and MOTP-AS_v0.7/HTML/IMG/search.png differ
Files MOTP-AS_v0.6/HTML/IMG/send.png and MOTP-AS_v0.7/HTML/IMG/send.png differ
Files MOTP-AS_v0.6/HTML/IMG/warning.png and MOTP-AS_v0.7/HTML/IMG/warning.png differ
diff -Nur MOTP-AS_v0.6/HTML/import.csv MOTP-AS_v0.7/HTML/import.csv
--- MOTP-AS_v0.6/HTML/import.csv	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/import.csv	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,2 @@
+user,"Name of User",role,"Device name",Secret,Timezone,PIN,"Static Password",password-usage-count,password-expiration
+john,,U,nokia,1234567812345678,,1234,init-pw,1,
diff -Nur MOTP-AS_v0.6/HTML/INC/config.php MOTP-AS_v0.7/HTML/INC/config.php
--- MOTP-AS_v0.6/HTML/INC/config.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/config.php	2011-07-10 10:31:44.000000000 +0200
@@ -1,6 +1,6 @@
 <?php
 
-$VERSION = "0.6";
+$VERSION = "0.7";
 
 
 /* access to DATABASE */
@@ -15,7 +15,7 @@
 
 /* MOTP settings */
 $MAXTRIES = 5;		// max nr. of allowed failed logins before locking
-$MAXDIFF  = 360;	// max. allowed drift of mobile device, defined in sec.
+$MAXDIFF  = 180;	// max. allowed drift of mobile device, defined in sec.
 
 
 
@@ -43,4 +43,17 @@
 	//	A = show it to Administrators, too
 	//	H = show it to Helpdesk, but only if not data of Administrator or other Helpdesk
 
+$GENERATE_PASSCODE = TRUE;	// whether to show "generate passcode" button for accounts
+
+$SHOW_BUTTONS = TRUE;		// show graphical buttons
+
+
+/* authenticatin */
+$VALID_CHARS = "";
+$VALID_CHARS .= "1234567890";		// valid characters in username
+$VALID_CHARS .= "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
+$VALID_CHARS .= "abcdefghijklmnopqrstuvwxyz";
+$VALID_CHARS .= "-_.";
+
+
 ?>
diff -Nur MOTP-AS_v0.6/HTML/INC/db_func.php MOTP-AS_v0.7/HTML/INC/db_func.php
--- MOTP-AS_v0.6/HTML/INC/db_func.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/db_func.php	2011-07-10 10:31:44.000000000 +0200
@@ -10,7 +10,6 @@
 
 /* HELPER */
 
-
 function scramble ($string) {
 	global $mysql_scramble;
 	if ($mysql_scramble == FALSE) return $string;
@@ -125,7 +124,6 @@
 }
 
 function get_logs ($log, $search, $start, $end, $count=FALSE) {
-	global $LOGS_ROWS;
 
 	$table = "";
 	if ($log == "auth")  $table="log_auth";
@@ -143,7 +141,7 @@
 	$query = "SELECT * FROM $table "
 		. " WHERE " . $where
 		. " ORDER BY id "
-		. " LIMIT $search->id,$LOGS_ROWS "
+		. " LIMIT $search->id," . config('LOGS_ROWS')
 		;
 
 	if ($count) {
@@ -275,15 +273,18 @@
 	$query = "DELETE FROM accounts WHERE userid='$user->id'";
 	$result = mysql_query($query);
 	if (! $result) return FALSE;
+	$query = "DELETE FROM static WHERE userid='$user->id'";
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
 	return TRUE;
 }
 
 function insert_user ($user) {
-	if (! $user->user) return FALSE;
+	if (! $user->user) { error_msg("Username must not be empty."); return FALSE; }
 	$query = "SELECT * FROM users WHERE user='$user->user' " ;
 	$result = mysql_query($query);
 	if ($result) $result = mysql_num_rows($result);
-	if ($result) return FALSE;
+	if ($result) { error_msg("Duplicate username."); return FALSE; }
 
 	$query = "INSERT INTO users (user, name, role) "
 		. "VALUES  ('$user->user', '$user->name', '$user->role') "
@@ -404,7 +405,7 @@
 		$query = "SELECT * FROM devices WHERE name='$device->name' " ;
 		$result = mysql_query($query);
 		if ($result) $result = mysql_num_rows($result);
-		if ($result) return FALSE;
+		if ($result) { error_msg("Duplicate device name."); return FALSE; }
 	}
 
 	$device->secret = scramble($device->secret);
@@ -628,17 +629,17 @@
 }
 
 function insert_radclient ($client) {
-	if (! $client->name) return FALSE;
+	if (! $client->name) { error_msg("Client name empty."); return FALSE; }
 	$query = "SELECT * FROM rad_clients WHERE name='$client->name' OR ip=INET_ATON('$client->ip')" ;
 	$result = mysql_query($query);
 	if ($result) $result = mysql_num_rows($result);
-	if ($result) return FALSE;
+	if ($result) { error_msg("Duplicate name or IP address."); return FALSE; }
 
 	$query = "INSERT INTO rad_clients (name, secret, ip) "
 		. "VALUES  ('$client->name', '$client->secret', INET_ATON('$client->ip')) "
 		;
 	$result = mysql_query($query);
-	if (! $result) return FALSE;
+	if (! $result) { error_msg("IP address incorrect."); return FALSE; }
 
 	$clientid = mysql_insert_id();
 	return get_radclient ($clientid);
@@ -655,4 +656,98 @@
 	return $row;
 }
 
+
+
+/* RADIUS AV PAIRS */
+
+function get_radprofile_list ($match_filter = "", $type_filter = "", $attr_filter = "" ) {
+	$where = ""; $op = "WHERE";
+	if ($match_filter != "") $where .= "$op `match` LIKE '%". $match_filter ."%'";	if ($where) $op="AND";
+	if ($type_filter  != "") $where .= "$op type= '" . "$type_filter" . "'";	if ($where) $op="AND";
+	if ($attr_filter  != "") $where .= "$op attr LIKE '%". $attr_filter . "%'";;	if ($where) $op="AND";
+	
+	$query = "SELECT * "
+		. " FROM rad_profiles " 
+		. $where 
+		. " ORDER BY `match`,`type`"
+	;
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+	if (mysql_num_rows($result) == 0) return array();
+	while ($row = mysql_fetch_object($result))
+		$radprofiles[] = $row;
+	return $radprofiles;
+}
+
+function get_radprofile ($id) {
+	$query = "SELECT * FROM rad_profiles WHERE id='$id'";
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+	if (mysql_num_rows($result) == 0) return FALSE;
+	$row = mysql_fetch_object($result);
+	return $row;
+}
+
+function update_radprofile ($profile) {
+	$query = "UPDATE rad_profiles "
+		. "  SET `match` ='$profile->match', "
+			. "type  ='$profile->type', "
+			. "attr  ='$profile->attr', "
+			. "op    ='$profile->op', "
+			. "value ='$profile->value' "
+		. " WHERE id='$profile->id'"
+		;
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+	return TRUE;
+}
+
+function delete_radprofile ($profile) {
+	$query = "DELETE FROM rad_profiles WHERE id='$profile->id'";
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+	return TRUE;
+}
+
+function insert_radprofile ($profile) {
+	$query = "INSERT INTO rad_profiles (`match`, type, attr, op, value) "
+		. "VALUES  ('$profile->match', '$profile->type', '$profile->attr', '$profile->op', '$profile->value') "
+		;
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+
+	$profileid = mysql_insert_id();
+	return get_radprofile ($profileid);
+}
+
+function get_avpairs ($user, $type, $op) {
+	$query = "SELECT *"
+		. " FROM rad_profiles " 
+		. "WHERE type='$type' AND op='$op' "
+		. "  AND (`match`='' OR `match`='$user') "
+		. "ORDER BY id"
+	;
+	$result = mysql_query($query);
+	if (! $result) return FALSE;
+	if (mysql_num_rows($result) == 0) return array();
+	while ($row = mysql_fetch_object($result))
+		$radprofiles[] = $row;
+	return $radprofiles;
+}
+
+
+
+/* CONFIG */
+
+function get_config ($userid = 0, $config = array()) {
+	$query = "SELECT parameter,value FROM config WHERE userid='$userid'";
+	$result = mysql_query($query);
+	if (! $result) return $config;
+	if (mysql_num_rows($result) == 0) return $config;
+	while ($row = mysql_fetch_object($result))
+		$config[strtoupper($row->parameter)] = $row->value;
+	return $config;
+}
+
+
 ?>
diff -Nur MOTP-AS_v0.6/HTML/INC/defs.php MOTP-AS_v0.7/HTML/INC/defs.php
--- MOTP-AS_v0.6/HTML/INC/defs.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/defs.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,61 @@
+<?php
+
+
+$RAD_PROF_TYPES = array (
+	'C' => "check", 
+	'S' => "send", 
+	'A' => "acct", 
+);
+
+$RAD_PROF_OPS = array (
+	'=' => "equal", 
+	'!' => "exist", 
+);
+
+
+
+/* configs */
+
+
+$CONFIG = get_config();
+
+if (isset($MAXTRIES))		$CONFIG['MAXTRIES']		= $MAXTRIES;
+if (isset($MAXDIFF))		$CONFIG['MAXDIFF']		= $MAXDIFF;
+if (isset($RADIUS_CONF_CLIENTS))$CONFIG['RADIUS_CONF_CLIENTS']	= $RADIUS_CONF_CLIENTS;
+if (isset($RADIUS_SERV_RELOAD))	$CONFIG['RADIUS_SERV_RELOAD']	= $RADIUS_SERV_RELOAD;
+if (isset($LOGS_ROWS))		$CONFIG['LOGS_ROWS']		= $LOGS_ROWS;
+if (isset($SHOW_HELP))		$CONFIG['SHOW_HELP']		= $SHOW_HELP;
+if (isset($SHOW_HINT))		$CONFIG['SHOW_HINT']		= $SHOW_HINT;
+if (isset($SHOW_PIN))		$CONFIG['SHOW_PIN']		= $SHOW_PIN;
+if (isset($GENERATE_PASSCODE))	$CONFIG['GENERATE_PASSCODE']	= $GENERATE_PASSCODE;
+if (isset($VALID_CHARS))	$CONFIG['VALID_CHARS']		= $VALID_CHARS;
+if (isset($SHOW_BUTTONS))	$CONFIG['SHOW_BUTTONS']		= $SHOW_BUTTONS;
+
+if (isset($_SESSION['user']))
+	$CONFIG = get_config( get_user_id($_SESSION['user']), $CONFIG);
+
+function config( $par ) {
+	global $CONFIG;
+	if (! array_key_exists($par,$CONFIG)) return FALSE;
+	$value = $CONFIG[$par];
+	if ($value === "TRUE")  $value=TRUE;
+	if ($value === "FALSE") $value=FALSE;
+	return $value;
+}
+
+define('MAXTRIES',		config('MAXTRIES'));
+define('MAXDIFF',		config('MAXDIFF'));
+define('RADIUS_CONF_CLIENTS',	config('RADIUS_CONF_CLIENTS'));
+define('RADIUS_SERV_RELOAD',	config('RADIUS_SERV_RELOAD'));
+define('LOGS_ROWS',		config('LOGS_ROWS'));
+define('SHOW_HELP',		config('SHOW_HELP'));
+define('SHOW_HINT',		config('SHOW_HINT'));
+define('SHOW_PIN',		config('SHOW_PIN'));
+define('GENERATE_PASSCODE',	config('GENERATE_PASSCODE'));
+define('VALID_CHARS',		config('VALID_CHARS'));
+define('SHOW_BUTTONS',		config('SHOW_BUTTONS'));
+
+// print_r($CONFIG);
+
+
+?>
diff -Nur MOTP-AS_v0.6/HTML/INC/footer.php MOTP-AS_v0.7/HTML/INC/footer.php
--- MOTP-AS_v0.6/HTML/INC/footer.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/footer.php	2011-07-10 10:31:44.000000000 +0200
@@ -1,8 +1,8 @@
       </div>
 
 <?php
-if ( isset($help) && $SHOW_HELP ) echo help($help);
-if ( isset($hint) && $SHOW_HINT ) echo '<script type="text/javascript" src="JS/hints.js"></script>';
+if ( isset($help) && SHOW_HELP ) echo help($help);
+if ( isset($hint) && SHOW_HINT ) echo '<script type="text/javascript" src="JS/hints.js"></script>';
 ?>
 
     </div>
diff -Nur MOTP-AS_v0.6/HTML/INC/header.php MOTP-AS_v0.7/HTML/INC/header.php
--- MOTP-AS_v0.6/HTML/INC/header.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/header.php	2011-07-10 10:31:44.000000000 +0200
@@ -34,7 +34,12 @@
  <li><a href="#"><span>SYSTEM</span></a>
   <ul>
    <li><a href="/phpmyadmin/">DATABASE SYSTEM</a></li>
-   <li><a href="radclients.php">RADIUS</a></li>
+   <li><a href="#"><span>RADIUS</span></a>
+    <ul>
+     <li><a href="radclients.php">RADIUS CLIENTS</a></li>
+     <li><a href="radprofiles.php">RADIUS PROFILES</a></li>
+    </ul>
+   </li>
    <li><a href="#"><span>LOGS</span></a>
     <ul>
      <li><a href="logs.php?log=auth">AUTHENTICATION LOG</a></li>
@@ -57,13 +62,21 @@
 <?php } ?>
 
 <?php if ($role != '') { ?>
- <li><a href="self.php">SETTINGS</a></li>
+ <li><a href="#"><span>SETTINGS</span></a>
+  <ul>
+   <li><a href="self.php">USER INFO</a></li>
+   <li><a href="self.php?action=change+pin">CHANGE PIN</a></li>
+   <li><a href="self.php?action=get+client">MOTP HTML CLIENT</a></li>
+  </ul>
+ </li>
 <?php } ?>
 
 <?php if ($role != '') { ?>
  <li><a href="logout.php">LOGOUT</a></li>
 <?php } ?>
 
+ <li id="about"><a href="about.php">ABOUT</a></li>
+
 </ul>
 
 </div>
diff -Nur MOTP-AS_v0.6/HTML/INC/htmlclient.php MOTP-AS_v0.7/HTML/INC/htmlclient.php
--- MOTP-AS_v0.6/HTML/INC/htmlclient.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/htmlclient.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,59 @@
+<html><head>
+<title>Universal Mobile-OTP</title>
+<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"></head><body bgcolor="#f8f8ff" OnLoad="document.userinput.pin.focus();">
+<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=3.0; user-scalable=1;"/>
+<font face="arial">
+
+<h2>Universal Mobile-OTP</h2>
+
+<script type="text/javascript">
+
+<?php
+	include 'JS/md5.js';
+	echo "var secret = \"$SECRET\" ;";
+?>
+
+</script>
+
+<script type="text/javascript">
+
+function motp (pin, secret) {
+  var time = new Date();
+  time = time.getTime() / 1000 / 10;
+  time = Math.floor(time);
+  var otp = hex_md5( time + secret + pin );
+  document.getElementById('pin').value="";
+  return otp.substring(0,6);
+}
+
+function getOTP() {
+  var pin=document.getElementById('pin').value;
+  document.getElementById('otp').value = motp(pin,secret); 
+}
+</script>
+
+<table>
+ <tbody>
+  <form name="userinput" onsubmit="getOTP();return false;">
+    <tr><th>PIN:</th><td><input id="pin" size="4" type="password"></td><td><input type=submit value="OTP" type="button"></td></tr>
+    <tr><th>Passcode:</th><td><input id="otp" size="6" type="text"></td></tr>
+  </form>
+ </tbody>
+</table>
+<p>
+
+
+<script type="text/javascript">
+document.write("<font size=-1>(c)2011 motp.sourceforge.net - epoch: <span id=epoch></span><font size=+0><p>");
+function epoch () {
+  var time = new Date();
+  time = time.getTime() / 1000 / 10;
+  time = Math.floor(time);
+  document.getElementById('epoch').innerHTML = time;
+  setTimeout('epoch()',1000);
+}
+epoch();
+</script>
+
+</body>
+</html>
diff -Nur MOTP-AS_v0.6/HTML/INC/include.php MOTP-AS_v0.7/HTML/INC/include.php
--- MOTP-AS_v0.6/HTML/INC/include.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/include.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,7 @@
+<?php
+include 'config.php';
+include 'db_func.php';
+include 'defs.php';
+include 'types.php';
+include 'misc.php';
+?>
diff -Nur MOTP-AS_v0.6/HTML/INC/misc.php MOTP-AS_v0.7/HTML/INC/misc.php
--- MOTP-AS_v0.6/HTML/INC/misc.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/misc.php	2011-07-10 10:31:44.000000000 +0200
@@ -1,5 +1,7 @@
 <?php
 
+/* ===== error handling ===== */
+
 function debug ($string) {
 	return;
         echo "<!-- " . $string . " -->" ;
@@ -8,11 +10,19 @@
 
 function stop ($class, $string) {
 	global $bcs, $VERSION;
-	if ($string != "") echo "<div class=\"$class\">" . $string . "</div>";
+	if ($string != "") echo "<div class=\"$class message\">" . $string . "</div>";
 	include 'INC/footer.php';
 	exit;
 }
 
+function error_msg ($str = FALSE) {
+	static $error_str = "";
+	if ($str) $error_str=$str;
+	return $error_str;
+}
+
+
+/* ===== input handling ===== */
 
 function input ($string) {
 	$string = htmlspecialchars($string,ENT_QUOTES);
@@ -20,17 +30,40 @@
 	return $string;
 }
 
+function convertBytes( $value ) {
+    if ( is_numeric( $value ) ) {
+        return $value;
+    } else {
+        $value_length = strlen( $value );
+        $qty = substr( $value, 0, $value_length - 1 );
+        $unit = strtolower( substr( $value, $value_length - 1 ) );
+        switch ( $unit ) {
+            case 'k':	$qty *= 1024;		break;
+            case 'm':	$qty *= 1024*1024;	break;
+            case 'g':	$qty *= 1024*1024*1024;	break;
+        }
+        return $qty;
+    }
+}
 
 
-function device_name ($device) {
-	if ($device->name != "") return $device->name;
-	return "Device #" . $device->id;
+
+/* ===== display helpers ===== */
+
+function user_name ($user) {
+	if ($user->name == "") return $user->user;
+	return user_full($user);
 }
 
 function user_full ($user) {
 	return $user->user . " (" . $user->name . ")" ;
 }
 
+function device_name ($device) {
+	if ($device->name != "") return $device->name;
+	return "Device #" . $device->id;
+}
+
 function device_full ($device) {
 	if ($device->name == "") return "#" . $device->id;
 	return $device->name . " (" . $device->id . ")" ;
@@ -73,7 +106,9 @@
  	echo "</div>";
 }
 
-/* HTML */
+
+
+/* ===== HTML functions ===== */
 
 function bcs ( $bcs ) {
 	$str = "";
@@ -168,13 +203,29 @@
 	return "<input $attr type=\"text\" name=\"$name\" value=\"$value\" size=\"$size\">\n";
 }
 
+function input_file ($name) {
+	return "<input type=\"file\" name=\"$name\">\n";
+}
+
 function input_password ($name, $value, $size = 10) {
 	return "<input type=\"password\" name=\"$name\" value=\"$value\" size=\"$size\">\n";
 }
 
-function input_submit ($name, $value, $attr = "" ) {
-	if ($name != "") $name="name=\"$name\"";
-	return "<input $attr type=\"submit\" $name value=\"$value\">\n";
+function input_submit ($value, $img = "") {
+	if (SHOW_BUTTONS)
+		if ($img != "") return input_image($value, $img);
+	return "<input type=\"submit\" value=\"$value\" class=\"submit\">\n";
+}
+
+function input_image ($alt, $src) {
+	$src="IMG/".$src.".png";
+	return "<input type=\"image\" src=\"$src\" alt=\"$alt\" title=\"$alt\" class=\"button submit\">\n";
+}
+
+function input_area ($name, $text, $cols="", $rows="" ) {
+	if ($cols) $cols="cols=\"$cols\"";
+	if ($rows) $rows="rows=\"$rows\"";
+	return "<textarea name=\"$name\" $cols $rows>$text</textarea>";
 }
 
 function select_header ($name, $css = "") {
@@ -201,3 +252,26 @@
 	return "</div>\n";
 }
 
+function li ($type, $entries) {
+	$str = "<$type class=\"text\">";
+	switch ($type) {
+		case "ul": $li = "li"; $dt = "u";  $dd = "";   break;
+		case "ol": $li = "li"; $dt = "i";  $dd = "";   break;
+		case "dl": $li = "";   $dt = "dt"; $dd = "dd"; break;
+		default:   $li = "li"; $dt = "";   $dd = "";   break;
+	}
+	foreach ($entries as $entry) {
+		if ($li != "") $str .= "<li>";
+		if (is_array($entry)) {
+			if ( ($entry[0]!="") && ($dt!="") ) $entry[0] = "<$dt>" . $entry[0] . "</$dt>"; 
+			if ( ($entry[1]!="") && ($dd!="") ) $entry[1] = "<$dd>" . $entry[1] . "</$dd>"; 
+			$str .= $entry[0] . $entry[1];
+		} else {
+			$str .= "$entry";
+		}
+		if ($li != "") $str .= "</li>";
+	}
+	$str .= "</$type>";
+	return $str;
+}
+
diff -Nur MOTP-AS_v0.6/HTML/INC/rad_av.php MOTP-AS_v0.7/HTML/INC/rad_av.php
--- MOTP-AS_v0.6/HTML/INC/rad_av.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/rad_av.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,86 @@
+<?php
+
+function checkRadiusAVs ($user) {
+
+	// check if attributes are present
+	$avpairs = get_avpairs($user, 'C', '!' );
+	foreach ($avpairs as $avpair) {
+		$attr = strtoupper($avpair->attr);
+		$attr = str_replace ("-", "_", $attr);
+		if (! getenv($attr)) {
+			log_auth ($user, "failure", "missing RADIUS attribute: $attr" );
+			return FALSE;
+		}
+	}
+
+	// check if attribute values match	
+	$avpairs = get_avpairs($user, 'C', '=' );
+	foreach ($avpairs as $avpair) {
+		$attr = strtoupper($avpair->attr);
+		$attr = str_replace ("-", "_", $attr);
+		if ( ($value = getenv($attr)) && ($value != $avpair->value) ) {
+			log_auth ($user, "failure", "wrong value for RADIUS attribute: $attr = $avpair->value" );
+			return FALSE;
+		}
+	}
+
+	return TRUE;
+}
+
+
+function getRadiusAVs ($user) {
+	$avpairs = get_avpairs($user, 'S', '=' );
+	$avarray=array();
+	foreach ($avpairs as $avpair) {		// only send "last" value
+		$avarray[$avpair->attr] = $avpair->value;
+	}
+	$ret=""; $d="";
+	foreach (array_keys($avarray) as $key) {
+		$val = $avarray[$key];
+		if (strpos($val,' ') !== FALSE) $val="\"$val\"";
+		$ret .= $d . "$key = $val";
+		$d = ", ";
+	}
+	return $ret;
+}
+
+
+function acctRadiusAVs ($user, $acct="") {
+	$ret=""; $d="";
+	$avs=array();
+
+	// parse command line AV pairs
+	// should bei either 'acct = value' or 'acct = "a value"'
+	// all AV pairs seperated by TAB
+	$acct = trim($acct);
+	$acct = explode("\t",$acct);
+	foreach ($acct as $av) {
+		$pos = strpos( $av, '=');
+		if ($pos <= 0) continue;
+		$par = substr($av, 0, $pos-1); $par=trim($par); 
+		$val = substr($av, $pos+1);    $val=trim($val); $val=trim($val,'"');
+		$avs[$par] = $val;
+	}
+
+	// log from command line
+	$avpairs = get_avpairs($user, 'A', '!' );
+	foreach ($avpairs as $avpair) {
+		$attr = $avpair->attr;
+		if (array_key_exists($attr, $avs)) {
+			$ret .= $d . "$attr = $avs[$attr]";
+			$d = ", ";
+		}
+	}
+
+	// log as in database
+	$avpairs = get_avpairs($user, 'A', '=' );
+	foreach ($avpairs as $avpair) {
+		$ret .= $d . "$avpair->attr = $avpair->value";
+		$d = ", ";
+	}
+
+	return $ret;
+}
+
+
+?>
diff -Nur MOTP-AS_v0.6/HTML/INC/rad_save.php MOTP-AS_v0.7/HTML/INC/rad_save.php
--- MOTP-AS_v0.6/HTML/INC/rad_save.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/rad_save.php	2011-07-10 10:31:44.000000000 +0200
@@ -3,8 +3,8 @@
 
 /*** write to config file
 
-	CONFIG FILE = $RAD_CONF_CLIENTS
-	FORMAT = 
+	config file = RADIUS_CONF_CLIENTS
+	format = 
 		client 1.2.3.4 {
  			secret = client_shared_secret
  			shortname = name_from_database
@@ -14,15 +14,13 @@
 
 
 function rad_save_write () {
-	global $RADIUS_CONF_CLIENTS;
-
-	if ( !isset($RADIUS_CONF_CLIENTS) || ($RADIUS_CONF_CLIENTS == "") ) return;
+	if ( (! RADIUS_CONF_CLIENTS) || (RADIUS_CONF_CLIENTS == "") ) return;
 
 	$rclients = get_radclient_list ();
 
-	$fp = fopen ( $RADIUS_CONF_CLIENTS, "w" );
+	$fp = fopen ( RADIUS_CONF_CLIENTS, "w" );
 	if (! $fp) {
-		echo "Cannot write RADIUS client config file $RADIUS_CONF_CLIENTS !";
+		echo "Cannot write RADIUS client config file " . RADIUS_CONF_CLIENTS . "!";
 		return;
 	}
 
@@ -41,12 +39,11 @@
 
 
 function rad_save_reload () {
-	global $RADIUS_SERV_RELOAD;
 	/* reload freeradius */
 
-	if ( !isset($RADIUS_SERV_RELOAD) || ($RADIUS_SERV_RELOAD == "") ) return;
+	if ( (! RADIUS_SERV_RELOAD) || (RADIUS_SERV_RELOAD == "") ) return;
 
-	exec($RADIUS_SERV_RELOAD);
+	exec(RADIUS_SERV_RELOAD);
 }
 
 
diff -Nur MOTP-AS_v0.6/HTML/INC/types.php MOTP-AS_v0.7/HTML/INC/types.php
--- MOTP-AS_v0.6/HTML/INC/types.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/INC/types.php	2011-07-10 10:31:44.000000000 +0200
@@ -49,6 +49,15 @@
 	public $ip;
 }
 
+class Rad_Profile {
+	public $id;
+	public $match;
+	public $type;
+	public $attr;
+	public $op;
+	public $value;
+}
+
 class Log {
 	public $id;
 	public $time;
diff -Nur MOTP-AS_v0.6/HTML/index.php MOTP-AS_v0.7/HTML/index.php
--- MOTP-AS_v0.6/HTML/index.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/index.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,13 +2,11 @@
 
 include 'INC/session.php';
 
+include 'INC/include.php';
+
 $title = "MOTP-AS - Login";
 include 'INC/header.php';
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
 
 if ($role == 'U') {
 	echo '<H1>Welcome to the Mobile OTP Authentication Server</H1>';
@@ -22,6 +20,17 @@
 <H1>Welcome to the Mobile OTP Authentication Server</H1>
 
 <div class="stat">
+<div>Wizards:</div>
+<ul>
+<?php if ($role == 'A') { echo'<li><a href="wiz_firsttime.php">First time</a> configuration</li>'; } ?>
+<li><a href="wiz_quickadd.php">Quick Add</a> &ndash; add new user, device and PIN in one step</li>
+<li><a href="wiz_import.php">Import</a> a list of users/devices.</li>
+</ul>
+</div>
+
+
+
+<div class="stat">
 <div>Database contains:</div>
 <ul>
 <li><?php echo get_device_count();    ?> <a href="devices.php"   >Devices</a>
diff -Nur MOTP-AS_v0.6/HTML/JS/hints.js MOTP-AS_v0.7/HTML/JS/hints.js
--- MOTP-AS_v0.6/HTML/JS/hints.js	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/JS/hints.js	2011-07-10 10:31:44.000000000 +0200
@@ -6,6 +6,9 @@
 	+ '<![endif]-->'
 );
 
+var GOOD = "good_small.png";
+var BAD  = "bad_small.png";
+
 function activate ( id, checks, checkfunc, helptext ) {
 	var elem = document.getElementById(id);
 	html =    '<div class="hint" id="hint-' + id + '">'
@@ -62,7 +65,7 @@
 
 
 function imgurl ( img ) { 
-	return "url(/IMG/" + img + ".png)";
+	return "url(/IMG/" + img + ")";
 }
 
 
@@ -76,14 +79,14 @@
 	var checkfunc = function () {
 		var value = document.getElementById("device-secret").value;
 
-		var img = "warn";
+		var img = BAD;
 		if ( (value.length == 16) || (value.length == 32) )
-			img = "ok";
+			img = GOOD;
 		document.getElementById("s1").style.listStyleImage = imgurl(img);
 
-		var img = "warn";
+		var img = BAD;
 		if ( value.match(/^[0-9a-fA-F]*$/g) )
-			img = "ok";
+			img = GOOD;
 		document.getElementById("s2").style.listStyleImage = imgurl(img);
 	};
 	var text = '<p>The device secret normally consists of 16 hex characters. Some implementations use 32 characters.</p>'
@@ -96,22 +99,64 @@
 
 /********* account pin **********************/
 
+function weakpin (pin) {
+
+	// check for same diff between digits
+	diff=100; temp=pin;
+	while (temp>=10) {
+		last = temp % 10;
+		temp = Math.floor(temp/10);
+		before = temp % 10;
+		if (diff == 100) diff = last-before;
+		if (diff == last-before) continue;
+		diff = 100;
+		break;
+	}
+	if ( (diff>=-1) && (diff<=1) ) return "Same difference between digits";
+
+	// check typical combinations
+	if (pin == 2580) return "Typical combination";
+
+	// check xyxy combinations and palindroms
+	if (pin>=1000) {
+		left = Math.floor(pin/100);
+		right = pin % 100;
+		if (left == right) return "repeated numbers";
+		rr = 10*(right%10) + Math.floor(right/10);
+		if (left == rr) return "palindrom";
+	}
+
+	return "";
+}
+
 if (document.getElementById("account-pin")) {
 	var html = '<li id="p1">4 digits</li>'
 		 + '<li id="p2">only digits</li>'
+		 + '<li id="p3">PIN strength</li>'
 	;
 	var checkfunc = function () {
 		var value = document.getElementById("account-pin").value;
 
-		var img = "warn";
+		var img = BAD;
 		if (value.length == 4)
-			img = "ok";
+			img = GOOD;
 		document.getElementById("p1").style.listStyleImage = imgurl(img);
 
-		var img = "warn";
+		var img = BAD;
 		if ( value.match(/^[0-9]*$/g) )
-			img = "ok";
+			img = GOOD;
 		document.getElementById("p2").style.listStyleImage = imgurl(img);
+
+		text = weakpin(value);
+		if ( text != "" ) {
+			img = BAD;
+			text = "PIN weak: " + text;
+		} else {
+			img = GOOD;
+			text = "PIN strength";
+		}
+		document.getElementById("p3").style.listStyleImage = imgurl(img);
+		document.getElementById("p3").innerHTML = text;
 	};
 	var text = '<p>The default MOTP implementation uses 4 digits as PIN. A few MOTP clients support more than 4 digits.</p>'
 		 + '<p>MOTP-AS supports up to 8 characters (digits or small letters) as PIN.</p>'
@@ -140,8 +185,8 @@
 	var checkfunc = function () {
 		var value = document.getElementById("radius-ip").value;
 
-		var img = "warn";
-		if (checkip(value)) img = "ok";
+		var img = BAD;
+		if (checkip(value)) img = GOOD;
 		document.getElementById("i1").style.listStyleImage = imgurl(img);
 
 	};
@@ -165,9 +210,9 @@
 	var checkfunc = function () {
 		var value = document.getElementById("device-tz").value;
 
-		var img = "warn";
+		var img = BAD;
 		if (checktz(value)) {
-			img = "ok";
+			img = GOOD;
 		}
 		document.getElementById("t1").style.listStyleImage = imgurl(img);
 
diff -Nur MOTP-AS_v0.6/HTML/JS/md5.js MOTP-AS_v0.7/HTML/JS/md5.js
--- MOTP-AS_v0.6/HTML/JS/md5.js	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/JS/md5.js	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,380 @@
+/*
+ * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
+ * Digest Algorithm, as defined in RFC 1321.
+ * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
+ * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
+ * Distributed under the BSD License
+ * See http://pajhome.org.uk/crypt/md5 for more info.
+ */
+
+/*
+ * Configurable variables. You may need to tweak these to be compatible with
+ * the server-side, but the defaults work in most cases.
+ */
+var hexcase = 0;   /* hex output format. 0 - lowercase; 1 - uppercase        */
+var b64pad  = "";  /* base-64 pad character. "=" for strict RFC compliance   */
+
+/*
+ * These are the functions you'll usually want to call
+ * They take string arguments and return either hex or base-64 encoded strings
+ */
+function hex_md5(s)    { return rstr2hex(rstr_md5(str2rstr_utf8(s))); }
+function b64_md5(s)    { return rstr2b64(rstr_md5(str2rstr_utf8(s))); }
+function any_md5(s, e) { return rstr2any(rstr_md5(str2rstr_utf8(s)), e); }
+function hex_hmac_md5(k, d)
+  { return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
+function b64_hmac_md5(k, d)
+  { return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
+function any_hmac_md5(k, d, e)
+  { return rstr2any(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d)), e); }
+
+/*
+ * Perform a simple self-test to see if the VM is working
+ */
+function md5_vm_test()
+{
+  return hex_md5("abc").toLowerCase() == "900150983cd24fb0d6963f7d28e17f72";
+}
+
+/*
+ * Calculate the MD5 of a raw string
+ */
+function rstr_md5(s)
+{
+  return binl2rstr(binl_md5(rstr2binl(s), s.length * 8));
+}
+
+/*
+ * Calculate the HMAC-MD5, of a key and some data (raw strings)
+ */
+function rstr_hmac_md5(key, data)
+{
+  var bkey = rstr2binl(key);
+  if(bkey.length > 16) bkey = binl_md5(bkey, key.length * 8);
+
+  var ipad = Array(16), opad = Array(16);
+  for(var i = 0; i < 16; i++)
+  {
+    ipad[i] = bkey[i] ^ 0x36363636;
+    opad[i] = bkey[i] ^ 0x5C5C5C5C;
+  }
+
+  var hash = binl_md5(ipad.concat(rstr2binl(data)), 512 + data.length * 8);
+  return binl2rstr(binl_md5(opad.concat(hash), 512 + 128));
+}
+
+/*
+ * Convert a raw string to a hex string
+ */
+function rstr2hex(input)
+{
+  try { hexcase } catch(e) { hexcase=0; }
+  var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef";
+  var output = "";
+  var x;
+  for(var i = 0; i < input.length; i++)
+  {
+    x = input.charCodeAt(i);
+    output += hex_tab.charAt((x >>> 4) & 0x0F)
+           +  hex_tab.charAt( x        & 0x0F);
+  }
+  return output;
+}
+
+/*
+ * Convert a raw string to a base-64 string
+ */
+function rstr2b64(input)
+{
+  try { b64pad } catch(e) { b64pad=''; }
+  var tab = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
+  var output = "";
+  var len = input.length;
+  for(var i = 0; i < len; i += 3)
+  {
+    var triplet = (input.charCodeAt(i) << 16)
+                | (i + 1 < len ? input.charCodeAt(i+1) << 8 : 0)
+                | (i + 2 < len ? input.charCodeAt(i+2)      : 0);
+    for(var j = 0; j < 4; j++)
+    {
+      if(i * 8 + j * 6 > input.length * 8) output += b64pad;
+      else output += tab.charAt((triplet >>> 6*(3-j)) & 0x3F);
+    }
+  }
+  return output;
+}
+
+/*
+ * Convert a raw string to an arbitrary string encoding
+ */
+function rstr2any(input, encoding)
+{
+  var divisor = encoding.length;
+  var i, j, q, x, quotient;
+
+  /* Convert to an array of 16-bit big-endian values, forming the dividend */
+  var dividend = Array(Math.ceil(input.length / 2));
+  for(i = 0; i < dividend.length; i++)
+  {
+    dividend[i] = (input.charCodeAt(i * 2) << 8) | input.charCodeAt(i * 2 + 1);
+  }
+
+  /*
+   * Repeatedly perform a long division. The binary array forms the dividend,
+   * the length of the encoding is the divisor. Once computed, the quotient
+   * forms the dividend for the next step. All remainders are stored for later
+   * use.
+   */
+  var full_length = Math.ceil(input.length * 8 /
+                                    (Math.log(encoding.length) / Math.log(2)));
+  var remainders = Array(full_length);
+  for(j = 0; j < full_length; j++)
+  {
+    quotient = Array();
+    x = 0;
+    for(i = 0; i < dividend.length; i++)
+    {
+      x = (x << 16) + dividend[i];
+      q = Math.floor(x / divisor);
+      x -= q * divisor;
+      if(quotient.length > 0 || q > 0)
+        quotient[quotient.length] = q;
+    }
+    remainders[j] = x;
+    dividend = quotient;
+  }
+
+  /* Convert the remainders to the output string */
+  var output = "";
+  for(i = remainders.length - 1; i >= 0; i--)
+    output += encoding.charAt(remainders[i]);
+
+  return output;
+}
+
+/*
+ * Encode a string as utf-8.
+ * For efficiency, this assumes the input is valid utf-16.
+ */
+function str2rstr_utf8(input)
+{
+  var output = "";
+  var i = -1;
+  var x, y;
+
+  while(++i < input.length)
+  {
+    /* Decode utf-16 surrogate pairs */
+    x = input.charCodeAt(i);
+    y = i + 1 < input.length ? input.charCodeAt(i + 1) : 0;
+    if(0xD800 <= x && x <= 0xDBFF && 0xDC00 <= y && y <= 0xDFFF)
+    {
+      x = 0x10000 + ((x & 0x03FF) << 10) + (y & 0x03FF);
+      i++;
+    }
+
+    /* Encode output as utf-8 */
+    if(x <= 0x7F)
+      output += String.fromCharCode(x);
+    else if(x <= 0x7FF)
+      output += String.fromCharCode(0xC0 | ((x >>> 6 ) & 0x1F),
+                                    0x80 | ( x         & 0x3F));
+    else if(x <= 0xFFFF)
+      output += String.fromCharCode(0xE0 | ((x >>> 12) & 0x0F),
+                                    0x80 | ((x >>> 6 ) & 0x3F),
+                                    0x80 | ( x         & 0x3F));
+    else if(x <= 0x1FFFFF)
+      output += String.fromCharCode(0xF0 | ((x >>> 18) & 0x07),
+                                    0x80 | ((x >>> 12) & 0x3F),
+                                    0x80 | ((x >>> 6 ) & 0x3F),
+                                    0x80 | ( x         & 0x3F));
+  }
+  return output;
+}
+
+/*
+ * Encode a string as utf-16
+ */
+function str2rstr_utf16le(input)
+{
+  var output = "";
+  for(var i = 0; i < input.length; i++)
+    output += String.fromCharCode( input.charCodeAt(i)        & 0xFF,
+                                  (input.charCodeAt(i) >>> 8) & 0xFF);
+  return output;
+}
+
+function str2rstr_utf16be(input)
+{
+  var output = "";
+  for(var i = 0; i < input.length; i++)
+    output += String.fromCharCode((input.charCodeAt(i) >>> 8) & 0xFF,
+                                   input.charCodeAt(i)        & 0xFF);
+  return output;
+}
+
+/*
+ * Convert a raw string to an array of little-endian words
+ * Characters >255 have their high-byte silently ignored.
+ */
+function rstr2binl(input)
+{
+  var output = Array(input.length >> 2);
+  for(var i = 0; i < output.length; i++)
+    output[i] = 0;
+  for(var i = 0; i < input.length * 8; i += 8)
+    output[i>>5] |= (input.charCodeAt(i / 8) & 0xFF) << (i%32);
+  return output;
+}
+
+/*
+ * Convert an array of little-endian words to a string
+ */
+function binl2rstr(input)
+{
+  var output = "";
+  for(var i = 0; i < input.length * 32; i += 8)
+    output += String.fromCharCode((input[i>>5] >>> (i % 32)) & 0xFF);
+  return output;
+}
+
+/*
+ * Calculate the MD5 of an array of little-endian words, and a bit length.
+ */
+function binl_md5(x, len)
+{
+  /* append padding */
+  x[len >> 5] |= 0x80 << ((len) % 32);
+  x[(((len + 64) >>> 9) << 4) + 14] = len;
+
+  var a =  1732584193;
+  var b = -271733879;
+  var c = -1732584194;
+  var d =  271733878;
+
+  for(var i = 0; i < x.length; i += 16)
+  {
+    var olda = a;
+    var oldb = b;
+    var oldc = c;
+    var oldd = d;
+
+    a = md5_ff(a, b, c, d, x[i+ 0], 7 , -680876936);
+    d = md5_ff(d, a, b, c, x[i+ 1], 12, -389564586);
+    c = md5_ff(c, d, a, b, x[i+ 2], 17,  606105819);
+    b = md5_ff(b, c, d, a, x[i+ 3], 22, -1044525330);
+    a = md5_ff(a, b, c, d, x[i+ 4], 7 , -176418897);
+    d = md5_ff(d, a, b, c, x[i+ 5], 12,  1200080426);
+    c = md5_ff(c, d, a, b, x[i+ 6], 17, -1473231341);
+    b = md5_ff(b, c, d, a, x[i+ 7], 22, -45705983);
+    a = md5_ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
+    d = md5_ff(d, a, b, c, x[i+ 9], 12, -1958414417);
+    c = md5_ff(c, d, a, b, x[i+10], 17, -42063);
+    b = md5_ff(b, c, d, a, x[i+11], 22, -1990404162);
+    a = md5_ff(a, b, c, d, x[i+12], 7 ,  1804603682);
+    d = md5_ff(d, a, b, c, x[i+13], 12, -40341101);
+    c = md5_ff(c, d, a, b, x[i+14], 17, -1502002290);
+    b = md5_ff(b, c, d, a, x[i+15], 22,  1236535329);
+
+    a = md5_gg(a, b, c, d, x[i+ 1], 5 , -165796510);
+    d = md5_gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
+    c = md5_gg(c, d, a, b, x[i+11], 14,  643717713);
+    b = md5_gg(b, c, d, a, x[i+ 0], 20, -373897302);
+    a = md5_gg(a, b, c, d, x[i+ 5], 5 , -701558691);
+    d = md5_gg(d, a, b, c, x[i+10], 9 ,  38016083);
+    c = md5_gg(c, d, a, b, x[i+15], 14, -660478335);
+    b = md5_gg(b, c, d, a, x[i+ 4], 20, -405537848);
+    a = md5_gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
+    d = md5_gg(d, a, b, c, x[i+14], 9 , -1019803690);
+    c = md5_gg(c, d, a, b, x[i+ 3], 14, -187363961);
+    b = md5_gg(b, c, d, a, x[i+ 8], 20,  1163531501);
+    a = md5_gg(a, b, c, d, x[i+13], 5 , -1444681467);
+    d = md5_gg(d, a, b, c, x[i+ 2], 9 , -51403784);
+    c = md5_gg(c, d, a, b, x[i+ 7], 14,  1735328473);
+    b = md5_gg(b, c, d, a, x[i+12], 20, -1926607734);
+
+    a = md5_hh(a, b, c, d, x[i+ 5], 4 , -378558);
+    d = md5_hh(d, a, b, c, x[i+ 8], 11, -2022574463);
+    c = md5_hh(c, d, a, b, x[i+11], 16,  1839030562);
+    b = md5_hh(b, c, d, a, x[i+14], 23, -35309556);
+    a = md5_hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
+    d = md5_hh(d, a, b, c, x[i+ 4], 11,  1272893353);
+    c = md5_hh(c, d, a, b, x[i+ 7], 16, -155497632);
+    b = md5_hh(b, c, d, a, x[i+10], 23, -1094730640);
+    a = md5_hh(a, b, c, d, x[i+13], 4 ,  681279174);
+    d = md5_hh(d, a, b, c, x[i+ 0], 11, -358537222);
+    c = md5_hh(c, d, a, b, x[i+ 3], 16, -722521979);
+    b = md5_hh(b, c, d, a, x[i+ 6], 23,  76029189);
+    a = md5_hh(a, b, c, d, x[i+ 9], 4 , -640364487);
+    d = md5_hh(d, a, b, c, x[i+12], 11, -421815835);
+    c = md5_hh(c, d, a, b, x[i+15], 16,  530742520);
+    b = md5_hh(b, c, d, a, x[i+ 2], 23, -995338651);
+
+    a = md5_ii(a, b, c, d, x[i+ 0], 6 , -198630844);
+    d = md5_ii(d, a, b, c, x[i+ 7], 10,  1126891415);
+    c = md5_ii(c, d, a, b, x[i+14], 15, -1416354905);
+    b = md5_ii(b, c, d, a, x[i+ 5], 21, -57434055);
+    a = md5_ii(a, b, c, d, x[i+12], 6 ,  1700485571);
+    d = md5_ii(d, a, b, c, x[i+ 3], 10, -1894986606);
+    c = md5_ii(c, d, a, b, x[i+10], 15, -1051523);
+    b = md5_ii(b, c, d, a, x[i+ 1], 21, -2054922799);
+    a = md5_ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
+    d = md5_ii(d, a, b, c, x[i+15], 10, -30611744);
+    c = md5_ii(c, d, a, b, x[i+ 6], 15, -1560198380);
+    b = md5_ii(b, c, d, a, x[i+13], 21,  1309151649);
+    a = md5_ii(a, b, c, d, x[i+ 4], 6 , -145523070);
+    d = md5_ii(d, a, b, c, x[i+11], 10, -1120210379);
+    c = md5_ii(c, d, a, b, x[i+ 2], 15,  718787259);
+    b = md5_ii(b, c, d, a, x[i+ 9], 21, -343485551);
+
+    a = safe_add(a, olda);
+    b = safe_add(b, oldb);
+    c = safe_add(c, oldc);
+    d = safe_add(d, oldd);
+  }
+  return Array(a, b, c, d);
+}
+
+/*
+ * These functions implement the four basic operations the algorithm uses.
+ */
+function md5_cmn(q, a, b, x, s, t)
+{
+  return safe_add(bit_rol(safe_add(safe_add(a, q), safe_add(x, t)), s),b);
+}
+function md5_ff(a, b, c, d, x, s, t)
+{
+  return md5_cmn((b & c) | ((~b) & d), a, b, x, s, t);
+}
+function md5_gg(a, b, c, d, x, s, t)
+{
+  return md5_cmn((b & d) | (c & (~d)), a, b, x, s, t);
+}
+function md5_hh(a, b, c, d, x, s, t)
+{
+  return md5_cmn(b ^ c ^ d, a, b, x, s, t);
+}
+function md5_ii(a, b, c, d, x, s, t)
+{
+  return md5_cmn(c ^ (b | (~d)), a, b, x, s, t);
+}
+
+/*
+ * Add integers, wrapping at 2^32. This uses 16-bit operations internally
+ * to work around bugs in some JS interpreters.
+ */
+function safe_add(x, y)
+{
+  var lsw = (x & 0xFFFF) + (y & 0xFFFF);
+  var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
+  return (msw << 16) | (lsw & 0xFFFF);
+}
+
+/*
+ * Bitwise rotate a 32-bit number to the left.
+ */
+function bit_rol(num, cnt)
+{
+  return (num << cnt) | (num >>> (32 - cnt));
+}
+
diff -Nur MOTP-AS_v0.6/HTML/login.php MOTP-AS_v0.7/HTML/login.php
--- MOTP-AS_v0.6/HTML/login.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/login.php	2011-07-10 10:31:44.000000000 +0200
@@ -49,7 +49,7 @@
 echo form_header("post", "login.php");
 echo table_row ( array ("Username:", input_text("username","")), "0");
 echo table_row ( array ("Password:", input_password("password","")), "0");
-echo table_row ( input_submit("","Login","id=\"submit\""), "2");
+echo table_row ( '<input type="submit" value="Login" id="submit">', "2");
 echo form_footer();
 echo table_footer();
 echo div_footer(); 
diff -Nur MOTP-AS_v0.6/HTML/logout.php MOTP-AS_v0.7/HTML/logout.php
--- MOTP-AS_v0.6/HTML/logout.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/logout.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,8 +2,7 @@
 
 include 'INC/session.php';
 
-include 'INC/config.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 log_audit($_SESSION['user'],"logout","");
 
 $_SESSION['role']=''; unset($_SESSION['role']);
diff -Nur MOTP-AS_v0.6/HTML/logs.php MOTP-AS_v0.7/HTML/logs.php
--- MOTP-AS_v0.6/HTML/logs.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/logs.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,10 +2,7 @@
 
 include 'INC/session.php'; checkrole("A","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 $title = "MOTP-AS - Logs";
 include 'INC/header.php';
@@ -33,7 +30,7 @@
 $to="<a href=\"javascript:NewCssCal('to','yyyyMMdd','Arrow','true','24','true')\"><img src=\"IMG/cal.gif\"></a>";
 
 
-echo form_header( "get",  "logs.php" ); 
+echo form_header( "GET",  "logs.php" ); 
 echo input_hidden ( "log", $log );
 echo table_header( array( "Time", "User", "Type", "Message" ), "list" );
 
@@ -42,7 +39,7 @@
 	input_text ("user", $search->user, 10), 
 	input_text ("type", $search->type, 15), 
 	input_text ("message", $search->message, 30), 
-	input_submit ("", "Search")
+	input_submit ("Search","search")
 ) );
 
 $logs = get_logs ($log, $search, $start, $end);
@@ -70,15 +67,15 @@
 $nav .= navlink ("<<", 0, $search->id > 0);
 $nav .= " ";
 
-$nav .= navlink ("&nbsp;<&nbsp;", $search->id - $LOGS_ROWS, $search->id >= $LOGS_ROWS);
+$nav .= navlink ("&nbsp;<&nbsp;", $search->id - LOGS_ROWS, $search->id >= LOGS_ROWS);
 $nav .= " ";
 
-$nav .= " " . intval($search->id / $LOGS_ROWS)+1 . " / " . ceil($count / $LOGS_ROWS) . " ";
+$nav .= " " . intval($search->id / LOGS_ROWS)+1 . " / " . ceil($count / LOGS_ROWS) . " ";
 
-$nav .= navlink ("&nbsp;>&nbsp;", $search->id + $LOGS_ROWS, ($nr == $LOGS_ROWS) && ($search->id + $LOGS_ROWS < $count) );
+$nav .= navlink ("&nbsp;>&nbsp;", $search->id + LOGS_ROWS, ($nr == LOGS_ROWS) && ($search->id + LOGS_ROWS < $count) );
 $nav .= " ";
 
-$nav .= navlink (">>", floor($count / $LOGS_ROWS) * $LOGS_ROWS, intval($search->id / $LOGS_ROWS)+1 < ceil($count / $LOGS_ROWS) );
+$nav .= navlink (">>", floor( ($count-1) / LOGS_ROWS) * LOGS_ROWS, intval($search->id / LOGS_ROWS)+1 < ceil($count / LOGS_ROWS) );
 
 echo "<div id=\"nav\">" . $nav . "</div>";
 
diff -Nur MOTP-AS_v0.6/HTML/radclient.php MOTP-AS_v0.7/HTML/radclient.php
--- MOTP-AS_v0.6/HTML/radclient.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/radclient.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,19 +2,17 @@
 
 include 'INC/session.php'; checkrole("A","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
+
 include 'INC/rad_save.php';
 
-if (isset($_GET['action'])) $action=input($_GET['action']); else $action="";
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
 if (isset($_GET['client'])) $clientid=input($_GET['client']); else $clientid=0;
 
 $title = "MOTP-AS - RADIUS clients";
 include 'INC/header.php';
 
-$bcs = array ( array("index.php","home"), array("radclients.php","Radius") );
+$bcs = array ( array("index.php","home"), array("radclients.php","RADIUS clients") );
 
 $client=get_radclient($clientid);
 
@@ -50,7 +48,7 @@
 
 	if ($clientid==0) {
 		$client=insert_radclient ($client);
-		if (! $client) stop("error", "Could not add client. Possible reasons: no name given, name already existing, no IP address, duplicate IP address.");
+		if (! $client) stop("error", "Could not add client: " . error_msg() );
 		$clientid=$client->id;
 		log_audit($_SESSION['user'],"radclient add","Client: $client->name ($client->ip)");
 	} else {
@@ -65,7 +63,8 @@
 
 if ( ($action == "add") || ($action == "edit") ) {
 
-	echo form_header("post",  "radclient.php?client=" . $clientid . "&action=insert");
+	echo form_header("POST",  "radclient.php?client=$clientid");
+	echo input_hidden("action","insert");
 
 	echo table_header( FALSE, "edit");
 
@@ -75,7 +74,7 @@
 
 	echo table_footer();
 
-	echo input_submit("", "Ok");
+	echo input_submit("Ok","send");
 	echo form_footer();
 
 	if ($action=="edit") $bcs[3]=array("radclient.php?client=$clientid","$client->name");
@@ -96,13 +95,10 @@
 	echo table_row( array( "IP:",     $client->ip) );
 	echo table_footer(); 
 
-	echo form_header("get", "radclient.php");
-	echo input_hidden("client", $clientid );
-	echo input_submit("action", "disable");
-	echo input_submit("action", "enable"); echo br();
-	echo input_submit("action", "edit");
-	echo input_submit("action", "delete");
-	echo form_footer();
+	echo form_header("POST", "radclient.php?client=$clientid") . input_hidden("action", "disable") . input_submit("Disable","lock")  . form_footer();
+	echo form_header("POST", "radclient.php?client=$clientid") . input_hidden("action", "enable")  . input_submit("Enable","reset")  . form_footer();
+	echo form_header("POST", "radclient.php?client=$clientid") . input_hidden("action", "edit")    . input_submit("Edit","edit")     . form_footer();
+	echo form_header("POST", "radclient.php?client=$clientid") . input_hidden("action", "delete")  . input_submit("Delete","delete") . form_footer();
 
 	$bcs[3]=array("radclient.php?client=$clientid","$client->name");
 
diff -Nur MOTP-AS_v0.6/HTML/radclients.php MOTP-AS_v0.7/HTML/radclients.php
--- MOTP-AS_v0.6/HTML/radclients.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/radclients.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,22 +2,19 @@
 
 include 'INC/session.php'; checkrole("A","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 $title = "MOTP-AS - RADIUS clients";
 include 'INC/header.php';
 
-$bcs = array ( array("index.php","home"), array("radclients.php","RADIUS") );
+$bcs = array ( array("index.php","home"), array("radclients.php","RADIUS clients") );
 
 
-if (isset($_GET['name_filter'])) { $name_filter = input($_GET['name_filter']); } else { $name_filter=""; }
+if (isset($_POST['name_filter'])) { $name_filter = input($_POST['name_filter']); } else { $name_filter=""; }
 
 
 
-echo form_header("get", "radclients.php");
+echo form_header("POST", "radclients.php");
 
 echo table_header( array ("Name", "Secret", "IP", "Status" ), "list" );
 
@@ -26,7 +23,7 @@
 	' ',
 	' ',
 	' ',
-	input_submit ("", "Search")
+	input_submit ("Search","search")
 ) );
 
 
@@ -46,9 +43,9 @@
 echo form_footer();
 
 
-echo form_header("get", "radclient.php");
+echo form_header("POST", "radclient.php");
 echo input_hidden("action", "add");
-echo input_submit("", "Add new RADIUS client");
+echo input_submit("Add new RADIUS client","add");
 echo form_footer();
 
 
diff -Nur MOTP-AS_v0.6/HTML/radius-acct.php MOTP-AS_v0.7/HTML/radius-acct.php
--- MOTP-AS_v0.6/HTML/radius-acct.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/radius-acct.php	2011-07-10 10:31:44.000000000 +0200
@@ -1,18 +1,22 @@
 <?php
 
-require 'INC/config.php';
-require 'INC/misc.php';
-require 'INC/db_func.php';
+if ($argc < 3) exit(1);
+
+require 'INC/include.php';
+include 'INC/rad_av.php';
 
 $user = input($argv[1]);
 $type = input($argv[2]);
 
 $acct=""; $app="";
 for ($i=3; $i<$argc; $i++) {
-	$acct .= $app . input ($argv[$i]);
+	// $acct .= $app . input ($argv[$i]);
+	$acct .= $app . $argv[$i];
 	$app = " ";
 }
 
+$acct = acctRadiusAVs($user, $acct);
+
 log_acc ($user, $type, $acct);
 
 echo "logged";
diff -Nur MOTP-AS_v0.6/HTML/radius-auth.php MOTP-AS_v0.7/HTML/radius-auth.php
--- MOTP-AS_v0.6/HTML/radius-auth.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/radius-auth.php	2011-07-10 10:31:44.000000000 +0200
@@ -1,15 +1,25 @@
 <?php
 
+if ($argc != 4) exit(1);
+
 require 'auth.php';
+include 'INC/rad_av.php';
+
+$user      = input($argv[1]);
+$passcode  = input($argv[2]);
+$radclient = input($argv[3]);
+
+if (! checkRadiusAVs($user)) {
+	exit(1);	// fail
+}
 
-$result = checkPassword($argv[1],$argv[2],$argv[3]);
+$result = checkPassword($user,$passcode,$radclient);
 
 if ($result) {
-	echo "ACCEPT\n";
-	$ret=0;
+	echo getRadiusAVs($user);
+	$ret=0;		// accept
 } else {
-	echo "FAIL\n";
-	$ret=1;
+	$ret=1;		// fail
 }
 
 exit($ret); 
diff -Nur MOTP-AS_v0.6/HTML/radius-client.php MOTP-AS_v0.7/HTML/radius-client.php
--- MOTP-AS_v0.6/HTML/radius-client.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/radius-client.php	2011-07-10 10:31:44.000000000 +0200
@@ -1,8 +1,8 @@
 <?php
 
-require 'INC/config.php';
-require 'INC/misc.php';
-require 'INC/db_func.php';
+if ($argc != 3) exit(1);
+
+require 'INC/include.php';
 
 $value = input($argv[1]);
 $clientip = input($argv[2]);
diff -Nur MOTP-AS_v0.6/HTML/radprofile.php MOTP-AS_v0.7/HTML/radprofile.php
--- MOTP-AS_v0.6/HTML/radprofile.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/radprofile.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,118 @@
+<?php
+
+include 'INC/session.php'; checkrole("A","index.php");
+
+include 'INC/include.php';
+
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
+if (isset($_GET['profile'])) $profileid=input($_GET['profile']); else $profileid=0;
+
+$title = "MOTP-AS - RADIUS profiles";
+include 'INC/header.php';
+
+$bcs = array ( array("index.php","home"), array("radprofiles.php","RADIUS profiles") );
+
+$profile=get_radprofile($profileid);
+
+if (! $profile) $profile = new Rad_Profile();
+
+
+if ($action == "delete") {
+	delete_radprofile ($profile);
+	log_audit($_SESSION['user'],"radprofile delete","$profile->type: $profile->attr $profile->op $profile->value");
+	stop("ok","RADIUS profile deleted");
+}
+
+if ($action == "insert") {
+	if (isset($_POST['match'])) $profile->match = $_POST['match'];
+	if (isset($_POST['type']))  $profile->type  = $_POST['type'];
+	if (isset($_POST['attr']))  $profile->attr  = $_POST['attr'];
+	if (isset($_POST['op']))    $profile->op    = $_POST['op'];
+	if (isset($_POST['value'])) $profile->value = $_POST['value'];
+
+	if ($profileid==0) {
+		$profile=insert_radprofile ($profile);
+		if (! $profile) stop("error", "Could not add profile.");
+		$profileid=$profile->id;
+		log_audit($_SESSION['user'],"radprofile add","$profile->type: $profile->attr $profile->op $profile->value");
+	} else {
+		update_radprofile ($profile);
+		log_audit($_SESSION['user'],"radprofile modify","$profile->type: $profile->attr $profile->op $profile->value");
+	}
+	$bcs[3]=array("radprofile.php?profile=$profileid","$profile->attr $profile->op $profile->value");
+}
+
+
+if ( ($action == "add") || ($action == "edit") ) {
+
+	echo form_header("POST",  "radprofile.php?profile=$profileid");
+	echo input_hidden("action","insert");
+
+	echo table_header( FALSE, "edit");
+
+	if (isset($_POST['op']))    $profile->op    = $_POST['op'];
+
+	echo table_row( array( "Match: ",     input_text("match", $profile->match, 15)  ) ) ;
+	$select = select_header("type");
+	foreach (array_keys($RAD_PROF_TYPES) as $key) {
+		$select .= select_option($key, $RAD_PROF_TYPES[$key], $profile->type == $key );
+	}
+	$select .= select_footer();
+	echo table_row( array ("Type", $select) );
+	echo table_row( array( "Attribute: ", input_text("attr",  $profile->attr,  15)  ) ) ;
+	$select = select_header("op");
+	foreach (array_keys($RAD_PROF_OPS) as $key) {
+		$select .= select_option($key, $RAD_PROF_OPS[$key], $profile->op == $key );
+	}
+	$select .= select_footer();
+	echo table_row( array ("Operand", $select) );
+	echo table_row( array( "Value: ",     input_text("value", $profile->value, 15)  ) ) ;
+
+	echo table_footer();
+
+	echo input_submit("Ok","send");
+	echo form_footer();
+
+	if ($action=="edit")
+		$bcs[3]=array("radprofile.php?profile=$profileid","$profile->attr $profile->op $profile->value");
+
+        $help   = p("match = For matching usernames, keep empty for all users.")
+                . p("type = "
+			. li("ul",array(
+				array("check"," - Checking of attributes before authentication"),
+				array("send"," - Sending of attributes after successful authentication"),
+				array("acct"," - Accounting")
+			))
+		   )
+                . p("attribute = attribute name (case sensitive!)")
+                . p("op = " 
+			. li("ul",array(
+				array("equal (=)"," - if attribute matches value"),
+				array("exist (!)"," - if attribute is set")
+			))
+		   )
+                . p("value = attribute value, can be empty")
+                ;
+
+} else {
+	/* show data */
+
+	echo table_header(FALSE,"show");
+	echo table_row( array( "Match:",     $profile->match) ); 
+	echo table_row( array( "Type:",      $RAD_PROF_TYPES[$profile->type] . " ($profile->type)" ) );
+	echo table_row( array( "Attribute:", $profile->attr) ); 
+	echo table_row( array( "Operator:",  $RAD_PROF_OPS[$profile->op] . " ($profile->op)" ) );
+	echo table_row( array( "Value:",     $profile->value) ); 
+	echo table_footer(); 
+
+	echo form_header("POST","radprofile.php?profile=$profileid") . input_hidden("action", "edit")   . input_submit("Edit","edit") . form_footer();
+	echo form_header("POST","radprofile.php?profile=$profileid") . input_hidden("action", "delete") . input_submit("Delete","delete") . form_footer();
+
+	$bcs[3]=array("radprofile.php?profile=$profileid","$profile->attr $profile->op $profile->value");
+
+}
+
+
+include 'INC/footer.php';
+
+?>
diff -Nur MOTP-AS_v0.6/HTML/radprofiles.php MOTP-AS_v0.7/HTML/radprofiles.php
--- MOTP-AS_v0.6/HTML/radprofiles.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/radprofiles.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,62 @@
+<?php
+
+include 'INC/session.php'; checkrole("A","index.php");
+
+include 'INC/include.php';
+
+$title = "MOTP-AS - RADIUS profiles";
+include 'INC/header.php';
+
+$bcs = array ( array("index.php","home"), array("radprofiles.php","RADIUS profiles") );
+
+
+if (isset($_POST['match_filter'])) { $match_filter = input($_POST['match_filter']); } else { $match_filter=""; }
+if (isset($_POST['type_filter']))  { $type_filter  = input($_POST['type_filter']);  } else { $type_filter=""; }
+if (isset($_POST['attr_filter']))  { $attr_filter  = input($_POST['attr_filter']);  } else { $attr_filter=""; }
+
+
+echo form_header("POST", "radprofiles.php");
+
+echo table_header( array ("Match", "Type", "Attribute", "Operator", "Value" ), "list" );
+
+$select = select_header("type_filter","width:35px;");
+$select .= select_option('','');
+foreach (array_keys($RAD_PROF_TYPES) as $key) 
+        $select .= select_option($key, "$key ($RAD_PROF_TYPES[$key])", "$type_filter"=="$key");
+$select .= select_footer();
+
+echo table_row ( array (
+	input_text ("match_filter", $match_filter ),
+	$select,
+	input_text ("attr_filter", $attr_filter ),
+	' ',
+	' ',
+	input_submit ("Search","search")
+) );
+
+
+$profiles = get_radprofile_list ($match_filter, $type_filter, $attr_filter);
+
+foreach ( $profiles as $profile ) {
+	echo table_row ( array (
+		$profile->match ,
+		$profile->type ,
+		a("radprofile.php?profile=$profile->id", $profile->attr) ,
+		$profile->op ,
+		a("radprofile.php?profile=$profile->id", $profile->value) ,
+	) );
+}
+
+echo table_footer();
+echo form_footer();
+
+
+echo form_header("POST", "radprofile.php");
+echo input_hidden("action", "add");
+echo input_submit("Add new RADIUS profile","add");
+echo form_footer();
+
+
+include 'INC/footer.php';
+
+?>
diff -Nur MOTP-AS_v0.6/HTML/self.php MOTP-AS_v0.7/HTML/self.php
--- MOTP-AS_v0.6/HTML/self.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/self.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,17 +2,16 @@
 
 include 'INC/session.php';
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 $title = "MOTP-AS - Settings";
 include 'INC/header.php';
 
-if (isset($_GET['action'])) $action=input($_GET['action']); else $action="";
+$action="";
+if (isset($_GET['action']))  $action=input($_GET['action']); 	// for direct links
+if (isset($_POST['action'])) $action=input($_POST['action']); 
 
-$bcs = array ( array("index.php","home"), array("self.php","Settings") );
+$bcs = array ( array("index.php","home"), array("self.php","User Info") );
 
 $userid  = get_user_id($_SESSION['user']);
 if ($userid == 0) 
@@ -37,6 +36,7 @@
 		stop("error","permission denied.");
 	}
 	if ($account->pin != $oldpin) {
+		$bcs = array ( array("index.php","home"), array("self.php?action=change+pin","Change PIN") );
 		stop("warning","wrong pin");
 	} else {
 		$account->pin = $newpin;
@@ -52,7 +52,8 @@
 		stop("warning","You have no account, sorry.");
 	}
 
-	echo form_header("post", "self.php?action=set+pin");
+	echo form_header("POST", "self.php");
+	echo input_hidden("action","set pin");
 
 	echo table_header(FALSE, "edit");
 
@@ -66,10 +67,38 @@
 	echo table_row( array( "New PIN: ", input_text("newpin", "", 4, 'id="account-pin"') ) );
 	echo table_footer();
 
-	echo input_submit("", "Ok");
+	echo input_submit("Ok");
 	echo form_footer();
 
 	$hint = TRUE;
+	$bcs = array ( array("index.php","home"), array("self.php?action=change+pin","Change PIN") );
+
+} else if ($action == "get client") {
+
+        if ($accounts == array() ) {
+                stop("warning","You have no account, sorry.");
+        }
+
+        echo form_header("POST\" target=\"_blank", "client.php");
+
+        echo table_header(FALSE, "edit");
+
+        $select = select_header("account");
+        foreach ($accounts as $account)
+                $select .= select_option($account->id, device_name(get_device($account->deviceid)) );
+        $select .= select_footer();
+        echo table_row( array( "Device: ", $select) );
+
+        echo table_footer();
+
+        echo input_submit("Open HTML client");
+        echo form_footer();
+
+	$bcs = array ( array("index.php","home"), array("self.php?action=get+client","HTML client") );
+
+	$help   = p("Please be aware, that secret is stored in HTML client in clear text!")
+                ;
+
 
 } else {
 	/* show user data */
@@ -85,16 +114,17 @@
 		$devlist .= device_name($device) . " "; 
 	echo table_row( array(
 		"Status:",
-		( (! $user->enabled) ? "locked" : ( ($user->tries > $MAXTRIES) ? "locked" : "active" ) ) . br()
-		. "$user->tries/$MAXTRIES failed logins" . br()
+		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked" : "active" ) ) . br()
+		. "$user->tries/" . MAXTRIES . " failed logins" . br()
 		. "last login: " . ( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" ) . br() 
 		. "Devices: " . $devlist
 	) );
 
 	echo table_footer();
 
-	echo form_header("get", "self.php");
-	echo input_submit("action", "change pin");
+	echo form_header("POST", "self.php");
+	echo input_hidden("action","change pin");
+	echo input_submit("Change pin");
 	echo form_footer();
 }
 
diff -Nur MOTP-AS_v0.6/HTML/static.php MOTP-AS_v0.7/HTML/static.php
--- MOTP-AS_v0.6/HTML/static.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/static.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,10 +2,7 @@
 
 include 'INC/session.php'; checkrole("AH","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 
 if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
@@ -29,13 +26,13 @@
 	$static->howoften = -1;
 }
 
-if ($action == "Delete") {
+if ($action == "delete") {
 	delete_static ($userid);
 	log_audit($_SESSION['user'],"static delete","User: $user->user ($user->name)");
 	stop("ok","Static password deleted");
 }
 
-if ($action == "Ok") {
+if ($action == "set") {
 	if (isset($_POST['password'])) $password = input($_POST['password']);
 	if (isset($_POST['until']))    $static->until    = input($_POST['until']);
 	if (isset($_POST['howoften'])) $static->howoften = input($_POST['howoften']);
@@ -50,27 +47,33 @@
 
 	set_static ($static);
 	log_audit($_SESSION['user'],"static password set","User: $user->user ($user->name); Until: $static->until; Howoften: $static->howoften");
-	$msg="Set static password.";
-	if ( ($static->until==0) && ($static->howoften==-1) )
+	$msg="Static Password set."; $status="ok";
+	if ( ($static->until==0) && ($static->howoften==-1) ) {
 		$msg="Please note, that user must have a limitation (time range or number of allowed logins) to use static password for RADIUS authentication!" .br(). "Without limitations, the static password can only be used for login to Web Administration.";
-	stop("ok",$msg);
+		$status="warning";
+	}
+	stop($status,$msg);
 }
 
 echo '<script type="text/javascript" src="JS/datetimepicker_css.js"></script>';
 $cal="<a href=\"javascript:NewCssCal('cal','yyyyMMdd','Arrow','true','24','true')\"><img src=\"IMG/cal.gif\"></a>";
 
-echo form_header("post", "static.php?user=" . $userid );
-
+echo form_header("POST", "static.php?user=" . $userid );
+echo input_hidden("action","set");
 echo table_header( FALSE, "edit");
 echo table_row( array( "Password", input_text("password", "") ) ) ;
 echo table_row( array( "Valid until", input_text("until", ($static->until==0) ? "unlimited" : $static->until , 14, "id=\"cal\"" ) . $cal ) ) ;
 echo table_row( array( "Valid for ", input_text("howoften", ($static->howoften<0) ? "unlimited" : $static->howoften ) . "logins") ) ;
 echo table_footer();
+echo input_submit("Ok","send");
+echo form_footer();
 
-echo input_submit("action", "Ok");
-echo input_submit("action", "Delete");
+echo form_header("POST", "static.php?user=" . $userid );
+echo input_hidden("action","delete");
+echo input_submit("Delete","delete");
 echo form_footer();
 
+
 $help   = p("You can set a (temporary) static password. The usage of the password can be limited:") 
         . p("valid until = the static password is only valid until the given date and time. This is useful, if your users forgiot or lost their device and they need access for one day.")
         . p("valid for = the static password is only valid for the given number of logins. This is useful, if you want to allow login with a temporary password for example exactly one time.")
diff -Nur MOTP-AS_v0.6/HTML/sync.php MOTP-AS_v0.7/HTML/sync.php
--- MOTP-AS_v0.6/HTML/sync.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/sync.php	2011-07-10 10:31:44.000000000 +0200
@@ -29,12 +29,12 @@
 
 
 
-if ($action == "Sync") {
+if ($action == "sync") {
 	if (isset($_POST['epoch']))    $epoch    = input($_POST['epoch']);
 	if (isset($_POST['passcode'])) $passcode = input($_POST['passcode']);
 
 	if ( ($epoch == "") && ($passcode == "") ) {
-		stop("ok","Please specify either epoch time or passcode.");
+		stop("warning","Please specify either epoch time or passcode.");
 	}
 
 	$now = gmdate("U");
@@ -50,7 +50,7 @@
 		$maxdiff = 60 * 30; 	// 30 minutes
 		$pin = "1111";
 		$time = checkPasscode ($passcode, $pin, $device->secret, $device->timezone, $device->offset, $now , $maxdiff);
-		if ($time<0) stop("ok","Cannot sync device, please retry with device's epoch time.");
+		if ($time<0) stop("warning","Cannot sync device, please retry with device's epoch time.");
 		$now = intval($now/10);
 		$diff = $time - $now;
 		$device->lasttime = $time;
@@ -60,7 +60,8 @@
 	$device->timezone = round($diff/360);
 	$device->offset = 10 * ($diff - ($device->timezone * 360));
 
-	update_device($device);
+	$status = update_device($device);
+	if (! $status) stop("error","Could not update device");
 	log_audit($_SESSION['user'],"device synced","Device: $device->id ($device->name); Timezone: $device->timezone, Offset: $device->offset");
 
 	stop("ok","Device synced. Timezone: $device->timezone, Offset: $device->offset");
@@ -68,14 +69,15 @@
 
 
 
-echo form_header("post", "sync.php?device=" . $devid );
+echo form_header("POST", "sync.php?device=" . $devid );
 
 echo table_header( FALSE, "edit");
 echo table_row( array( "Epoch", input_text("epoch", "") ) ) ;
 echo table_row( array( "Passcode", input_text("passcode", "") ) ) ;
 echo table_footer();
 
-echo input_submit("action", "Sync");
+echo input_hidden("action","sync");
+echo input_submit("Sync");
 echo form_footer();
 
 $help   = p("To sync the device, there are two possibilites:") 
diff -Nur MOTP-AS_v0.6/HTML/user.php MOTP-AS_v0.7/HTML/user.php
--- MOTP-AS_v0.6/HTML/user.php	2010-11-23 23:05:34.000000000 +0100
+++ MOTP-AS_v0.7/HTML/user.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,14 +2,11 @@
 
 include 'INC/session.php'; checkrole("AH","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 
-if (isset($_GET['action'])) $action=input($_GET['action']); else $action="";
-if (isset($_GET['user']))   $userid=input($_GET['user']);   else $userid=0;
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
+if (isset($_GET['user'])) $userid=input($_GET['user']); else $userid=0;
 
 if ($action == "static password") {
 	header("Location: static.php?user=$userid");
@@ -62,7 +59,7 @@
 
 	if ($userid==0) {
 		$user=insert_user ($user);
-		if (! $user) stop("error", "Could not add user. Possible reasons: duplicate or empty user value.");
+		if (! $user) stop("error", "Could not add user: " . error_msg() );
 		$userid=$user->id;
 		$bcs[3]=array("user.php?user=$userid","$user->user");
 		log_audit($_SESSION['user'],"user add","User: $user->user ($user->name)");
@@ -75,7 +72,8 @@
 
 if ( ($action == "add") || ($action == "edit") ) {
 
-	echo form_header("post", "user.php?user=" . $userid . "&action=insert");
+	echo form_header("POST", "user.php?user=$userid");
+	echo input_hidden("action","insert");
 
 	echo table_header( FALSE, "edit");
 	echo table_row( array( "User", input_text("user", $user->user) ) ) . br() ;
@@ -90,12 +88,18 @@
 
 	echo table_footer();
 
-	echo input_submit("", "Ok");
+	echo input_submit("Ok","send");
 	echo form_footer();
 
         $help   = p("user = login name (used for authentication)") 
                 . p("name = full name, can be left empty")
-                . p("role = <br /><br />Administrator:<br />full access to web interface, including RADIUS settings<br /><br />Helpdesk:<br />can manage accounts for users, no access to settings of administrators or other helpdesk users, no access to RADIUS settings<br /><br />User:<br />Normal user, only access to \"Self Portal\" to change PIN")
+                . p("role = "
+		     . li("ul", array(
+			array("Administrator",": full access to web interface, including RADIUS settings"),
+			array("Helpdesk",": can manage accounts for users, no access to settings of administrators or other helpdesk users, no access to RADIUS settings"),
+			array("User",": Normal user, only access to \"Self Portal\" to change PIN")
+		       ) )
+		)
                 ;
 
 } else {
@@ -108,8 +112,8 @@
 	echo table_row( array ( "Name:"	, $user->name ) );
 	echo table_row( array ( "Role:"	, $ROLES[$user->role] ) );
 	echo table_row( array ( "Status:", 
-		( (! $user->enabled) ? "locked" : ( ($user->tries > $MAXTRIES) ? "locked" : "active" ) )
-		. br() . "$user->tries/$MAXTRIES failed logins"
+		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked" : "active" ) )
+		. br() . "$user->tries/" . MAXTRIES . " failed logins"
 		. br() . "last login: " . ( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" )
 	) );
 
@@ -123,14 +127,11 @@
 	echo table_footer();
 
 
-	echo form_header("get", "user.php");
-	echo input_hidden("user", $userid);
-	echo input_submit("action", "lock");
-	echo input_submit("action", "reset"); echo br();
-	echo input_submit("action", "edit");
-	echo input_submit("action", "delete"); echo br();
-	echo input_submit("action", "static password");
-	echo form_footer();
+	echo form_header("POST", "user.php?user=$userid") . input_hidden("action", "lock")   . input_submit("Lock", "lock")     . form_footer();
+	echo form_header("POST", "user.php?user=$userid") . input_hidden("action", "reset")  . input_submit("Reset", "reset")   . form_footer();
+	echo form_header("POST", "user.php?user=$userid") . input_hidden("action", "edit")   . input_submit("Edit", "edit")     . form_footer();
+	echo form_header("POST", "user.php?user=$userid") . input_hidden("action", "delete") . input_submit("Delete", "delete") . form_footer();
+	echo form_header("POST", "user.php?user=$userid") . input_hidden("action", "static password") . input_submit("Set Static Password") . form_footer();
 
         $help   = p("lock = lock user; authentication with this user is no longer possible") 
                 . p("reset = unlock user, if locked, and reset number of failed logins.")
diff -Nur MOTP-AS_v0.6/HTML/users.php MOTP-AS_v0.7/HTML/users.php
--- MOTP-AS_v0.6/HTML/users.php	2010-11-23 23:05:35.000000000 +0100
+++ MOTP-AS_v0.7/HTML/users.php	2011-07-10 10:31:44.000000000 +0200
@@ -2,22 +2,19 @@
 
 include 'INC/session.php'; checkrole("AH","index.php");
 
-include 'INC/config.php';
-include 'INC/types.php';
-include 'INC/misc.php';
-include 'INC/db_func.php';
+include 'INC/include.php';
 
 $title = "MOTP-AS - Users";
 include 'INC/header.php';
 
-if (isset($_GET['user']))   { $user_filter = input($_GET['user']);   } else { $user_filter=""; }
-if (isset($_GET['name']))   { $name_filter = input($_GET['name']);   } else { $name_filter=""; }
-if (isset($_GET['role']))   { $role_filter = input($_GET['role']);   } else { $role_filter=""; }
-if (isset($_GET['status'])) { $stat_filter = input($_GET['status']); } else { $stat_filter=""; }
+if (isset($_POST['user']))   { $user_filter = input($_POST['user']);   } else { $user_filter=""; }
+if (isset($_POST['name']))   { $name_filter = input($_POST['name']);   } else { $name_filter=""; }
+if (isset($_POST['role']))   { $role_filter = input($_POST['role']);   } else { $role_filter=""; }
+if (isset($_POST['status'])) { $stat_filter = input($_POST['status']); } else { $stat_filter=""; }
 
 $bcs = array ( array("index.php","home"), array("users.php","Users") );
 
-echo form_header("get","users.php");
+echo form_header("POST","users.php");
 echo table_header ( array("User", "Name", "Role", "Status", "Last Login"), "list" );
 
 $select = select_header("role","width:35px;");
@@ -36,7 +33,7 @@
 		. select_option(0,"locked","$stat_filter"=="0") 
 		. select_footer() ,
 	' ' ,
-	input_submit("","Search")
+	input_submit("Search","search")
 	) );
 
 $users = get_user_list ($user_filter, $name_filter, $role_filter, $stat_filter);
@@ -46,7 +43,7 @@
 		a("user.php?user=$user->id", $user->user) ,
 		a("user.php?user=$user->id", $user->name) , 
 		"$user->role" ,
-		( (! $user->enabled) ? "locked" : ( ($user->tries > $MAXTRIES) ? "locked" : ("$user->tries"."/"."$MAXTRIES") ) ),
+		( (! $user->enabled) ? "locked" : ( ($user->tries > MAXTRIES) ? "locked" : ("$user->tries"."/".MAXTRIES) ) ),
 		( ($user->llogin) ? date("d.m.Y H:i:s",$user->llogin) : "never logged in" )
 	) );
 }
@@ -55,9 +52,9 @@
 echo form_footer();
 
 
-echo form_header("get","user.php");
+echo form_header("POST","user.php");
 echo input_hidden("action","add");
-echo input_submit("","Add new User");
+echo input_submit("Add new User","add");
 echo form_footer();
 
 
diff -Nur MOTP-AS_v0.6/HTML/wiz_firsttime.php MOTP-AS_v0.7/HTML/wiz_firsttime.php
--- MOTP-AS_v0.6/HTML/wiz_firsttime.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/wiz_firsttime.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,23 @@
+<?php
+
+include 'INC/session.php'; checkrole("A","index.php");
+
+include 'INC/include.php';
+
+
+$title = "MOTP-AS - Wizard - One Step Add";
+include 'INC/header.php';
+
+$bcs = array ( array("index.php","home"), array("wiz_firsttime.php","First Time Configuration") );
+
+echo li("ol", array(
+	'<a href="static.php?user=1" target="_blank">Change Password of User "admin"</a>',
+	'<a href="radclients.php" target="_blank">Add RADIUS clients</a>',
+	'<a href="wiz_quickadd.php" target="_blank">Add users</a>',
+	'Test your configuration; see <a href="http://motp-as.network-cube.de/index.php/faq/installation-faq" target="_blank">FAQs</a>.'
+) );
+
+
+include 'INC/footer.php';
+
+?>
diff -Nur MOTP-AS_v0.6/HTML/wiz_import.php MOTP-AS_v0.7/HTML/wiz_import.php
--- MOTP-AS_v0.6/HTML/wiz_import.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/wiz_import.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,209 @@
+<?php
+
+include 'INC/session.php'; checkrole("AH","index.php");
+
+include 'INC/include.php';
+
+
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
+
+
+$title = "MOTP-AS - Wizard - Import";
+include 'INC/header.php';
+
+$bcs = array ( array("index.php","home"), array("wiz_import.php","Import") );
+
+
+function process_csv ($csv) {
+	global $ROLES;
+
+	if (!is_array($csv)) return;
+	if (count($csv) != 10) return;
+	$warning = FALSE;
+// print_r($csv);
+
+	$user = new User();
+	$user->user = $csv[0];
+	$user->name = $csv[1];
+	$user->role = $csv[2];
+	if (!array_key_exists($user->role,$ROLES)) $user->role='U'; 
+// print_r($user);
+	if ($user->user != "") {
+		$user=insert_user ($user);
+		if ($user) {
+			log_audit($_SESSION['user'],"user add","User: $user->user ($user->name)");
+		} else {
+			if ($warning) $warning .= br();
+			$warning .= "Error importing User: " . error_msg();
+			$user = new User();
+		}
+	} else {
+		if ($warning) $warning .= br();
+		$warning .= "No User data";
+	}
+
+	$device = new Device();
+	$device->name = $csv[3];
+	$device->secret = $csv[4];
+	$device->secret = strtolower($device->secret);
+	$device->timezone = $csv[5];
+// print_r($device);
+	if ($device->secret != "") {
+		$device=insert_device ($device);
+		if ($device) {
+			log_audit($_SESSION['user'],"device add","Device: $device->id ($device->name)");
+		} else {
+			if ($warning) $warning .= br();
+			$warning .= "Error importing Device: " . error_msg();
+			$device = new Device();
+		}
+	} else {
+		if ($warning) $warning .= br();
+		$warning .= "No Device data";
+	}
+
+	$account = new Account();
+	$account->pin = $csv[6];
+	$account->userid = $user->id;
+	$account->deviceid = $device->id;
+// print_r($account);
+	if ( ($account->pin != "") && ($account->userid != "") && ($account->deviceid != "") ) {
+		$account=insert_account ($account);
+		if ($account) {
+			log_audit($_SESSION['user'],"account add","Account: $account->id ($account->userid, $account->deviceid)");
+		} else {
+			if ($warning) $warning .= br();
+			$warning .= "Error importing Account: " . error_msg();
+			$account = new Account();
+		}
+	} else {
+		if ($warning) $warning .= br();
+		if ($account->pin == "")        $warning .= "No Account data";
+		elseif ($account->userid == "") $warning .= "No Account added: Which user?";
+		else                            $warning .= "No Account added: Which Device?";
+	}
+
+	$static = new StaticPW();
+	$static->hash = $csv[7];
+	$static->howoften = $csv[8];
+	if ($static->howoften == "") $static->howoften=-1;
+	$static->until = $csv[9];
+	$static->userid=$user->id;
+	$static->salt=substr(md5(rand()),0,2);
+	$static->hash=md5($static->salt . $static->hash);
+// print_r($static);
+	if ( ($csv[7] != "") && ($static->userid != "") ) {
+		if (set_static ($static) !== FALSE) {
+			log_audit($_SESSION['user'],"static password set","User: $user->user ($user->name); Until: $static->until; Howoften: $static->howoften");
+		} else {
+			if ($warning) $warning .= br();
+			$warning .= "Error setting Static Password";
+		}
+	} elseif ($csv[7] != "") {
+		if ($warning) $warning .= br();
+		$warning .= "No Static Password added: Which user?";
+	}
+
+	if ($warning) {
+		$status = "<font color=\"orange\">" . $warning . "</font>";
+	} else {
+		$status = "<font color=\"green\">ok</font>";
+	}
+		
+	return table_row ( array(
+		($user->id       == "") ? "$csv[0]" : a("user.php?user=$user->id",user_name($user)),
+			$user->role, "", 
+		($device->id     == "") ? "$csv[3]" : a("device.php?device=$device->id",device_name($device)),
+			$device->secret, $device->timezone, "", 
+		($account->id    == "") ? "$csv[6]" : a("account.php?account=$account->id",$account->pin), 
+			"", 
+		($static->userid == "") ? "$csv[7]" : a("static.php?user=$static->userid",$csv[7]),
+			$static->howoften, $static->until, "",
+		$status
+	) );
+}
+
+
+if ( ($action == "upload") || ($action == "import") ) {
+
+	$header = table_header(FALSE,"show");
+	$header .= table_header ( array(
+		"User", "Role", "", 
+		"Device", "Secret", "Timezone", "", 
+		"PIN", "", 
+		"Static Password", "how often", "until", "",
+		"Status"
+	) );
+
+	if ($action == "upload") {
+		if (!array_key_exists('csv',$_FILES)) stop("warning","no file uploaded.");
+		if ($_FILES['csv']['name']=="") stop("warning","no file uploaded.");
+		if ($_FILES['csv']['error']!=0) stop("error","Internal error.");
+		$file = $_FILES['csv']['tmp_name']; 
+		if (($fp = fopen($file, "r")) === FALSE) stop("error","Internal error.");
+		echo $header;
+		while (($dataset = fgetcsv($fp)) !== FALSE) {
+			echo process_csv($dataset);
+		}
+		fclose($fp);
+		// remove file???
+	} else {
+		if (isset($_POST['csv'])) $csv=input($_POST['csv']); else $csv="";
+		if ($csv == "") stop("warning","empty file");
+		$csv = strtr($csv, array('\r\n' => '\n', '\r' => '\n'));
+		$csv = explode ('\n', $csv);
+		echo $header;
+		foreach ($csv as $line) {
+			$dataset = str_getcsv($line);
+			echo process_csv($dataset);
+		}
+	}
+
+	echo table_footer();
+		
+} else {
+	$example_line = "john,Test User,,Nokia Phone,1234567812345678,,1234,initpassword,1,";
+
+	echo p(
+		form_header("POST\" enctype=\"multipart/form-data", "wiz_import.php")
+		. input_hidden("action","upload")
+		. "Upload as file ..."
+		. input_hidden("MAX_FILE_SIZE", convertBytes(ini_get('upload_max_filesize')))
+		. input_file("csv")
+		. input_submit("Upload")
+		. br()
+		. "Use " . a("import.csv","import.csv") . " as template"
+		. form_footer()
+	);
+
+	if (function_exists('str_getcsv'))	// PHP version >= 5.3.0
+	    echo p(
+		"<hr />"
+		. form_header("POST", "wiz_import.php")
+		. input_hidden("action","import")
+		. "... or paste into text area and "
+		. input_submit("Import")
+		. br()
+		. input_area("csv", $example_line, "70", "20")
+		. form_footer()
+	);
+
+	$help = p("For both upload and text area, please use comma seperated lines with following values; you may leave empty for default values.") 
+		. li( "ul", array(
+			array("user (Loginname)"," - leave empty, if you only want to import devices"),
+			array("Name of User",""),
+			array("User's Role"," - 'U' or '' for users, 'H' for helpdesk users and 'A' for admins"), 
+			array("Device name",""),
+			array("Secret"," - leave empty, if you only want to import users"),
+			array("Timezone"," - leave empty for no timezone adjustment"),
+			array("PIN"," - leave empty, if you do not want to create an account"),
+			array("Static Password"," - leave empty for no static password"),
+			array("Count"," how often static password can be used (can be empty)"),
+			array("Expiration date"," for static password (can be empty)")
+		) );
+}
+
+
+include 'INC/footer.php';
+
+?>
diff -Nur MOTP-AS_v0.6/HTML/wiz_quickadd.php MOTP-AS_v0.7/HTML/wiz_quickadd.php
--- MOTP-AS_v0.6/HTML/wiz_quickadd.php	1970-01-01 01:00:00.000000000 +0100
+++ MOTP-AS_v0.7/HTML/wiz_quickadd.php	2011-07-10 10:31:44.000000000 +0200
@@ -0,0 +1,73 @@
+<?php
+
+include 'INC/session.php'; checkrole("AH","index.php");
+
+include 'INC/include.php';
+
+
+if (isset($_POST['action'])) $action=input($_POST['action']); else $action="";
+
+
+$title = "MOTP-AS - Wizard - Quick Add";
+include 'INC/header.php';
+
+$bcs = array ( array("index.php","home"), array("wiz_quickadd.php","Quick Add") );
+
+
+
+if ($action == "insert") {
+	echo table_header(FALSE,"show");
+
+	$user = new User();
+	if (isset($_POST['user'])) $user->user = input($_POST['user']);
+	$user->role='U';
+	$user->name=$user->user;
+	$user=insert_user ($user);
+	if (! $user) stop("error", "Could not add user: " . error_msg() );
+	log_audit($_SESSION['user'],"user add","User: $user->user ($user->name)");
+	echo table_row( array ("User:", a("user.php?user=$user->id", $user->user) ) );
+
+	$device = new Device();
+	if (isset($_POST['secret'])) $device->secret = input($_POST['secret']);
+	$device->secret = strtolower($device->secret);
+	$device->name = input($user->user . "'s Device");
+	$device=insert_device ($device);
+	if (! $device) stop("error", "Could not add device:" . error_msg() );
+	log_audit($_SESSION['user'],"device add","Device: $device->id ($device->name)");
+	echo table_row( array ("Device:", a("device.php?device=$device->id", $device->name) ) );
+
+	$account = new Account();
+	if (isset($_POST['pin'])) $account->pin = input($_POST['pin']);
+	$account->userid = $user->id;
+	$account->deviceid = $device->id;
+	$account=insert_account ($account);
+	if (! $account) stop("error", "Could not add account.");
+	log_audit($_SESSION['user'],"account add","Account: $account->id ($account->userid, $account->deviceid)");
+	echo table_row( array ("Account:", a("account.php?account=$account->id", $user->user ."/". $device->name) ) );
+
+	echo table_footer();
+} else {
+
+	echo form_header("POST", "wiz_quickadd.php");
+	echo input_hidden("action","insert");
+	echo table_header(FALSE,"edit");
+	echo table_row( array( "User",    input_text("user", "") ) ) . br() ;
+	echo table_row( array ("Secret:", input_text("secret", "", 20, 'id="device-secret"' ) ));
+	echo table_row( array( "PIN:",    input_text("pin", "", 4, 'id="account-pin"') ) );
+	echo table_footer();	
+	echo input_submit("Ok","send");
+	echo form_footer();
+
+	$help   = p("user = login name (used for authentication)")
+		. p("secret = secret generated at initialization of token.")
+		. p("PIN = PIN used by user for this secret.")
+		;
+	$hint = TRUE;
+
+
+}
+
+
+include 'INC/footer.php';
+
+?>
